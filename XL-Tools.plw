#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name   : XL-Tools
# Website     : http://le-tools.com/
# GitHub		  : https://github.com/arioux/XL-Tools
# Description : Part of the XL-Toolkit, XL-Tools provides a bunch of functions
#               for list of strings like sorting, converting, replacing, date
#               and time utilities, etc.
# Creation    : 2015-12-21
# Modified    : 2016-06-18
my $VERSION   = "1.2";
# Author      : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2015-2016  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#

#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use warnings;
use String::HexConvert qw(hex_to_ascii ascii_to_hex);
use URI::Escape;
use URI::Escape::JavaScript qw(unescape);
use HTML::Entities;
use MIME::Base64 ();
use Convert::Base32;
use DateTime;
use DateTime::TimeZone;
use Date::Calc qw (N_Delta_YMDHMS Add_N_Delta_YMDHMS);
use HTTP::Date qw(parse_date str2time);
use Net::DNS;
use base qw/Net::DNS::Resolver::Base/;
use Net::CIDR 'cidr2range';
use Net::IPv6Addr;
use NetAddr::IP;
use Regexp::IPv6 qw($IPv6_re);
use Win32::API();
use Win32::GUI();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::GUI::Grid;
use Win32::Process;
use LWP::UserAgent;
use DBI;
use Geo::IP;
use IO::Uncompress::Gunzip qw(gunzip $GunzipError);
use File::Copy;
use Woothee;
use Parse::HTTP::UserAgent;
use Parse::HTTP::UserAgent::Base::IS;
use Parse::HTTP::UserAgent::Base::Parsers;
use Parse::HTTP::UserAgent::Base::Dumper;
use Parse::HTTP::UserAgent::Base::Accessors;
use HTTP::BrowserDetect;
use HTML::ParseBrowser;
use Business::CreditCard;
use REST::Client;
use threads;
use threads::shared;
require "XL-ToolsGraph.pl";
require "XL-ToolsLang.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#

my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $LANG_FILE    = "$PROGDIR\\Lang.ini";                                       # Langage file
my $CONFIG_FILE  = "$PROGDIR\\XL-Tools.ini";                                   # Configuration file
my $HELP_FILE    = "$PROGDIR\\Documentation.chm";                              # Help file
my $URL_TOOL     = 'http://www.le-tools.com/download/XL-Tools.zip';            # Url of the tool
my $URL_VER      = 'http://www.le-tools.com/download/XL-ToolsVer.txt';         # Url of the version file
my $MACOUIDB_URL = 'http://standards-oui.ieee.org/oui.txt';                    # URL of the MAC OUI DB
my $GEOIPDB_URL  = 'http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz'; # URL of the GeoIP DB
my %CONFIG       :shared;                                                      # Configuration
my %STR;                                                                       # Strings for GUI
my $ARROW        :shared;                                                      # Arrow pointer
my $HOURGLASS    :shared;                                                      # Hourglass pointer
my $THR_PROCESS;                                                               # Thread for process
my $THR_UPDATE;                                                                # Thread for update
my $LISTNO        = 0;                                                         # For CTRL+A
my $START         = 0;                                                         # Indicate when program is started
my $LIST2_VISIBLE = 0;                                                         # Current state of List 2 (visible or not)
my $SPLIT1_CURR_POS;                                                           # Current pos of split 1, change when splitter is moved
my $SPLIT2_CURR_POS;                                                           # Current pos of split 2, change when splitter is moved
my $TOTAL_SIZE   :shared = 0;                                                  # Total size for download

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#

my ($winICO, $logoBmp, $logo128Bmp, $fileOpenBmp, $deleteBmp, $viewReportBmp, $downloadBmp,
    $processBmp, $stopBmp, $config32Bmp, $helpBmp, $aboutBmp, $config128Bmp, $fileNewBmp,
    $database16, $import16Bmp, $addCFBmp, $remCFBmp, $editCFBmp, $newCFBmp, $saveCFBmp,
    $cancelCFBmp, $checkBmp, $errorBmp) = &loadGraph();

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#

&loadDefaultStr(\%STR); # Load default language (en)
if (-e $LANG_FILE and -T $LANG_FILE) { &loadStr(\%STR, $LANG_FILE); } # If language file, load translated strings

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#

my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 908;
my $winHeight = 600;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;

# Keyboard shorcut
my $accel = new Win32::GUI::AcceleratorTable("Ctrl-A" => "selectAll");

# Main Window
my $win = Win32::GUI::Window->new( -name        => 'winMain'                           ,
                                   -text        => 'XL-Tools'                          ,
                                   -background  => [255, 255, 255]                     ,
                                   -size        => [$winWidth, $winHeight]             ,
                                   -pos         => [$winPosX , $winPosY]               ,
                                   -minheight   => $winHeight                          ,
                                   -minwidth    => $winWidth-100                       ,
                                   -accel       => $accel                              , );
$win->SetIcon($winICO);

# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $fontGB2;
my $fontGB3;
my $font10;
my $font10b;
my $font10u;
my $font12;
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      , );
  $fontGB2 = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $fontGB3 = new Win32::GUI::Font(-name      => 'Open Sans',
                                  -size      => 12     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font10  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 8      , );
  $font10b = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 8      ,
                                  -bold      => 1      , );
  $font10u = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 8      ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font12  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 9      , );
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 12     ,
                                  -bold      => 1      , );
  $fontGB2 = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 12     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $fontGB3 = new Win32::GUI::Font(-name      => 'Open Sans',
                                  -size      => 14     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font10  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     , );
  $font10b = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      , );
  $font10u = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 10     ,
                                  -bold      => 1      ,
                                  -underline => 1      , );
  $font12  = new Win32::GUI::Font(-name      => 'Arial',
                                  -size      => 11     , );  
}

# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);

# Header
$win->AddLabel(       -name        => 'lblLogo'               ,
                      -size        => [310,100]               ,
                      -pos         => [  0,  0]               ,
                      -bitmap      => $logoBmp                ,
                      -background  => [255, 255, 255]         , );

$win->AddTabStrip(      -name         => 'Tab'                 ,
                        -size         => [$winWidth-325,100]   ,
                        -pos          => [310,  0]             ,
                        -fixedwidth   => 1                     ,
                        -tabstop      => 1                     ,
                        -background   => [255, 255, 255]       , );
$win->Tab->InsertItem(  -text         => $STR{'Tab1'}          , );
$win->Tab->InsertItem(  -text         => $STR{'Tab2'}          , );
$win->Tab->InsertItem(  -text         => $STR{'Tab3'}          , );
$win->Tab->InsertItem(  -text         => $STR{'Tab4'}          , );
$win->Tab->InsertItem(  -text         => $STR{'Tab5'}          , );
$win->Tab->SetItemSize(116,20);

# Lists tab
$win->AddCombobox(    -name        => 'cbLists'              ,
                      -size        => [220,100]              ,
                      -pos         => [315, 30]              ,
                      -font        => $font10                ,
                      -dropdown    => 1                      ,
                      -vscroll     => 1                      , );
$win->cbLists->Add(   $STR{'cbLists1'}  , $STR{'cbLists2'}   ,
                      $STR{'cbLists3'}  , $STR{'cbLists4'}   ,
                      $STR{'cbLists5'}  , $STR{'cbLists6'}   ,
                      $STR{'cbLists7'}  , $STR{'cbLists8'}   ,
                      $STR{'cbLists9'}  , $STR{'cbLists10'}  ,
                      $STR{'cbLists11'} , $STR{'cbLists12'}  ,
                      $STR{'cbLists13'} , $STR{'cbLists14'}  ,
                      $STR{'cbLists15'} , $STR{'cbLists16'}  ,
                      $STR{'cbLists17'} ,                      );
$win->AddCheckbox(    -name        => 'chMatchCase'          ,
                      -size        => [ 90, 20]              ,
                      -pos         => [560, 32]              ,
                      -text        => $STR{'MatchCase'}      ,
                      -font        => $font10                ,
                      -background  => [255, 255, 255]        ,
                      -checked     => 1                      , );
$win->AddCheckbox(    -name        => 'chRegex'              ,
                      -size        => [ 80, 20]              ,
                      -pos         => [670, 32]              ,
                      -text        => $STR{'Regex'}          ,
                      -font        => $font10                ,
                      -background  => [255, 255, 255]        ,
                      -checked     => 0                      , );
$win->AddCheckbox(    -name        => 'chEval'               ,
                      -size        => [ 80, 20]              ,
                      -pos         => [760, 32]              ,
                      -text        => $STR{'Eval'}           ,
                      -font        => $font10                ,
                      -background  => [255, 255, 255]        ,
                      -checked     => 0                      ,
                      -disabled    => 1                      , );
$win->AddLabel(       -name        => 'lblWith'              ,
                      -size        => [ 40, 22]              ,
                      -pos         => [315, 67]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'With'}.':'       ,
                      -font        => $font10                , );
$win->AddTextfield(   -name        => 'tfWith'               ,
                      -size        => [ 95, 22]              ,
                      -pos         => [360, 65]              , );
$win->AddLabel(       -name        => 'lblColumnsNo'         ,
                      -size        => [ 60, 22]              ,
                      -pos         => [475, 67]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'Columns'}.':'    ,
                      -font        => $font10                , );
$win->AddTextfield(   -name        => 'tfColumnsNo'          ,
                      -size        => [ 95, 22]              ,
                      -pos         => [540, 65]              , );
$win->AddLabel(       -name        => 'lblReplace'           ,
                      -size        => [ 80, 22]              ,
                      -pos         => [315, 67]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'Replace'}.':'    ,
                      -font        => $font10                , );
$win->AddLabel(       -name        => 'lblReplaceREOk'       ,
                      -size        => [ 87, 24]              ,
                      -pos         => [399, 64]              ,
                      -background  => [  0, 255,   0]        ,
                      -visible     => 0                      , );
$win->AddLabel(       -name        => 'lblReplaceREErr'      ,
                      -size        => [ 87, 24]              ,
                      -pos         => [399, 64]              ,
                      -background  => [255,   0,   0]        ,
                      -visible     => 0                      , );
$win->AddLabel(       -name        => 'lblReplaceREWarn'     ,
                      -size        => [ 87, 24]              ,
                      -pos         => [399, 64]              ,
                      -background  => [255, 255,   0]        ,
                      -visible     => 0                      , );
$win->AddTextfield(   -name        => 'tfReplace'            ,
                      -size        => [ 85, 22]              ,
                      -pos         => [400, 65]              , );
$win->AddLabel(       -name        => 'lblReplBy'            ,
                      -size        => [ 30, 22]              ,
                      -pos         => [660, 67]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'By'}.':'         ,
                      -font        => $font10                , );
$win->AddLabel(       -name        => 'lblReplaceByREOk'     ,
                      -size        => [ 87, 24]              ,
                      -pos         => [694, 64]              ,
                      -background  => [  0, 255,   0]        ,
                      -visible     => 0                      , );
$win->AddLabel(       -name        => 'lblReplaceByREErr'    ,
                      -size        => [ 87, 24]              ,
                      -pos         => [694, 64]              ,
                      -background  => [255,   0,   0]        ,
                      -visible     => 0                      , );
$win->AddLabel(       -name        => 'lblReplaceByREWarn'   ,
                      -size        => [ 87, 24]              ,
                      -pos         => [694, 64]              ,
                      -background  => [255, 255,   0]        ,
                      -visible     => 0                      , );
$win->AddTextfield(   -name        => 'tfReplBy'             ,
                      -size        => [ 85, 22]              ,
                      -pos         => [695, 65]              ,
                      -disabled    => 1                      , );
$win->AddRadioButton( -name        => 'rbAll'                ,
                      -size        => [140, 22]              ,
                      -pos         => [550, 30]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'all'}            ,
                      -font        => $font10                ,
                      -checked     => 1                      ,
                      -group       => 1                      ,
                      -visible     => 0                      , );
$win->AddRadioButton( -name        => 'rbFirstOnly'          ,
                      -size        => [160, 22]              ,
                      -pos         => [700, 30]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'firstOnly'}      ,
                      -font        => $font10                ,
                      -visible     => 0                      , );
$win->AddRadioButton( -name        => 'rbFirstEachWord'      ,
                      -size        => [200, 22]              ,
                      -pos         => [550, 60]              ,
                      -background  => [255, 255, 255]        ,
                      -text        => $STR{'firstEachWord'}  ,
                      -font        => $font10                ,
                      -visible     => 0                      , );

# Sort tab
$win->AddCombobox(    -name        => 'cbSorts'               ,
                      -size        => [220,100]               ,
                      -pos         => [315, 30]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbSorts->Add(   $STR{'cbSorts1'} , $STR{'cbSorts2'}     ,
                      $STR{'cbSorts3'} , $STR{'cbSorts4'}     ,
                      $STR{'cbSorts5'}                        , );
$win->AddRadioButton( -name       => 'rbAsc'                  ,
                      -size       => [100, 22]                ,
                      -pos        => [560, 30]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'Ascending'}        ,
                      -font       => $font10                  ,
                      -checked    => 1                        ,
                      -group      => 1                        ,
                      -visible    => 0                        , );
$win->AddRadioButton( -name       => 'rbDsc'                  ,
                      -size       => [120, 22]                ,
                      -pos        => [660, 30]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'Descending'}       ,
                      -font       => $font10                  ,
                      -visible    => 0                        , );
$win->AddLabel(       -name       => 'lblDTFormat'            ,
                      -size       => [ 90, 22]                ,
                      -pos        => [315, 68]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'InputFormat'}.':'  ,
                      -font       => $font10                  ,
                      -visible    => 0                        , );
$win->AddCombobox(    -name        => 'cbDTFormat'            ,
                      -size        => [245,100]               ,
                      -pos         => [410, 65]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbDTFormat->Add('Guess (or variable)...',
                      'Tuesday, 08-Feb-2015 14:15:29 GMT',
                      'Thu Feb  3 17:03:55 GMT 2015',
                      'Tuesday, 08-Feb-99 14:15:29 GMT',
                      'Wed, 09 Feb 2015 22:23:32 GMT',
                      '03/Feb/2015:17:03:55 -0700',
                      '2015-02-03 14:15:29 -0100',
                      '08-Feb-2015 14:15:29 GMT',
                      '09 Feb 2015 22:23:32 GMT',
                      '08-Feb-99 14:15:29 GMT',
                      'Thu Feb  3 00:00:00 2015',
                      '2015-02-03 14:15:29',
                      '03/02/2015 14:15:29',
                      '2015-02-03T14:15:29',
                      '11-15-99  03:52PM',
                      'Feb  3 17:03',
                      'Feb  3  2015',
                      '08-Feb-2015',
                      '03/Feb/2015',
                      '2015-02-03',
                      '20150203T141529Z',
                      '08-Feb-99',
                      '09 Feb 2015',
                      '20150203', );
$win->AddButton(      -name        => 'btnGuess'              ,
                      -size        => [ 60, 24]               ,
                      -pos         => [660, 65]               ,
                      -text        => $STR{'btnGuess'}        ,
                      -font        => $font10                 ,
                      -tip         => $STR{'btnGuessTip'}     ,
                      -disabled    => 0                       ,
                      -visible     => 0                       , );

# Conversion tab
$win->AddCombobox(    -name        => 'cbConv'                ,
                      -size        => [220,100]               ,
                      -pos         => [315, 30]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbConv->Add(    $STR{'cbConv1'}  , $STR{'cbConv2'}      ,
                      $STR{'cbConv3'}  , $STR{'cbConv4'}      ,
                      $STR{'cbConv5'}  , $STR{'cbConv6'}      ,
                      $STR{'cbConv7'}  , $STR{'cbConv8'}      ,
                      $STR{'cbConv9'}  , $STR{'cbConv10'}     ,
                      $STR{'cbConv11'}                        , );
# Time tab
$win->AddCombobox(    -name        => 'cbTime'                ,
                      -size        => [220,100]               ,
                      -pos         => [315, 30]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbTime->Add(    $STR{'cbTime1'}  , $STR{'cbTime2'}      ,
                      $STR{'cbTime3'}  , $STR{'cbTime4'}      ,
                      $STR{'cbTime5'}  , $STR{'cbTime6'}      ,
                      $STR{'cbTime7'}  , $STR{'cbTime8'}      ,
                      $STR{'cbTime9'}                         , );
# Output format controls
$win->AddRadioButton( -name       => 'rbLocaltime'            ,
                      -size       => [ 60, 22]                ,
                      -pos        => [550, 30]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'Local'}            ,
                      -font       => $font10                  ,
                      -checked    => 1                        ,
                      -group      => 1                        ,
                      -visible    => 0                        , );
$win->AddRadioButton( -name       => 'rbGMTime'               ,
                      -size       => [ 60, 22]                ,
                      -pos        => [620, 30]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'GMT'}              ,
                      -font       => $font10                  ,
                      -visible    => 0                        , );
$win->AddRadioButton( -name       => 'rbOtherTZ'              ,
                      -size       => [ 60, 22]                ,
                      -pos        => [690, 30]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'Other'}.':'        ,
                      -font       => $font10                  ,
                      -visible    => 0                        , );
$win->AddCombobox(    -name       => 'cbOtherTZ'              ,
                      -size       => [ 70, 22]                ,
                      -pos        => [760, 30]                ,
                      -font       => $font10                  ,
                      -dropdown   => 1                        ,
                      -vscroll    => 1                        ,
                      -disabled   => 1                        ,
                      -visible    => 0                        , );
$win->cbOtherTZ->Add( '+1200','+1130','+1100','+1030','+1000','+0900','+0930','+0800','+0700',
                      '+0630','+0600','+0530','+0500','+0430','+0400','+0330','+0300','+0200',
                      '+0100','+0000','-0100','-0200','-0300','-0330','-0400','-0500','-0600',
                      '-0700','-0800','-0830','-0900','-0930','-1000','-1100','-1200', );
# Time difference controls
$win->AddCheckbox(    -name       => 'chSingleDate'           ,
                      -size       => [130, 22]                ,
                      -pos        => [550, 30]                ,
                      -text       => $STR{'SingleDate'}.':'   ,
                      -font       => $font10                  ,
                      -background => [255, 255, 255]          ,
                      -checked    => 0                        ,
                      -visible    => 0                        , );
$win->AddDateTime(    -name       => 'dtTimeDiffDate'         ,
                      -size       => [ 90, 22]                ,
                      -pos        => [690, 30]                ,
                      -font       => $font10                  ,
                      -background => [255, 255, 255]          ,
                      -format     => 'shortdate'              ,
                      -visible    => 0                        , );
$win->AddDateTime(    -name       => 'dtTimeDiffTime'         ,
                      -size       => [ 80, 22]                ,
                      -pos        => [790, 30]                ,
                      -font       => $font10                  ,
                      -background => [255, 255, 255]          ,
                      -format     => 'time'                   ,
                      -visible    => 0                        , );
# Add time controls
$win->AddLabel(       -name       => 'lblAddDT'               ,
                      -size       => [ 30, 22]                ,
                      -pos        => [725, 68]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'Dur'}.':'          ,
                      -font       => $font10                  ,
                      -visible    => 0                        , );
$win->AddTextfield(   -name       => 'tfValAddDT'             ,
                      -size       => [ 40, 24]                ,
                      -pos        => [760, 65]                ,
                      -number     => 1                        ,
                      -align      => 'right'                  ,
                      -visible    => 0                        , );
$win->AddCombobox(    -name       => 'cbTypeValAddDT'         ,
                      -size       => [ 80, 22]                ,
                      -pos        => [805, 65]                ,
                      -font       => $font10                  ,
                      -dropdown   => 1                        ,
                      -vscroll    => 1                        ,
                      -visible    => 0                        , );
$win->cbTypeValAddDT->Add( ucfirst($STR{'years'})  , ucfirst($STR{'months'})  ,
                           ucfirst($STR{'days'})   , ucfirst($STR{'hours'})   ,
                           ucfirst($STR{'minutes'}), ucfirst($STR{'seconds'}) , );
$win->cbTypeValAddDT->SetCurSel(0);

# Utils tab
$win->AddCombobox(    -name        => 'cbUtils'               ,
                      -size        => [220,100]               ,
                      -pos         => [315, 30]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbUtils->Add(   $STR{'cbUtils1'}  , $STR{'cbUtils2'}    ,
                      $STR{'cbUtils3'}  , $STR{'cbUtils4'}    ,
                      $STR{'cbUtils5'}  , $STR{'cbUtils6'}    ,
                      $STR{'cbUtils7'}  , $STR{'cbUtils8'}    ,
                      $STR{'cbUtils9'}  , $STR{'cbUtils10'}   ,
                      $STR{'cbUtils11'} , $STR{'cbUtils12'}   , );
# GeoIP Options
$win->AddCombobox(    -name        => 'cbGeoIPOpt'            ,
                      -size        => [150,100]               ,
                      -pos         => [545, 30]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbGeoIPOpt->Add($STR{'GeoIPOpt1'}  , $STR{'GeoIPOpt2'}  ,
                      $STR{'GeoIPOpt3'}  , $STR{'GeoIPOpt4'}  ,
                      $STR{'GeoIPOpt5'}  , $STR{'GeoIPOpt6'}  ,
                      $STR{'GeoIPOpt7'}  , $STR{'GeoIPOpt8'}  ,
                      $STR{'GeoIPOpt9'}  , $STR{'GeoIPOpt10'} , );
$win->cbGeoIPOpt->SetCurSel(0);
$win->AddCheckbox(    -name       => 'chGeoIPAddHeaders'      ,
                      -size       => [130, 22]                ,
                      -pos        => [705, 30]                ,
                      -text       => $STR{'Addheaders'}       ,
                      -font       => $font10                  ,
                      -background => [255, 255, 255]          ,
                      -checked    => 0                        ,
                      -visible    => 0                        , );
# User-Agent Options
$win->AddCombobox(    -name        => 'cbUAOpt'               ,
                      -size        => [100,100]               ,
                      -pos         => [545, 30]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbUAOpt->Add(   $STR{'UAOpt1'}  , $STR{'UAOpt2'}        ,
                      $STR{'UAOpt3'}  , $STR{'UAOpt4'}        ,
                      $STR{'UAOpt5'}  , $STR{'UAOpt6'}        , );
$win->cbUAOpt->SetCurSel(0);
$win->AddCheckbox(    -name       => 'chUAAddHeaders'         ,
                      -size       => [130, 22]                ,
                      -pos        => [655, 30]                ,
                      -text       => $STR{'Addheaders'}       ,
                      -font       => $font10                  ,
                      -background => [255, 255, 255]          ,
                      -checked    => 0                        ,
                      -visible    => 0                        , );
# Credit Card to Issuing Company Options
$win->AddRadioButton( -name       => 'rbIINLocalDB'           ,
                      -size       => [200, 22]                ,
                      -pos        => [545, 30]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'IINLocalDB'}       ,
                      -tip        => $STR{'IINLocalDBTip'}    ,
                      -font       => $font10                  ,
                      -checked    => 1                        ,
                      -group      => 1                        ,
                      -visible    => 0                        , );
$win->AddRadioButton( -name       => 'rbBinlist'              ,
                      -size       => [200, 22]                ,
                      -pos        => [545, 60]                ,
                      -background => [255, 255, 255]          ,
                      -text       => $STR{'use'}.' binlist.net',
                      -tip        => $STR{'BinlistTip'}       ,
                      -font       => $font10                  ,
                      -visible    => 0                        , );
# Customs Functions Options
$win->AddCombobox(    -name        => 'cbCFLists'             ,
                      -size        => [200,100]               ,
                      -pos         => [540, 30]               ,
                      -font        => $font10                 ,
                      -dropdown    => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbCFLists->Add( $STR{'cbCFLists'}.'...'                 , );
$win->cbCFLists->SetCurSel(0);
$win->AddButton(      -name        => 'btnCFAdd'              ,
                      -size        => [ 24, 24]               ,
                      -pos         => [750, 30]               ,
                      -bitmap      => $addCFBmp               ,
                      -tip         => $STR{'btnCFAdd'}        ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnCFRem'              ,
                      -size        => [ 24, 24]               ,
                      -pos         => [776, 30]               ,
                      -bitmap      => $remCFBmp               ,
                      -tip         => $STR{'btnCFRem'}        ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnCFEdit'             ,
                      -size        => [ 24, 24]               ,
                      -pos         => [802, 30]               ,
                      -bitmap      => $editCFBmp              ,
                      -tip         => $STR{'btnCFEdit'}       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnCFNew'              ,
                      -size        => [ 24, 24]               ,
                      -pos         => [828, 30]               ,
                      -bitmap      => $newCFBmp               ,
                      -tip         => $STR{'btnCFNew'}        ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chCFMatchCase'         ,
                      -size        => [ 90, 20]               ,
                      -pos         => [540, 68]               ,
                      -text        => $STR{'MatchCase'}       ,
                      -font        => $font10                 ,
                      -background  => [255, 255, 255]         ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblCFTitle'            ,
                      -size        => [ 40, 22]               ,
                      -pos         => [315, 68]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => $STR{'Title'}.':'       ,
                      -font        => $font10                 ,
                      -visible     => 0                       , );
$win->AddTextfield(   -name        => 'tfCFTitle'             ,
                      -size        => [175, 24]               ,
                      -pos         => [360, 65]               ,
                      -visible     => 0                       , );
$win->tfCFTitle->SetLimitText(24);
$win->AddButton(      -name        => 'btnCFSave'             ,
                      -size        => [ 24, 24]               ,
                      -pos         => [537, 65]               ,
                      -bitmap      => $saveCFBmp              ,
                      -tip         => $STR{'btnCFSave'}       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnCFCancel'           ,
                      -size        => [ 24, 24]               ,
                      -pos         => [563, 65]               ,
                      -bitmap      => $cancelCFBmp            ,
                      -tip         => $STR{'btnCFCancel'}     ,
                      -visible     => 0                       , );

# Lists
$win->AddGroupbox(    -name        => 'gbList1'               ,
                      -title       => 'List 1'                ,
                      -size        => [$winWidth/3.18, $winHeight-200] ,
                      -pos         => [  3,105]               ,
                      -font        => $fontGB                 ,
                      -background  => [255, 255, 255]         , );
$win->AddButton(      -name        => 'btnList1File'          ,
                      -size        => [ 22, 22]               ,
                      -pos         => [  7,125]               ,
                      -bitmap      => $fileOpenBmp            ,
                      -tip         => $STR{'selectFile'}      , );
$win->AddButton(      -name        => 'btnList1Del'           ,
                      -size        => [ 22, 22]               ,
                      -pos         => [ 31,125]               ,
                      -bitmap      => $deleteBmp              ,
                      -tip         => $STR{'ResetContent'}    , );
$win->AddLabel(       -name        => 'lblList1Count'         ,
                      -size        => [ 60, 22]               ,
                      -pos         => [$winWidth/3.18-68, 128],
                      -background  => [255, 255, 255]         ,
                      -foreground  => [204,   0,  51]         ,
                      -text        => '0'                     ,
                      -align       => 'right'                 ,
                      -font        => $font10b                , );
$win->AddTextfield(   -name        => 'tfList1'               ,
                      -size        => [$winWidth/3.18-12, $winHeight-250] ,
                      -pos         => [  7, 150]              ,
                      -background  => [255, 255, 255]         ,
                      -multiline   => 1                       ,
                      -hscroll     => 1                       ,
                      -vscroll     => 1                       , );
$win->AddSplitter(    -name        => 'split1'                ,
                      -vertical    => 1                       ,
                      -size        => [  2, $winHeight-190]   ,
                      -pos         => [$winWidth/3.2+7,100]   ,
                      -min         => 200                     ,
                      -max         => $win->ScaleWidth()/2    ,
                      -onRelease   => \&split1                ,
                      -visible     => 0                       , );
$win->AddGroupbox(    -name        => 'gbList2'               ,
                      -title       => 'List 2'                ,
                      -size        => [$winWidth/3.2, $winHeight-200] ,
                      -pos         => [$winWidth/3.2+11,105]  ,
                      -font        => $fontGB                 ,
                      -background  => [255, 255, 255]         ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnList2File'          ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winWidth/3.2+15,125]  ,
                      -bitmap      => $fileOpenBmp            ,
                      -tip         => $STR{'selectFile'}      ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnList2Del'           ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winWidth/3.2+38,125]  ,
                      -bitmap      => $deleteBmp              ,
                      -tip         => $STR{'ResetContent'}    ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblList2Count'         ,
                      -size        => [ 60, 22]               ,
                      -pos         => [$winWidth/3.2+$winWidth/3.2-62, 128],
                      -background  => [255, 255, 255]         ,
                      -foreground  => [204,   0,  51]         ,
                      -text        => '0'                     ,
                      -align       => 'right'                 ,
                      -font        => $font10b                ,
                      -visible     => 0                       , );
$win->AddTextfield(   -name        => 'tfList2'               ,
                      -size        => [$winWidth/3.2-15, $winHeight-250] ,
                      -pos         => [$winWidth/3.2+15, 150] ,
                      -background  => [255, 255, 255]         ,
                      -multiline   => 1                       ,
                      -hscroll     => 1                       ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->AddSplitter(    -name        => 'split2'                ,
                      -vertical    => 1                       ,
                      -size        => [  2, $winHeight-190]   ,
                      -pos         => [$winWidth/3.2+$winWidth/3.2+12,100],
                      -min         => $winWidth/2             ,
                      -max         => $winWidth-200           ,
                      -onRelease   => \&split2                , );
$win->AddGroupbox(    -name        => 'gbList3'               ,
                      -title       => $STR{'Results'}         ,
                      -size        => [$winWidth/2.98, $winHeight-200] ,
                      -pos         => [$winWidth/3.2+$winWidth/3.2+16,105]  ,
                      -font        => $fontGB                 ,
                      -background  => [255, 255, 255]         , );
$win->AddButton(      -name        => 'btnList3Open'          ,
                      -size        => [ 22, 22]               ,
                      -pos         => [$winWidth/3.2+$winWidth/3.2+17,125]  ,
                      -bitmap      => $viewReportBmp          ,
                      -tip         => $STR{'ViewReport'}      , );
$win->AddLabel(       -name        => 'lblList3Count'         ,
                      -size        => [ 60, 22]               ,
                      -pos         => [$winWidth-87, 128]     ,
                      -background  => [255, 255, 255]         ,
                      -foreground  => [204,   0,  51]         ,
                      -text        => '0'                     ,
                      -align       => 'right'                 ,
                      -font        => $font10b                , );
$win->AddTextfield(   -name        => 'tfList3'               ,
                      -size        => [$winWidth/2.98-5, $winHeight-250] ,
                      -pos         => [$winWidth/3.2+$winWidth/3.2+17, 150] ,
                      -background  => [255, 255, 255]         ,
                      -multiline   => 1                       ,
                      -hscroll     => 1                       ,
                      -vscroll     => 1                       , );

# Footer
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [899, 80]               ,
                      -pos         => [  2,$winHeight-95]     ,
                      -valign      => 'top'                   ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10, $winHeight-75]    ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => $STR{'lblNotReady'}     ,
                      -font        => $font10u                ,
                      -notify      => 1                       , );
$win->AddLabel(       -name        => 'lblPbCurr'             ,
                      -size        => [690, 20]               ,
                      -pos         => [ 10, $winHeight-85]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [204,   0,  51]         ,
                      -visible     => 0                       , );
$win->AddProgressBar( -name        => 'pb'                    ,
                      -size        => [570, 20]               ,
                      -pos         => [ 10, $winHeight-65]    ,
                      -smooth      => 1                       ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblPbCount'            ,
                      -size        => [105, 20]               ,
                      -pos         => [585, $winHeight-63]    ,
                      -font        => $font10                 ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [204,   0,  51]         ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnProcess'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [710,$winHeight-85]     ,
                      -bitmap      => $processBmp             ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Process'}         ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnStop'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [710,$winHeight-85]     ,
                      -bitmap      => $stopBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'StopProcess'}     ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnWinConfig'          ,
                      -size        => [ 40, 40]               ,
                      -pos         => [755,$winHeight-85]     ,
                      -bitmap      => $config32Bmp            ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'Configuration'}   , );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [800,$winHeight-85]     ,
                      -bitmap      => $helpBmp                ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'btnHelpTip'}      , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [845,$winHeight-85]     ,
                      -bitmap      => $aboutBmp               ,
                      -background  => [250, 250, 250]         ,
                      -tip         => $STR{'about'}           , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'             ,
                                            -parent      => $win                    ,
                                            -text        => $STR{'winConfig'}       ,
                                            -pos         => [$winPosX, $winPosY]    ,
                                            -size        => [650, 340]              ,
                                            -background  => [255, 255, 255]         ,
                                            -hasmaximize => 0                       ,
                                            -hasminimize => 0                       ,
                                            -helpbutton  => 0                       ,
                                            -resizable   => 0                       ,
                                            -dialogui    => 1                       , );
$winConfig->SetIcon($winICO);

$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $config128Bmp         ,
                          -background   => [255, 255, 255]       , );

# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'      ,
                                    -size         => [505,305]        ,
                                    -pos          => [140,  5]        ,
                                    -fixedwidth   => 1                ,
                                    -tabstop      => 1                ,
                                    -background   => [255, 255, 255]  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'general'}  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'database'} , );

# General tab

# Tool Section
$winConfig->AddLabel(       -name        => 'lblToolShadowT'        ,
                            -size        => [ 80, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB3                , );
$winConfig->AddLabel(       -name        => 'lblToolT'              ,
                            -size        => [ 80, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [204,   0,  51]         ,
                            -text        => $STR{'Tool'}.':'        ,
                            -font        => $fontGB3                , );
$winConfig->AddButton(      -name        => 'btnExportLang'         ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 68]               ,
                            -text        => $STR{'Export'}.'Lang.ini',
                            -font        => $font10                 , );
$winConfig->AddButton(      -name        => 'btnCheckUpdate'        ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 98]               ,
                            -text        => $STR{'checkUpdate'}     ,
                            -font        => $font10                 , );
$winConfig->AddCheckbox(    -name        => 'chAutoUpdate'          ,
                            -size        => [200, 20]               ,
                            -pos         => [285,101]               ,
                            -text        => $STR{'AutoUpdateTip'}   ,
                            -background  => [255, 255, 255]         ,
                            -font        => $font10                 ,
                            -tabstop     => 1                       ,
                            -checked     => 1                       , );

# Functions section
$winConfig->AddLabel(       -name        => 'lblOptFunctionsShadowT',
                            -size        => [120, 22]               ,
                            -pos         => [151,141]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'OptFunctions'}.':',
                            -font        => $fontGB3                , );
$winConfig->AddLabel(       -name        => 'lblOptFunctionsT'      ,
                            -size        => [120, 22]               ,
                            -pos         => [150,140]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [204,   0,  51]         ,
                            -text        => $STR{'OptFunctions'}.':',
                            -font        => $fontGB3                , );
$winConfig->AddCheckbox(    -name        => 'chFullScreen'          ,
                            -size        => [150, 20]               ,
                            -pos         => [285,142]               ,
                            -text        => $STR{'chFullScreen'}    ,
                            -background  => [255, 255, 255]         ,
                            -font        => $font10                 , );
$winConfig->AddCheckbox(    -name        => 'chRememberPos'         ,
                            -size        => [195, 20]               ,
                            -pos         => [440,142]               ,
                            -text        => $STR{'chRememberPos'}   ,
                            -background  => [255, 255, 255]         ,
                            -font        => $font10                 , );
$winConfig->AddLabel(       -name        => 'lblMaxSize1'           ,
                            -size        => [115, 22]               ,
                            -pos         => [150,173]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'MaxSize'}.':'     ,
                            -font        => $font10                 , );
$winConfig->AddTextfield(   -name        => 'tfMaxSize'             ,
                            -size        => [ 60, 22]               ,
                            -pos         => [285,170]               , );
$winConfig->AddLabel(       -name        => 'lblMaxSize2'           ,
                            -size        => [100, 22]               ,
                            -pos         => [350,173]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'chars'}           ,
                            -font        => $font10                 , );
$winConfig->AddLabel(       -name        => 'lblNsLookupTO1'        ,
                            -size        => [115, 22]               ,
                            -pos         => [150,203]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'NsLookupTO1'}.':' ,
                            -font        => $font10                 , );
$winConfig->AddTextfield(   -name        => 'tfLookupTO'            ,
                            -size        => [ 30, 22]               ,
                            -pos         => [285,200]               , );
$winConfig->AddLabel(       -name        => 'lblNsLookupTO2'        ,
                            -size        => [ 70, 22]               ,
                            -pos         => [320,203]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => lc($STR{'seconds'})     ,
                            -font        => $font10                 , );
$winConfig->AddLabel(       -name        => 'lblUserAgent'          ,
                            -size        => [115, 22]               ,
                            -pos         => [150,233]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'UserAgent'}.':'   ,
                            -font        => $font10                 , );
$winConfig->AddTextfield(   -name        => 'tfUserAgent'           ,
                            -size        => [350, 22]               ,
                            -pos         => [285,230]               , );
$winConfig->AddLabel(       -name        => 'lblNoResultOpt'        ,
                            -size        => [115, 22]               ,
                            -pos         => [150,263]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'NoResultOpt'}.':' ,
                            -font        => $font10                 , );
$winConfig->AddRadioButton( -name        => 'rbNoResultOpt1'        ,
                            -size        => [150, 22]               ,
                            -pos         => [285,260]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'NoResultOpt1'}    ,
                            -tip         => $STR{'NoResultOpt1Tip'} ,
                            -font        => $font10                 ,
                            -checked     => 1                       ,
                            -group       => 1                       , );
$winConfig->AddRadioButton( -name        => 'rbNoResultOpt2'        ,
                            -size        => [195, 22]               ,
                            -pos         => [440,260]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'NoResultOpt2'}    ,
                            -tip         => $STR{'NoResultOpt2Tip'} ,
                            -font        => $font10                 ,
                            -checked     => 0                       , );

# Database tab

# MAC OUI Database section
$winConfig->AddLabel(       -name        => 'lblMACOUIDBShadowT'    ,
                            -size        => [250, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'OUIDB'}.':'       ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblMACOUIDBT'          ,
                            -size        => [250, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [204,   0,  51]         ,
                            -text        => $STR{'OUIDB'}.':'       ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chMACOUIDBAutoUpt'     ,
                            -size        => [220, 20]               ,
                            -pos         => [415, 38]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'AutoUpdateTip'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfMACOUIDB'            ,
                            -size        => [412, 22]               ,
                            -pos         => [150, 68]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnMACOUIDB'           ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565, 68]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'selectDBFile'}    ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnMACOUIDBUpt'        ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588, 68]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => $STR{'downloadDB'}      ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnMACOUIDBImport'     ,
                            -size        => [ 22, 22]               ,
                            -pos         => [611, 68]               ,
                            -bitmap      => $import16Bmp            ,
                            -tip         => $STR{'importOUIDB'}     ,
                            -visible     => 0                       , );
# GeoIP Database section
$winConfig->AddLabel(       -name        => 'lblGeoIPDBShadowT'     ,
                            -size        => [250, 22]               ,
                            -pos         => [151,104]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'GeoIPDB'}.':'     ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblGeoIPDBT'           ,
                            -size        => [250, 22]               ,
                            -pos         => [150,103]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [204,   0,  51]         ,
                            -text        => $STR{'GeoIPDB'}.':'     ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddCheckbox(    -name        => 'chGeoIPDBAutoUpt'      ,
                            -size        => [220, 20]               ,
                            -pos         => [415,103]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'AutoUpdateTip'}   ,
                            -font        => $font10                 ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfGeoIPDB'             ,
                            -size        => [412, 22]               ,
                            -pos         => [150,133]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnGeoIPDB'            ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,133]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'selectDBFile'}    ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnGeoIPDBUpt'         ,
                            -size        => [ 22, 22]               ,
                            -pos         => [588,133]               ,
                            -bitmap      => $downloadBmp            ,
                            -tip         => $STR{'downloadDB'}      ,
                            -visible     => 0                       , );

# XL-Tools Database section
$winConfig->AddLabel(       -name        => 'lblXLWHOISDBShadowT'   ,
                            -size        => [250, 22]               ,
                            -pos         => [151,169]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'XLWhoisDB'}.':'   ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblXLWHOISDBT'         ,
                            -size        => [250, 22]               ,
                            -pos         => [150,168]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [204,   0,  51]         ,
                            -text        => $STR{'XLWhoisDB'}.':'   ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfXLWHOISDB'           ,
                            -size        => [412, 22]               ,
                            -pos         => [150,198]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnXLWHOISDB'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,198]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'selectDBFile'}    ,
                            -visible     => 0                       , );
# Issuer Identification Number (IIN) Database section
$winConfig->AddLabel(       -name        => 'lblIINDBShadowT'       ,
                            -size        => [250, 22]               ,
                            -pos         => [151,234]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => $STR{'IINLocalDB'}.':'  ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddLabel(       -name        => 'lblIINDBT'             ,
                            -size        => [250, 22]               ,
                            -pos         => [150,233]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [204,   0,  51]         ,
                            -text        => $STR{'IINLocalDB'}.':'  ,
                            -font        => $fontGB3                ,
                            -visible     => 0                       , );
$winConfig->AddTextfield(   -name        => 'tfIINDB'               ,
                            -size        => [412, 22]               ,
                            -pos         => [150,263]               ,
                            -visible     => 0                       , );
$winConfig->AddButton(      -name        => 'btnIINDB'              ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,263]               ,
                            -bitmap      => $fileOpenBmp            ,
                            -tip         => $STR{'selectDBFile'}    ,
                            -visible     => 0                       , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPb  = Win32::GUI::DialogBox->new(-name        => 'winPb'                   ,
                                        -parent      => $winConfig                ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]      ,
                                        -size        => [600, 170]                ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);

$winPb->AddLabel(       -name        => 'lblLogo2'       ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logo128Bmp      , );
$winPb->AddLabel(       -name        => 'lblPbCurr'      ,
                        -size        => [460, 22]        ,
                        -pos         => [140, 25]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb'        ,
                        -size        => [355, 22]        ,
                        -pos         => [140, 50]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount'       ,
                        -size        => [100, 22]        ,
                        -pos         => [500, 52]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0, 102, 204]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [300, 95]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#

$win->cbLists->SetCurSel(0);
&cbLists_Change();

if (-T $CONFIG_FILE) {
  &loadConfig(\%CONFIG);
  
  # Check update for tool and databases ?
  if ($CONFIG{'TOOL_AUTO_UPDATE'} or $CONFIG{'MACOUI_DB_AUTO_UPDATE'} or $CONFIG{'GEOIP_DB_AUTO_UPDATE'}) {
    $THR_UPDATE = threads->create(sub { &updateAll(); });
  }
  
  # Position the window
  if ($winConfig->chRememberPos->Checked() and exists($CONFIG{'SCREEN_LEFT'}) and exists($CONFIG{'SCREEN_TOP'})) {
    $win->Left($CONFIG{'SCREEN_LEFT'});
    $win->Top($CONFIG{'SCREEN_TOP'});
  }
  
} else {
  # Create the Configuration Wizard Window
  my $refWinCW = &createCW();
  
  # First start of the tool, Load configuration wizard
  $THR_UPDATE = threads->create(sub { &firstStart($refWinCW); });
}

$START = 1;
if ($winConfig->chFullScreen->Checked()) { $win->Show(3); }
else                                     { $win->Show();  }
Win32::GUI::Dialog();

#--------------------------#
sub winMain_Terminate
#--------------------------#
{
  # Remember position
  my $winLeft   = $win->AbsLeft();
  my $winTop    = $win->AbsTop();
  $CONFIG{'SCREEN_LEFT'} = $winLeft;
  $CONFIG{'SCREEN_TOP'}  = $winTop;
  &saveConfig(\%CONFIG);

  # Close program
  -1;
  
}  #--- End winMain_Terminate

#--------------------------#
sub winMain_Resize
#--------------------------#
{
  # Header
  $win->Tab->Width($win->ScaleWidth()-308);
  $win->tfWith->Width($win->ScaleWidth()/9.3);
  $win->lblColumnsNo->Left($win->tfWith->Left()+$win->ScaleWidth()/9.3+20);
  $win->tfColumnsNo->Left($win->lblColumnsNo->Left()+70);
  $win->tfColumnsNo->Width($win->ScaleWidth()/9.3);
  $win->lblReplaceREOk->Width($win->ScaleWidth()/5+2);
  $win->lblReplaceREErr->Width($win->ScaleWidth()/5+2);
  $win->lblReplaceREWarn->Width($win->ScaleWidth()/5+2);
  $win->tfReplace->Width($win->ScaleWidth()/5);
  $win->lblReplBy->Left($win->tfReplace->Left()+$win->ScaleWidth()/5+10);
  $win->lblReplaceByREOk->Left($win->tfReplace->Left()+$win->ScaleWidth()/5+44);
  $win->lblReplaceByREOk->Width($win->ScaleWidth()/5+2);
  $win->lblReplaceByREErr->Left($win->tfReplace->Left()+$win->ScaleWidth()/5+44);
  $win->lblReplaceByREErr->Width($win->ScaleWidth()/5+2);
  $win->lblReplaceByREWarn->Left($win->tfReplace->Left()+$win->ScaleWidth()/5+44);
  $win->lblReplaceByREWarn->Width($win->ScaleWidth()/5+2);
  $win->tfReplBy->Left($win->tfReplace->Left()+$win->ScaleWidth()/5+45);
  $win->tfReplBy->Width($win->ScaleWidth()/5);
  
  $win->lblAddDT->Left($win->btnGuess()->Left()+65);
  $win->tfValAddDT->Left($win->btnGuess()->Left()+100);
  $win->cbTypeValAddDT->Left($win->btnGuess()->Left()+145);
  $win->cbCFLists->Width($win->ScaleWidth()/4);
  $win->btnCFAdd->Left($win->cbCFLists->Left()+$win->ScaleWidth()/4+4);
  $win->btnCFRem->Left($win->cbCFLists->Left()+$win->ScaleWidth()/4+30);
  $win->btnCFEdit->Left($win->cbCFLists->Left()+$win->ScaleWidth()/4+56);
  $win->btnCFNew->Left($win->cbCFLists->Left()+$win->ScaleWidth()/4+82);
  $win->tfCFTitle->Width($win->ScaleWidth()/4);
  $win->btnCFSave->Left($win->tfCFTitle->Left()+$win->ScaleWidth()/4+4);
  $win->btnCFCancel->Left($win->tfCFTitle->Left()+$win->ScaleWidth()/4+30);
  
  # Lists
  # Adjusts splitter position
  my $split1Pos;
  if ($SPLIT1_CURR_POS) { $split1Pos = $win->ScaleWidth()/$SPLIT1_CURR_POS; }
  else {
    $split1Pos = $win->split1->Left();
    $SPLIT1_CURR_POS = $win->ScaleWidth()/$split1Pos;
  }
  my $split2Pos;
  if ($SPLIT2_CURR_POS) { $split2Pos = $win->ScaleWidth()/$SPLIT2_CURR_POS; }
  else {
    $split2Pos = $win->split2->Left();
    $SPLIT2_CURR_POS = $win->ScaleWidth()/$split2Pos;
  }
  $win->split1->Max($win->ScaleWidth()/2);
  if ($LIST2_VISIBLE) { $win->split2->Min($win->ScaleWidth()/2); }
  else                { $win->split2->Min(200);                  }
  $win->split2->Max($win->ScaleWidth()-200);
  $win->split1->Left($split1Pos);
  $win->split1->Height($win->ScaleHeight()-150);
  $win->split2->Left($split2Pos);
  $win->split2->Height($win->ScaleHeight()-150);
  
  # List 1
  if ($LIST2_VISIBLE) {
    $win->gbList1->Resize($split1Pos-6, $win->ScaleHeight()-162);
    $win->tfList1->Resize($split1Pos-16, $win->ScaleHeight()-212);
    $win->lblList1Count->Left($split1Pos-70);
  } else {
    $win->gbList1->Resize($split2Pos-6, $win->ScaleHeight()-162);
    $win->tfList1->Resize($split2Pos-16, $win->ScaleHeight()-212);
    $win->lblList1Count->Left($split2Pos-70);
  }

  # List 2
  $win->gbList2->Left($split1Pos+5);
  $win->gbList2->Resize($split2Pos-$split1Pos-7.5, $win->ScaleHeight()-162);
  $win->btnList2File->Left($split1Pos+9);
  $win->btnList2Del->Left($split1Pos+33);
  $win->lblList2Count->Left($split2Pos-70);
  $win->tfList2->Left($split1Pos+9);
  $win->tfList2->Resize($split2Pos-$split1Pos-16, $win->ScaleHeight()-212);

  # List 3
  $win->gbList3->Left($split2Pos+5);
  $win->gbList3->Resize($win->ScaleWidth()-$split2Pos-8, $win->ScaleHeight()-162);
  $win->btnList3Open->Left($split2Pos+9);
  $win->lblList3Count->Left($win->ScaleWidth()-70);
  $win->tfList3->Left($split2Pos+9);
  $win->tfList3->Resize($win->ScaleWidth()-$split2Pos-16, $win->ScaleHeight()-212);
  
  # Footer
  $win->lblFooter->Top($win->ScaleHeight()-55);
  $win->lblFooter->Width($win->ScaleWidth());
  $win->lblNotReady->Top($win->ScaleHeight()-40);
  $win->lblPbCurr->Top($win->ScaleHeight()-48);
  $win->lblPbCurr->Width($win->ScaleWidth()-200);
  $win->pb->Top($win->ScaleHeight()-27);
  $win->pb->Width($win->ScaleWidth()-310);
  $win->lblPbCount->Top($win->ScaleHeight()-25);
  $win->lblPbCount->Left($win->ScaleWidth()-295);
  $win->btnProcess->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnStop->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnWinConfig->Move($win->ScaleWidth()-135, $win->ScaleHeight()-45);
  $win->btnHelp->Move($win->ScaleWidth()-90, $win->ScaleHeight()-45);
  $win->btnAbout->Move($win->ScaleWidth()-45, $win->ScaleHeight()-45);

}  #--- End winMain_Resize

#--------------------------#
sub split1
#--------------------------#
{
  # Local variables
  my ($s, $left) = @_;
  my $split2Pos  = $win->split2->Left();
  $SPLIT1_CURR_POS = $win->ScaleWidth()/$left;

  # Resize and move
  # List 1
  $win->gbList1->Width($left - 6);
  $win->tfList1->Width($left-16);
  $win->lblList1Count->Left($left-70);
  # List 2
  if ($split2Pos - $left < 100) {
    if ($LIST2_VISIBLE) {
      # Hide List 2 (not enough space)
      $win->gbList2->Hide();
      $win->btnList2File->Hide();
      $win->btnList2Del->Hide();
      $win->lblList2Count->Hide();
      $win->tfList2->Hide();
    }
  } else {
    # Show List 2
    if ($LIST2_VISIBLE) {
      $win->gbList2->Show();
      $win->btnList2File->Show();
      $win->btnList2Del->Show();
      $win->lblList2Count->Show();
      $win->tfList2->Show();
    }
    $win->gbList2->Width($split2Pos - $left - 7.5);
    $win->gbList2->Left($left + 5);
    $win->btnList2File->Left($left+9);
    $win->btnList2Del->Left($left+33);
    $win->lblList2Count->Left($split2Pos-70);
    $win->tfList2->Left($left+9);
    $win->tfList2->Width($split2Pos-$left-16);
  }

  return(1);

}  #--- End split1

#--------------------------#
sub split2
#--------------------------#
{
  # Local variables
  my ($s, $left) = @_;
  my $split1Pos  = $win->split1->Left();
  $SPLIT2_CURR_POS = $win->ScaleWidth()/$left;

  # Resize and move
  # List 2
  if ($left - $split1Pos < 100) {
    if ($LIST2_VISIBLE) {
      # Hide List 2 (not enough space)
      $win->gbList2->Hide();
      $win->btnList2File->Hide();
      $win->btnList2Del->Hide();
      $win->lblList2Count->Hide();
      $win->tfList2->Hide();
    }
  } else {
    # Show List 2
    if ($LIST2_VISIBLE) {
      $win->gbList2->Show();
      $win->btnList2File->Show();
      $win->btnList2Del->Show();
      $win->lblList2Count->Show();
      $win->tfList2->Show();
    }
    $win->gbList2->Width($left - $split1Pos - 7.5);
    $win->lblList2Count->Left($left-70);
    $win->tfList2->Left($split1Pos+9);
    $win->tfList2->Width($left-$split1Pos-16);
  }
  # If List 2 is not visible, adjust List 1
  if (!$LIST2_VISIBLE) {
    $win->gbList1->Width($left - 6);
    $win->tfList1->Width($left-16);
    $win->lblList1Count->Left($left-70);
  }
  
  # List 3
  $win->gbList3->Width($win->ScaleWidth() - $left - 9);
  $win->gbList3->Left($left + 5);
  $win->btnList3Open->Left($left+9);
  $win->lblList3Count->Left($win->ScaleWidth()-70);
  $win->tfList3->Left($left+9);
  $win->tfList3->Width($win->ScaleWidth()-$left-16);

  return(1);

}  #--- End split2

#--------------------------#
sub showList2
#--------------------------#
{
  $LIST2_VISIBLE = 1;
  $win->gbList2->Show();
  $win->btnList2File->Show();
  $win->btnList2Del->Show();
  $win->lblList2Count->Show();
  $win->tfList2->Show();
  $win->split1->Show();
  $win->split1->Left($win->ScaleWidth()/3.07586206896552);
  $win->split2->Left($win->ScaleWidth()/1.5405872193437);
  &split1(undef, $win->ScaleWidth()/3.07586206896552);
  &split2(undef, $win->ScaleWidth()/1.5405872193437);
  $win->split2->Min($win->ScaleWidth()/2);
  
}  #--- End showList2

#--------------------------#
sub hideList2
#--------------------------#
{
  $LIST2_VISIBLE = 0;
  $win->tfList2->Text('');
  $win->gbList2->Hide();
  $win->btnList2File->Hide();
  $win->btnList2Del->Hide();
  $win->lblList2Count->Hide();
  $win->tfList2->Hide();
  $win->split1->Hide();
  $win->split1->Left($win->ScaleWidth()/2);
  $win->split2->Left($win->ScaleWidth()/2);
  &split1(undef, $win->ScaleWidth()/2);
  &split2(undef, $win->ScaleWidth()/2);
  $win->split2->Min(200);
  
}  #--- End hideList2

#--------------------------#
sub Tab_Click
#--------------------------#
{
  # Show Lists tab
  if ($win->Tab->SelectedItem() == 0) {
    $win->cbLists->Show();
    if ($win->cbLists->GetCurSel() == -1) { $win->cbLists->SetCurSel(0); }
    &cbLists_Change();
    # Hide Sorting tab
    $win->cbSorts->Hide();
    $win->rbAsc->Hide();
    $win->rbDsc->Hide();
    $win->lblDTFormat->Hide();
    $win->cbDTFormat->Hide();
    $win->btnGuess->Hide();
    # Hide Conversion tab
    $win->cbConv->Hide();
    # Hide Time tab
    $win->cbTime->Hide();
    $win->rbLocaltime->Hide();
    $win->rbGMTime->Hide();
    $win->rbOtherTZ->Hide();
    $win->cbOtherTZ->Hide();
    $win->chSingleDate->Hide();
    $win->dtTimeDiffDate->Hide();
    $win->dtTimeDiffTime->Hide();
    $win->lblAddDT->Hide();
    $win->tfValAddDT->Hide();
    $win->cbTypeValAddDT->Hide();
    # Hide Utils tab
    $win->cbUtils->Hide();
    $win->cbGeoIPOpt->Hide();
    $win->chGeoIPAddHeaders->Hide();
    $win->cbUAOpt->Hide();
    $win->chUAAddHeaders->Hide();
    $win->rbIINLocalDB->Hide();
    $win->rbBinlist->Hide();
    $win->cbCFLists->Hide();
    $win->btnCFAdd->Hide();
    $win->btnCFRem->Hide();
    $win->btnCFEdit->Hide();
    $win->btnCFNew->Hide();
    $win->chCFMatchCase->Hide();
    $win->lblCFTitle->Hide();
    $win->tfCFTitle->Hide();
    $win->btnCFSave->Hide();
    $win->btnCFCancel->Hide();
    
  # Show Sorting tab
  } elsif ($win->Tab->SelectedItem() == 1) {
    $win->cbSorts->Show();
    if ($win->cbSorts->GetCurSel() == -1) { $win->cbSorts->SetCurSel(0); }
    $win->rbAsc->Show();
    $win->rbDsc->Show();
    &cbSorts_Change();
    # Hide Lists tab
    $win->cbLists->Hide();
    $win->chMatchCase->Hide();
    $win->chRegex->Hide();
    $win->chEval->Hide();
    $win->lblWith->Hide();
    $win->tfWith->Hide();
    $win->lblColumnsNo->Hide();
    $win->tfColumnsNo->Hide();
    $win->lblReplace->Hide();
    $win->lblReplaceREOk->Hide();
    $win->lblReplaceREErr->Hide();
    $win->lblReplaceREWarn->Hide();
    $win->tfReplace->Hide();
    $win->lblReplBy->Hide();
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
    $win->tfReplBy->Hide();
    $win->rbAll->Hide();
    $win->rbFirstOnly->Hide();
    $win->rbFirstEachWord->Hide();
    # Hide Conversion tab
    $win->cbConv->Hide();
    # Hide Time tab
    $win->cbTime->Hide();
    $win->rbLocaltime->Hide();
    $win->rbGMTime->Hide();
    $win->rbOtherTZ->Hide();
    $win->cbOtherTZ->Hide();
    $win->chSingleDate->Hide();
    $win->dtTimeDiffDate->Hide();
    $win->dtTimeDiffTime->Hide();
    $win->lblAddDT->Hide();
    $win->tfValAddDT->Hide();
    $win->cbTypeValAddDT->Hide();
    # Hide Utils tab
    $win->cbUtils->Hide();
    $win->cbGeoIPOpt->Hide();
    $win->chGeoIPAddHeaders->Hide();
    $win->cbUAOpt->Hide();
    $win->chUAAddHeaders->Hide();
    $win->rbIINLocalDB->Hide();
    $win->rbBinlist->Hide();
    $win->cbCFLists->Hide();
    $win->btnCFAdd->Hide();
    $win->btnCFRem->Hide();
    $win->btnCFEdit->Hide();
    $win->btnCFNew->Hide();
    $win->chCFMatchCase->Hide();
    $win->lblCFTitle->Hide();
    $win->tfCFTitle->Hide();
    $win->btnCFSave->Hide();
    $win->btnCFCancel->Hide();
    
  # Show Conversion tab
  } elsif ($win->Tab->SelectedItem() == 2) {
    $win->cbConv->Show();
    &cbConv_Change();
    if ($win->cbConv->GetCurSel() == -1) { $win->cbConv->SetCurSel(0); }
    # Hide Lists tab
    $win->cbLists->Hide();
    $win->chMatchCase->Hide();
    $win->chRegex->Hide();
    $win->chEval->Hide();
    $win->lblWith->Hide();
    $win->tfWith->Hide();
    $win->lblColumnsNo->Hide();
    $win->tfColumnsNo->Hide();
    $win->lblReplace->Hide();
    $win->lblReplaceREOk->Hide();
    $win->lblReplaceREErr->Hide();
    $win->lblReplaceREWarn->Hide();
    $win->tfReplace->Hide();
    $win->lblReplBy->Hide();
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
    $win->tfReplBy->Hide();
    $win->rbAll->Hide();
    $win->rbFirstOnly->Hide();
    $win->rbFirstEachWord->Hide();
    # Hide Sorting tab
    $win->cbSorts->Hide();
    $win->rbAsc->Hide();
    $win->rbDsc->Hide();
    $win->lblDTFormat->Hide();
    $win->cbDTFormat->Hide();
    $win->btnGuess->Hide();
    # Hide Time tab
    $win->cbTime->Hide();
    $win->rbLocaltime->Hide();
    $win->rbGMTime->Hide();
    $win->rbOtherTZ->Hide();
    $win->cbOtherTZ->Hide();
    $win->chSingleDate->Hide();
    $win->dtTimeDiffDate->Hide();
    $win->dtTimeDiffTime->Hide();
    $win->lblAddDT->Hide();
    $win->tfValAddDT->Hide();
    $win->cbTypeValAddDT->Hide();
    # Hide Utils tab
    $win->cbUtils->Hide();
    $win->cbGeoIPOpt->Hide();
    $win->chGeoIPAddHeaders->Hide();
    $win->cbUAOpt->Hide();
    $win->chUAAddHeaders->Hide();
    $win->rbIINLocalDB->Hide();
    $win->rbBinlist->Hide();
    $win->cbCFLists->Hide();
    $win->btnCFAdd->Hide();
    $win->btnCFRem->Hide();
    $win->btnCFEdit->Hide();
    $win->btnCFNew->Hide();
    $win->chCFMatchCase->Hide();
    $win->lblCFTitle->Hide();
    $win->tfCFTitle->Hide();
    $win->btnCFSave->Hide();
    $win->btnCFCancel->Hide();
    
  # Show Time tab
  } elsif ($win->Tab->SelectedItem() == 3) {
    $win->cbTime->Show();
    if ($win->cbTime->GetCurSel() == -1) { $win->cbTime->SetCurSel(0); }
    &cbTime_Change();
    # Hide Lists tab
    $win->cbLists->Hide();
    $win->chMatchCase->Hide();
    $win->chRegex->Hide();
    $win->chEval->Hide();
    $win->lblWith->Hide();
    $win->tfWith->Hide();
    $win->lblColumnsNo->Hide();
    $win->tfColumnsNo->Hide();
    $win->lblReplace->Hide();
    $win->lblReplaceREOk->Hide();
    $win->lblReplaceREErr->Hide();
    $win->lblReplaceREWarn->Hide();
    $win->tfReplace->Hide();
    $win->lblReplBy->Hide();
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
    $win->tfReplBy->Hide();
    $win->rbAll->Hide();
    $win->rbFirstOnly->Hide();
    $win->rbFirstEachWord->Hide();
    # Hide Sorting tab
    $win->cbSorts->Hide();
    $win->rbAsc->Hide();
    $win->rbDsc->Hide();
    # Hide Conversion tab
    $win->cbConv->Hide();
    # Hide Utils tab
    $win->cbUtils->Hide();
    $win->cbGeoIPOpt->Hide();
    $win->chGeoIPAddHeaders->Hide();
    $win->cbUAOpt->Hide();
    $win->chUAAddHeaders->Hide();
    $win->rbIINLocalDB->Hide();
    $win->rbBinlist->Hide();
    $win->cbCFLists->Hide();
    $win->btnCFAdd->Hide();
    $win->btnCFRem->Hide();
    $win->btnCFEdit->Hide();
    $win->btnCFNew->Hide();
    $win->chCFMatchCase->Hide();
    $win->lblCFTitle->Hide();
    $win->tfCFTitle->Hide();
    $win->btnCFSave->Hide();
    $win->btnCFCancel->Hide();
    
  # Show Utils tab
  } elsif ($win->Tab->SelectedItem() == 4) {
    $win->cbUtils->Show();
    if ($win->cbUtils->GetCurSel() == -1) { $win->cbUtils->SetCurSel(0); }
    &cbUtils_Change();
    # Hide Lists tab
    $win->cbLists->Hide();
    $win->chMatchCase->Hide();
    $win->chRegex->Hide();
    $win->chEval->Hide();
    $win->lblWith->Hide();
    $win->tfWith->Hide();
    $win->lblColumnsNo->Hide();
    $win->tfColumnsNo->Hide();
    $win->lblReplace->Hide();
    $win->lblReplaceREOk->Hide();
    $win->lblReplaceREErr->Hide();
    $win->lblReplaceREWarn->Hide();
    $win->tfReplace->Hide();
    $win->lblReplBy->Hide();
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
    $win->tfReplBy->Hide();
    $win->rbAll->Hide();
    $win->rbFirstOnly->Hide();
    $win->rbFirstEachWord->Hide();
    # Hide Sorting tab
    $win->cbSorts->Hide();
    $win->rbAsc->Hide();
    $win->rbDsc->Hide();
    $win->lblDTFormat->Hide();
    $win->cbDTFormat->Hide();
    $win->btnGuess->Hide();
    # Hide Conversion tab
    $win->cbConv->Hide();
    # Hide Time tab
    $win->cbTime->Hide();
    $win->rbLocaltime->Hide();
    $win->rbGMTime->Hide();
    $win->rbOtherTZ->Hide();
    $win->cbOtherTZ->Hide();
    $win->chSingleDate->Hide();
    $win->dtTimeDiffDate->Hide();
    $win->dtTimeDiffTime->Hide();
    $win->lblAddDT->Hide();
    $win->tfValAddDT->Hide();
    $win->cbTypeValAddDT->Hide();
  }
  
  &isProcessReady(0);

}  #--- End Tab_Click

#--------------------------#
sub cbLists_Change
#--------------------------#
{
  # Local variables
  my $selFunc = $win->cbLists->GetCurSel();
  # Possibles value are 0 = 'No duplicate', 1 = 'Only duplicates', 2 = 'Count items', 3 = 'Count characters',
  # 4 = 'L1-L2', 5 = 'Column to row', 6 = 'Row to column', 7 = 'List to regex', 8 = 'Concat', 9 = 'Split strings',
  # 10 = 'Split and extract', 11 = 'Merge lines', 12 = 'Replace', 13 = 'Reverse string', 14 = 'Lowercase',
  # 15 = 'Uppercase', 16 = 'Add line number'
  
  # Show available options
  
  # Show List 2 ?
  if ($selFunc == 1 or $selFunc == 4 or $selFunc == 8) { &showList2(); }
  else                                                 { &hideList2(); }

  # Show Match case option ?
  if ($selFunc < 3 or $selFunc == 4 or $selFunc == 12) {
    $win->chMatchCase->Checked(1);
    $win->chMatchCase->Show();
  } else {
    $win->chMatchCase->Checked(0);
    $win->chMatchCase->Hide();
  }
  
  # Show Regex option
  if ($selFunc == 9 or $selFunc == 10 or $selFunc == 12) {
    $win->chRegex->Show();
  } else {
    $win->chRegex->Checked(0);
    $win->chRegex->Hide();
  }
  
  # Show Eval option
  if ($selFunc == 12) {
    $win->chEval->Show();
  } else {
    $win->chEval->Checked(0);
    $win->chEval->Hide();
  }
  
  # Show With textfield ?
  if ($selFunc == 5 or $selFunc == 6 or $selFunc == 8 or $selFunc == 9 or $selFunc == 10 or $selFunc == 11) {
    $win->lblWith->Show();
    $win->tfWith->Show();
  } else {
    $win->lblWith->Hide();
    $win->tfWith->Hide();
  }
  
  # Show ColumnsNo textfield ?
  if ($selFunc == 10) {
    $win->lblColumnsNo->Show();
    $win->tfColumnsNo->Show();
  } else {
    $win->lblColumnsNo->Hide();
    $win->tfColumnsNo->Hide();
  }
  
  # Show Replace-By textfields ?
  if ($selFunc == 12) {
    $win->lblReplace->Show();
    $win->tfReplace->Show();
    $win->lblReplBy->Show();
    $win->tfReplBy->Show();
  } else {
    $win->lblReplace->Hide();
    $win->lblReplaceREOk->Hide();
    $win->lblReplaceREErr->Hide();
    $win->lblReplaceREWarn->Hide();
    $win->tfReplace->Hide();
    $win->tfReplace->Text('');
    $win->lblReplBy->Hide();
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
    $win->tfReplBy->Hide();
    $win->tfReplBy->Text('');
  }
  
  # Show lowercase-uppercase Options
  if ($selFunc == 14 or $selFunc == 15) {
    $win->rbAll->Show();
    $win->rbFirstOnly->Show();
    $win->rbFirstEachWord->Show();
  } else {
    $win->rbAll->Hide();
    $win->rbFirstOnly->Hide();
    $win->rbFirstEachWord->Hide();
  }
  
  &isProcessReady(0);

}  #--- End cbLists_Change

#--------------------------#
sub tfWith_Change
#--------------------------#
{
  &isProcessReady(0);

}  #--- End tfWith_Change

#--------------------------#
sub tfColumnsNo_Change
#--------------------------#
{
  &isProcessReady(0);

}  #--- End tfColumnsNo_Change

#--------------------------#
sub tfReplace_Change
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chRegex->Checked()) {
    &showReplaceREStatus;
  }
  
  # Enable By textfield
  if ($win->tfReplace->Text) {
    $win->tfReplBy->Enable();
    if ($win->chRegex->Checked()) { $win->chEval->Enable(); }
  } else {
    $win->tfReplBy->Text('');
    $win->tfReplBy->Disable();
    $win->chEval->Checked(0);
    $win->chEval->Disable();
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
  }
  
  &isProcessReady(0);

}  #--- End tfReplace_Change

#--------------------------#
sub chRegex_Click
#--------------------------#
{
  # Test Regex if necessary
  if ($win->chRegex->Checked()) {
    &showReplaceREStatus;
    $win->chEval->Enable();
  } else {
    $win->lblReplaceREOk->Hide();
    $win->lblReplaceREErr->Hide();
    $win->lblReplaceREWarn->Hide();
    $win->chEval->Checked(0);
    $win->chEval->Disable();
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
  }
  
  # Revaluate Replacement expression
  if ($win->tfReplBy->Text()) { &showReplaceByREStatus; }
  
  &isProcessReady(0);

}  #--- End chRegex_Click

#--------------------------#
sub showReplaceREStatus
#--------------------------#
{
  # Local variables
  my $regex = $win->tfReplace->Text();
  if ($regex) {
    my ($statusRegex, $msg) = &validRegex($regex);
    
    # Warning
    if      ($statusRegex == 2) {
      $win->lblReplaceREWarn->Show();
      $win->lblReplaceREOk->Hide();
      $win->lblReplaceREErr->Hide();
    # Error
    } elsif ($statusRegex == 1) {
      $win->lblReplaceREErr->Show();
      $win->lblReplaceREOk->Hide();
      $win->lblReplaceREWarn->Hide();
    # Ok
    } else {
      $win->lblReplaceREOk->Show();
      $win->lblReplaceREErr->Hide();
      $win->lblReplaceREWarn->Hide();
    }
  } else {
    $win->lblReplaceREOk->Hide();
    $win->lblReplaceREErr->Hide();
    $win->lblReplaceREWarn->Hide();
  }

}  #--- End showReplaceREStatus

#--------------------------#
sub validRegex
#--------------------------#
{
  # Local variables
  my $regex = shift;
  
  if ($regex) {
    eval { if ('test' =~ /$regex/) { } };
    if ($@) {
      my $errRegex = (split(/ at /,$@))[0];
      return(1, $errRegex);
    } else {
      # Valid but senseless regex
      if ($regex =~ /^\||\|\||(?:[^\\]\|$)/ or $regex =~ /^\(\.\*\)$/) { return(2, undef); }
      else { return(0, undef); }
    }
  }
  
}  #--- End validRegex

#--------------------------#
sub tfReplBy_Change
#--------------------------#
{
  &showReplaceByREStatus;
  
  &isProcessReady(0);

}  #--- End tfReplBy_Change

#--------------------------#
sub chEval_Click
#--------------------------#
{
  if ($win->chRegex->Checked()) {
    &showReplaceByREStatus;
  } else {
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
  }
  &isProcessReady(0);

}  #--- End chEval_Click

#--------------------------#
sub showReplaceByREStatus
#--------------------------#
{
  # Local variables
  my $expr = $win->tfReplBy->Text();
  if ($win->chRegex->Checked() and $expr) {
    my ($status, $msg) = &validReplacement;
    
    # Warning
    if      ($status and $status == 2) {
      $win->lblReplaceByREWarn->Show();
      $win->lblReplaceByREOk->Hide();
      $win->lblReplaceByREErr->Hide();
    # Error
    } elsif ($status) {
      $win->lblReplaceByREErr->Show();
      $win->lblReplaceByREOk->Hide();
      $win->lblReplaceByREWarn->Hide();
    # Ok
    } else {
      $win->lblReplaceByREOk->Show();
      $win->lblReplaceByREErr->Hide();
      $win->lblReplaceByREWarn->Hide();
    }
  } else {
    $win->lblReplaceByREOk->Hide();
    $win->lblReplaceByREErr->Hide();
    $win->lblReplaceByREWarn->Hide();
  }

}  #--- End showReplaceByREStatus

#--------------------------#
sub validReplacement
#--------------------------#
{
  # Local variables
  my $expr = $win->tfReplBy->Text();
  my $test = 'test';
  
  if ($expr =~ /\$1/ and !$win->chEval->Checked()) { $expr = '"' . $expr . '"';  } # Capture with Eval not checked
  if ($win->chEval->Checked() or $expr =~ /\$1/)   { $test =~ s/(.+)/$expr/eegi; } # Regex
  else                                             { $test =~ s/(.+)/$expr/gi;   } # Keyword
  if ($@) {
    # Error
    my $err = (split(/ at /,$@))[0];
    return(1, $err);
  } else {
    # Warning for illegal characters
    if ($expr =~ /[\<\>\:\"\/\\\|\?\*]/) { return(2, undef); }
    
    # Replacement ok
    return(0, undef);
  }  
  
}  #--- End validReplacement

#--------------------------#
sub cbSorts_Change
#--------------------------#
{
  # Local variables
  my $selFunc = $win->cbSorts->GetCurSel();
  # Possibles value are 0 = 'Alphabetical order', 1 = 'Numerical order', 2 = 'String length', 3 = 'IPv4 Address', 4 = 'Date and time'
  
  # Hide List 2
  &hideList2();
  
  if ($selFunc == 4) {
    $win->lblDTFormat->Show();
    $win->cbDTFormat->Show();
    $win->cbDTFormat->SetCurSel(0);
    $win->cbDTFormat->SetFocus();
    $win->btnGuess->Show();
  } else {
    $win->lblDTFormat->Hide();
    $win->cbDTFormat->Hide();
    $win->btnGuess->Hide();
  }
  
  &isProcessReady(0);

}  #--- End cbSorts_Change

#--------------------------#
sub btnGuess_Click
#--------------------------#
{
  # Local variables
  my $firstItem = $win->tfList1->GetLine(0);
  # Possibles value are:                                                        #  0 = 'Guess (or variable)...',
  my @formatRE = ('\d+, \d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  1 = 'Tuesday, 08-Feb-2015 14:15:29 GMT',
                  '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2} \w{3} \d{4}' ,     #  2 = 'Thu Feb  3 17:03:55 GMT 2015',
                  '\d+, \d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  3 = 'Tuesday, 08-Feb-99 14:15:29 GMT',
                  '\w{3}, \d{2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  4 = 'Wed, 09 Feb 2015 22:23:32 GMT',
                  '\d{2}\/\w{3}\/\d{4}\:\d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}' ,     #  5 = '03/Feb/2015:17:03:55 -0700',
                  '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}'  ,     #  6 = '2015-02-03 14:15:29 -0100',
                  '\d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}'         ,     #  7 = '08-Feb-2015 14:15:29 GMT',
                  '\d{2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}'           ,     #  8 = '09 Feb 2015 22:23:32 GMT',
                  '\d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}'         ,     #  9 = '08-Feb-99 14:15:29 GMT',
                  '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2}'             ,     # 10 = 'Thu Feb  3 00:00:00 2015',
                  '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2}'               ,     # 11 = '2015-02-03 14:15:29',
                  '\d{2}\/\d{2}\/\d{4} \d{2}\:\d{2}\:\d{2}'               ,     # 12 = '03/02/2015 14:15:29',
                  '\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}'               ,     # 13 = '2015-02-03T14:15:29',
                  '\d{2}\-\d{2}\-\d{2} +\d{2}\:\d{2}\w{2}'                ,     # 14 = '11-15-99  03:52PM',
                  '\w{3} +\d{1,2} +\d{2}\:\d{2}'                          ,     # 15 = 'Feb  3 17:03',
                  '\w{3} +\d{1,2} +\d{4}'                                 ,     # 16 = 'Feb  3  2015',
                  '\d{2}\-\w{3}\-\d{4}'                                   ,     # 17 = '08-Feb-2015',
                  '\d{2}\/\w{3}\/\d{4}'                                   ,     # 18 = '03/Feb/2015',
                  '\d{4}\-\d{2}\-\d{2}'                                   ,     # 19 = '2015-02-03',
                  '\d{8}T\d{6}Z'                                          ,     # 20 = '20150203T141529Z',
                  '\d{2}\-\w{3}\-\d{2}'                                   ,     # 21 = '08-Feb-99',
                  '\d{2} \w{3} \d{4}'                                     ,     # 21 = '09 Feb 2015',
                  '\d{8}'                                                 , );  # 23 = '20150203',
  
  # Guess format
  my $i = 0;
  foreach my $format (@formatRE) {
    my $regex = $format;
    if ($firstItem =~ /($format)/) {
      eval { parse_date($firstItem); };
      if (!$@) {
        $win->cbDTFormat->SetCurSel($i+1);
        return();
      }
    }
    $i++;
  }
  
  # if not found
  Win32::GUI::MessageBox($win, $STR{'formatNotFound'}.'...', $STR{'error'}, 0x40010);

}  #--- End btnGuess_Click

#--------------------------#
sub cbConv_Change
#--------------------------#
{
  # Hide List 2
  &hideList2();
  
  &isProcessReady(0);

}  #--- End cbConv_Change

#--------------------------#
sub cbTime_Change
#--------------------------#
{
  # Local variables
  my $selFunc = $win->cbTime->GetCurSel();
  # Possibles value are 0 = 'Anytime to Anytime', 1 = 'Unixtime to Anytime', 2 = 'ChromeTime to Anytime',
  # 3 = 'LDAPTime to Anytime', 4 = 'Anytime to Unixtime', 5 = 'Date to Weekday', 6 = 'Time difference',
  # 7 = 'Add time', 8 = 'Substract time'
  
  # Show List 2 ?
  if ($selFunc == 6) { &showList2(); }
  else               { &hideList2(); }
  
  # Show input format options if input is a date
  if ($selFunc == 0 or $selFunc > 3) {
    $win->lblDTFormat->Show();
    $win->cbDTFormat->Show();
    $win->cbDTFormat->SetCurSel(0);
    $win->cbDTFormat->SetFocus();
    $win->btnGuess->Show();
  } else {
    $win->lblDTFormat->Hide();
    $win->cbDTFormat->Hide();
    $win->btnGuess->Hide();
  }
  
  # Show output format options if output is a date
  if ($selFunc < 4 or $selFunc == 7 or $selFunc == 8) {
    $win->rbLocaltime->Show();
    $win->rbGMTime->Show();
    $win->rbOtherTZ->Show();
    $win->cbOtherTZ->Show();
    if ($win->rbOtherTZ->Checked()) { $win->cbOtherTZ->Enable(); }
  } else {
    $win->rbLocaltime->Hide();
    $win->rbGMTime->Hide();
    $win->rbOtherTZ->Hide();
    $win->cbOtherTZ->Hide();
  }
  
  # Show single date
  if ($selFunc == 6) {
    $win->chSingleDate->Show();
    $win->dtTimeDiffDate->Show();
    $win->dtTimeDiffTime->Show();

  } else {
    $win->chSingleDate->Hide();
    $win->dtTimeDiffDate->Hide();
    $win->dtTimeDiffTime->Hide();
  }
  
  # Show date and time UpAndDown controls
  if ($selFunc == 7 or $selFunc == 8) {
    $win->lblAddDT->Show();
    $win->tfValAddDT->Show();
    $win->cbTypeValAddDT->Show();
  } else {
    $win->lblAddDT->Hide();
    $win->tfValAddDT->Hide();
    $win->cbTypeValAddDT->Hide();
  }
  
  &isProcessReady(0);

}  #--- End cbTime_Change

#--------------------------#
sub rbLocaltime_Click
#--------------------------#
{
  $win->cbOtherTZ->Disable();
  &isProcessReady(0);

}  #--- End rbLocaltime_Click

#--------------------------#
sub rbGMTime_Click
#--------------------------#
{
  $win->cbOtherTZ->Disable();
  &isProcessReady(0);

}  #--- End rbGMTime_Click

#--------------------------#
sub rbOtherTZ_Click
#--------------------------#
{
  $win->cbOtherTZ->Enable();
  $win->cbOtherTZ->SetCurSel(0);
  &isProcessReady(0);

}  #--- End rbOtherTZ_Click

#--------------------------#
sub chSingleDate_Click
#--------------------------#
{
  if ($win->chSingleDate->Checked()) { &hideList2(); } # Hide List 2
  else                               { &showList2(); } # Show List 2
  
  &isProcessReady(0);

}  #--- End chSingleDate_Click

#--------------------------#
sub cbUtils_Change
#--------------------------#
{
  # Local variables
  my $selFunc  = $win->cbUtils->GetCurSel();
  # Possibles value are 0 = 'NSLookup', 1 = 'CIDR to IP Range', 2 = 'IP Range to CIDR', 3 = 'CIDR to IP list',
  # 4 = 'IP to Arpa', 5 = 'Arpa to IP', 6 = 'Resolve MAC Address', 7 = 'Resolve IPv4 GeoIP', 8 = 'Resolve ISP',
  # 9 = 'Resolve User-agent', 10 = 'Credit Card to issuing company', 11 = 'Custom functions'
  
  # Hide List 2
  &hideList2();
  
  # Show GeoIP options
  if   ($selFunc == 7) { $win->cbGeoIPOpt->Show(); $win->chGeoIPAddHeaders->Show(); }
  else                 { $win->cbGeoIPOpt->Hide(); $win->chGeoIPAddHeaders->Hide(); }
  
  # Show User-Agent options
  if   ($selFunc == 9) { $win->cbUAOpt->Show(); $win->chUAAddHeaders->Show(); }
  else                 { $win->cbUAOpt->Hide(); $win->chUAAddHeaders->Hide(); }
  
  # Show Credit Card to Issuing Company options
  if   ($selFunc == 10) { $win->rbIINLocalDB->Show(); $win->rbBinlist->Show(); }
  else                  { $win->rbIINLocalDB->Hide(); $win->rbBinlist->Hide(); }
  
  # Custom Functions options
  if   ($selFunc == 11) {
    $win->cbCFLists->Show();
    $win->btnCFAdd->Show();
    $win->btnCFRem->Show();
    $win->btnCFEdit->Show();
    $win->btnCFNew->Show();
  } else {
    $win->cbCFLists->Hide();
    $win->btnCFAdd->Hide();
    $win->btnCFRem->Hide();
    $win->btnCFEdit->Hide();
    $win->btnCFNew->Hide();
    $win->chCFMatchCase->Hide();
    $win->lblCFTitle->Hide();
    $win->tfCFTitle->Hide();
    $win->btnCFSave->Hide();
    $win->btnCFCancel->Hide();
  }
  
  &isProcessReady(0);

}  #--- End cbUtils_Change

#--------------------------#
sub rbIINLocalDB_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End rbIINLocalDB_Click

#--------------------------#
sub rbBinlist_Click
#--------------------------#
{
  &isProcessReady(0);

}  #--- End rbBinlist_Click

#--------------------------#
sub btnList1File_Click
#--------------------------#
{
  # Show OpenFile dialog window
  my $file = Win32::GUI::GetOpenFileName( -owner         => $win                              ,
                                          -title         => $STR{'selectFile'}                ,
                                          -filter        => ["$STR{'text'} (*.txt)", "*.txt"] ,
                                          -defaultfilter => 0                                 ,
                                          -filemustexist => 1                                 ,
                                          -explorer      => 1                                 , );

  # Text format only
  if ($file and -T $file) {
    $win->tfList1->Enable();
    $win->tfList1->Text('');
    $win->tfList1->Text("$STR{'useFile'}: \"$file\"");
    &tfList1_Change();
  } elsif ($file) { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
  
  &isProcessReady(0);

}  #--- End btnList1File_Click

#--------------------------#
sub btnList1Del_Click
#--------------------------#
{
  $win->tfList1->Text('');
  $win->tfList1->Enable();
  $win->lblList1Count->Text(0);
  &isProcessReady(0);

}  #--- End btnList1Del_Click

#--------------------------#
sub tfList1_Change
#--------------------------#
{
  # Count items
  my $count = 0;
  my $first = $win->tfList1->GetLine(0);
  my $file;
  
  # Items are in a file ?
  if ($first =~ /^$STR{'useFile'}: \"([^\"]+)\"$/) { $file = $1; }
  if ($file and -T $file) {
    # Items are in a file
    if (open my $fh, '<', $file) {
      while (sysread $fh, my $buffer, 4096) { $count += ($buffer =~ tr/\n//); }
      close($fh);
    } else { Win32::GUI::MessageBox($win, "$STR{'errorReading'}: ".$!, $STR{'error'}, 0x40010); }
  # Items are in the textfield
  } else { $count = $win->tfList1->GetLineCount(); }

  # Update counter
  if ($count == 1 and $win->tfList1->GetLine(0) eq '') { $count = 0; }
  $win->lblList1Count->Text($count);
  
  # If New Custom Function
  if ($win->tfCFTitle->IsVisible()) { &validNewFunc(); }

  &isProcessReady(0);

}  #--- End tfList1_Change

#--------------------------#
sub tfList1_MaxText
#--------------------------#
{
  # Popup warning
  Win32::GUI::MessageBox($win, $STR{'maxSizeReached'}, $STR{'warning'}, 0x40030);
  
}  #--- End tfList1_MaxText

#--------------------------#
sub btnList2File_Click
#--------------------------#
{
  # Show OpenFile dialog window
  my $file = Win32::GUI::GetOpenFileName( -owner         => $win                              ,
                                          -title         => $STR{'selectFile'}                ,
                                          -filter        => ["$STR{'text'} (*.txt)", "*.txt"] ,
                                          -defaultfilter => 0                                 ,
                                          -filemustexist => 1                                 ,
                                          -explorer      => 1                                 , );

  # Text format only
  if ($file and -T $file) {
    $win->tfList2->Enable();
    $win->tfList2->Text('');
    $win->tfList2->Text("$STR{'useFile'}: \"$file\"");
    &tfList2_Change();
  } elsif ($file) { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
  
  &isProcessReady(0);

}  #--- End btnList2File_Click

#--------------------------#
sub btnList2Del_Click
#--------------------------#
{
  $win->tfList2->Text('');
  $win->tfList2->Enable();
  $win->lblList2Count->Text(0);
  &isProcessReady(0);

}  #--- End btnList2Del_Click

#--------------------------#
sub tfList2_Change
#--------------------------#
{
  # Count items
  my $count = 0;
  my $first = $win->tfList2->GetLine(0);
  my $file;
  
  # Items are in a file ?
  if ($first =~ /^$STR{'useFile'}: \"([^\"]+)\"$/) { $file = $1; }
  if ($file and -T $file) {
    # Items are in a file
    if (open my $fh, '<', $file) {
      while (sysread $fh, my $buffer, 4096) { $count += ($buffer =~ tr/\n//); }
      close($fh);
    } else { Win32::GUI::MessageBox($win, "$STR{'errorReading'}: ".$!, $STR{'error'}, 0x40010); }
  # Items are in the textfield
  } else { $count = $win->tfList2->GetLineCount(); }

  # Update counter
  if ($count == 1 and $win->tfList2->GetLine(0) eq '') { $count = 0; }
  $win->lblList2Count->Text($count);
  
  # If New Custom Function
  if ($win->tfCFTitle->IsVisible()) { &validNewFunc(); }
  
  &isProcessReady(0);

}  #--- End tfList2_Change

#--------------------------#
sub tfList2_MaxText
#--------------------------#
{
  # Popup warning
  Win32::GUI::MessageBox($win, $STR{'maxSizeReached'}, $STR{'warning'}, 0x40030);
  
}  #--- End tfList2_MaxText

#--------------------------#
sub btnList3Open_Click
#--------------------------#
{
  # Local variables
  my $file = $win->tfList3->GetLine(0);
  if ($file =~ /^\"([^\"]+)\"$/) { $file = $1; }
  
  # Open file with default program
  if ($file and -T $file) {
    $win->ShellExecute('open', $file,'','',1) or Win32::GUI::MessageBox($win, "$STR{'errorOpening'}: ".Win32::FormatMessage(Win32::GetLastError()), $STR{'error'}, 0x40010);
  }

}  #--- End btnList3Open_Click

#--------------------------#
# CTRL + A (Select All)
#--------------------------#
sub tfList1_GotFocus  { $LISTNO = 1; }
sub tfList2_GotFocus  { $LISTNO = 2; }
sub tfList3_GotFocus  { $LISTNO = 3; }
sub tfList1_LostFocus { $LISTNO = 0; }
sub tfList2_LostFocus { $LISTNO = 0; }
sub tfList3_LostFocus { $LISTNO = 0; }

#--- End tfList3_GotFocus

#--------------------------#
sub selectAll_Click
#--------------------------#
{
  if    ($LISTNO == 1) { $win->tfList1->SelectAll(); }
  elsif ($LISTNO == 2) { $win->tfList2->SelectAll(); }
  elsif ($LISTNO == 3) { $win->tfList3->SelectAll(); }
  
}  #--- End selectAll_Click

#--------------------------#
sub lblNotReady_Click
#--------------------------#
{
  &isProcessReady(1);

}  #--- End lblNotReady_Click

#--------------------------#
sub isProcessReady
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  my $nextStep;
  
  # Status of List1 and List2
  my $nbrList1 = $win->lblList1Count->Text();
  my $nbrList2 = $win->lblList2Count->Text();
  
  # Every function require items in List1, except some functions in Lists
  if (!$nbrList1 and $win->Tab->SelectedItem() != 0) { $nextStep = $STR{'insertList1'}; }
  else {
    # Lists tab selected
    if ($win->Tab->SelectedItem() == 0) {
      my $selFunc = $win->cbLists->GetCurSel();
      # Possibles value are 0 = 'No duplicate', 1 = 'Only duplicates', 2 = 'Count items', 3 = 'Count characters',
      # 4 = 'L1-L2', 5 = 'Column to row', 6 = 'Row to column', 7 = 'List to regex', 8 = 'Concat', 9 = 'Split strings',
      # 10 = 'Split and extract', 11 = 'Merge lines', 12 = 'Replace', 13 = 'Reverse string', 14 = 'Lowercase',
      # 15 = 'Uppercase', 16 = 'Add line number'
      
      # Some functions require items in List 1 or in List 2
      if ($selFunc == 1 or $selFunc == 4 or $selFunc == 8) {
        if (!$nbrList1 and !$nbrList2) { $nextStep = $STR{'insertLists'}; }
      # Other require items in List 1 only
      } elsif (!$nbrList1) { $nextStep = $STR{'insertList1'}; }
        
      # Some functions require a value in With textfield
      if (($selFunc == 9 or $selFunc == 10 or $selFunc == 11) and !$win->tfWith->Text()) {
        $nextStep = $STR{'insertWith'};
      }
      
      # Replace function require value in Replace textfield
      if ($selFunc == 12 and !$win->tfReplace->Text()) {
        $nextStep = $STR{'insertReplace'};
      } elsif ($selFunc == 12 and ($win->chRegex->Checked() or $win->chEval->Checked())) { # Valid regex
        # Regex is valid ?
        if ($win->chRegex->Checked()) {
          if ($win->tfReplace->Text()) {
            my ($status, $msg) = &validRegex($win->tfReplace->Text());
            if ($status and $status == 1) {
              $nextStep = $STR{'errRegex'} . ' ' . $STR{'errRegexReplace'} . ":\n\n";
              if ($msg) { $nextStep .= $msg; }
            }
          }
          # Replacement expression is valid ?
          if ($win->tfReplBy->Text()) {
            my ($status, $msg) = &validReplacement;
            if ($status and $status == 1) {
              $nextStep = $STR{'errBy'} . ' ' . $STR{'errRegexReplaceBy'} . ":\n\n";
              if ($msg) { $nextStep .= $msg; }
            }
          }
        }
      }
    
    # Sorting tab selected
    } elsif ($win->Tab->SelectedItem() == 1) {
      # No special condition for now
      
    # Conversion tab selected
    } elsif ($win->Tab->SelectedItem() == 2) {
      # No special condition for now
      
    # Time tab selected
    } elsif ($win->Tab->SelectedItem() == 3) {
      my $selFunc = $win->cbTime->GetCurSel();
      # Possibles value are 0 = 'Anytime to Anytime', 1 = 'Unixtime to Anytime', 2 = 'ChromeTime to Anytime',
      # 3 = 'LDAPTime to Anytime', 4 = 'Anytime to Unixtime', 5 = 'Date to Weekday', 6 = 'Time difference',
      # 7 = 'Add time', 8 = 'Substract time'
      
      # 'Time difference' can be used with a single date or with items in List 2
      # If so, number of items in List 1 and List 2 must be the same
      if ($selFunc == 6 and !$win->chSingleDate->Checked()) {
        my $refList1  = &enumItems(\$win->tfList1);
        my $refList2  = &enumItems(\$win->tfList2);
        if (scalar(@{$refList1}) != scalar(@{$refList2})) {
          $nextStep = $STR{'insertSameNbr'};
        }
      }
      
    # Utils tab selected
    } elsif ($win->Tab->SelectedItem() == 4) {
      my $selFunc = $win->cbUtils->GetCurSel();
      # Possibles value are 0 = 'NSLookup', 1 = 'CIDR to IP Range', 2 = 'IP Range to CIDR', 3 = 'CIDR to IP list',
      # 4 = 'IP to Arpa', 5 = 'Arpa to IP', 6 = 'Resolve MAC Address', 7 = 'Resolve IPv4 GeoIP', 8 = 'Resolve ISP',
      # 9 = 'Resolve User-agent', 10 = 'Credit Card to issuing company', 11 = 'Custom functions'
      
      # 'Resolve MAC Address' requires MACOUI database
      if    ($selFunc == 6) {
        my $MACOUIDB = $winConfig->tfMACOUIDB->Text();
        if (!-e $MACOUIDB) { $nextStep = $STR{'insertMACOUI'}; }
      }
      
      # 'Resolve IPv4 GeoIP' requires GeoIP database
      elsif ($selFunc == 7) {
        my $GeoIPDB = $winConfig->tfGeoIPDB->Text();
        if (!-e $GeoIPDB) { $nextStep = $STR{'insertGeoIP'}; }
      }
      
      # 'Resolve ISP' requires XL-Whois database
      elsif ($selFunc == 8) {
        my $XLWHOISDBFile = $winConfig->tfXLWHOISDB->Text();
        if (!-e $XLWHOISDBFile) { $nextStep = $STR{'insertXLWhois'}; }
      }
      
      # 'Credit Card to issuing company' requires IIN database if local option is checked
      elsif ($selFunc == 10 and $win->rbIINLocalDB->Checked()) {
        my $IINFile = $winConfig->tfIINDB->Text();
        if (!-e $IINFile) { $nextStep = $STR{'insertIIN'}; }
      }
      
      # In 'Custom functions', a function must be selected
      elsif ($selFunc == 11 and $win->cbCFLists->GetCurSel() == 0) {
        $nextStep = $STR{'selectFunc'};
      }
    }
  }

  # Return an error message or enable the button
  if ($nextStep) {
    $win->btnGuess->Disable();
    $win->btnProcess->Disable();
    $win->lblNotReady->Show();
    if ($confirm) { Win32::GUI::MessageBox($win, "$STR{'notReady'} ?\n\n$STR{'nextStep'}: $nextStep", $STR{'notReady'}, 0x40040); }
  } else {
    if ($win->cbCFLists->IsEnabled()) { $win->btnProcess->Enable(); }
    $win->lblNotReady->Hide();
    $win->btnGuess->Enable();
  }

}  #--- End isProcessReady

#--------------------------#
sub btnProcess_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010);
  } else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /, $_[0]))[0];
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
        threads->exit();
      };
      
      # Local variables
      my $refList3;
      
      # Reset list 3
      $win->tfList3->Text('');
      $win->lblList3Count->Text(0);
      
      # Gather items
      my $refList1  = &enumItems(\$win->tfList1);
      my $refList2  = &enumItems(\$win->tfList2);
      #my $nbrItems1 = scalar(@{$refList1});
      #my $nbrItems2 = scalar(@{$refList2});
      
      # Show progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Show();
      $win->pb->Show();
      $win->lblPbCount->Show();
      $win->lblPbCurr->Text($STR{'startingProcess'}.'...');
      $win->btnProcess->Hide();
      $win->btnStop->Show();
      $win->ChangeCursor($HOURGLASS);
      
      # Lists tab selected
      if ($win->Tab->SelectedItem() == 0) {
        my $selFunc = $win->cbLists->GetCurSel();
        # Possibles value are 0 = 'No duplicate', 1 = 'Only duplicates', 2 = 'Count items', 3 = 'Count characters',
        # 4 = 'L1-L2', 5 = 'Column to row', 6 = 'Row to column', 7 = 'List to regex', 8 = 'Concat', 9 = 'Split strings',
        # 10 = 'Split and extract', 11 = 'Merge lines', 12 = 'Replace', 13 = 'Reverse string', 14 = 'Lowercase',
        # 15 = 'Uppercase', 16 = 'Add line number'
        if    ($selFunc ==  0) { $refList3 = &noDuplicates($refList1, $refList2);    }
        elsif ($selFunc ==  1) { $refList3 = &onlyDuplicates($refList1, $refList2);  }
        elsif ($selFunc ==  2) { $refList3 = &countDuplicates($refList1, $refList2); }
        elsif ($selFunc ==  3) { $refList3 = &countChars($refList1, $refList2);      }
        elsif ($selFunc ==  4) { $refList3 = &L1_less_L2($refList1, $refList2);      }
        elsif ($selFunc ==  5) { $refList3 = &col2row($refList1, $refList2);         }
        elsif ($selFunc ==  6) { $refList3 = &row2col($refList1, $refList2);         }
        elsif ($selFunc ==  7) { $refList3 = &list2regex($refList1, $refList2);      }
        elsif ($selFunc ==  8) { $refList3 = &concatStr($refList1, $refList2);       }
        elsif ($selFunc ==  9) { $refList3 = &splitStr($refList1, $refList2);        }
        elsif ($selFunc == 10) { $refList3 = &splitExtract($refList1, $refList2);    }
        elsif ($selFunc == 11) { $refList3 = &mergeLines($refList1, $refList2);      }
        elsif ($selFunc == 12) { $refList3 = &replace($refList1, $refList2);         }
        elsif ($selFunc == 13) { $refList3 = &reverseStr($refList1, $refList2);      }
        elsif ($selFunc == 14) { $refList3 = &lowercase($refList1, $refList2);       }
        elsif ($selFunc == 15) { $refList3 = &uppercase($refList1, $refList2);       }
        elsif ($selFunc == 16) { $refList3 = &addLineNumber($refList1, $refList2);   }

      # Sorting tab selected
      } elsif ($win->Tab->SelectedItem() == 1) {
        $refList3 = &sortingTabFunc($refList1, $refList2);
        
      # Conversion tab selected
      } elsif ($win->Tab->SelectedItem() == 2) {
        $refList3 = &conversionTabFunc($refList1, $refList2);
        
      # Time tab selected
      } elsif ($win->Tab->SelectedItem() == 3) {
        $refList3 = &timeTabFunc($refList1, $refList2);
        
      # Utils tab selected
      } elsif ($win->Tab->SelectedItem() == 4) {
        my $selFunc = $win->cbUtils->GetCurSel();
        $refList3 = &utilsTabFunc($refList1, $refList2);
      }

      # Progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Hide();
      $win->pb->Hide();
      $win->lblPbCount->Hide();
      $win->btnProcess->Show();
      $win->btnStop->Hide();      
      $win->ChangeCursor($ARROW);
      
      # Write resulting list
      &writeResults($refList3);
      
    });
  }

}  #--- End btnProcess_Click

#--------------------------#
sub btnStop_Click
#--------------------------#
{
  # Stop requests
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { $THR_PROCESS->kill('KILL')->detach(); }
  return(1);

}  #--- End btnStop_Click

#--------------------------#
sub btnHelp_Click
#--------------------------#
{
  if (-e $HELP_FILE) {
    # Open the page
    $win->ShellExecute('open', $HELP_FILE,'','',1);
  } else {
    Win32::GUI::MessageBox($win, $STR{'errDoc'}, $STR{'error'}, 0x40010);
  }  

}  #--- End btnHelp_Click

#--------------------------#
sub btnAbout_Click
#--------------------------#
{
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new( -name        => 'winAbout'                ,
                                              -parent      => $win                      ,
                                              -text        => $STR{'about'}.' XL-Tools' ,
                                              -pos         => [$winPosX, $winPosY]      ,
                                              -size        => [520, 170]                ,
                                              -background  => [255, 255, 255]           ,
                                              -hasmaximize => 0                         ,
                                              -hasminimize => 1                         ,
                                              -helpbutton  => 0                         ,
                                              -resizable   => 0                         ,
                                              -dialogui    => 1                         , );
  $winAbout->SetIcon($winICO);
  
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  5]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $logo128Bmp             , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font10                 ,
                        -foreground  => [0  , 0  , 102]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$STR{'version'}:\n$STR{'website'}:\n$STR{'author'}:\n$STR{'translatedBy'}:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font10                 ,
                        -foreground  => [185, 154,   0]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)\n$STR{'translatorName'}", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font10                 ,
                        -foreground  => [0  , 0  , 102]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2015-2016 Alain Rioux', );
  
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);

}  #--- End btnAbout_Click

#--------------------------#
sub enumItems
#--------------------------#
{
  # Local variables
  my $refList = shift;
  my @items;
  
  # Enumerate items
  my $first = $$refList->GetLine(0);
  my $file;
  if ($first =~ /^$STR{'useFile'}: \"([^\"]+)\"$/) { $file = $1; }
  if ($file and -T $file) {
    # Items are in a file
    if (open my $fh, '<', $file) {
      while (<$fh>) { chomp($_); push(@items, $_); }
      close($fh);
    } else { Win32::GUI::MessageBox($win, "$STR{'errorReading'}: ".$!, $STR{'error'}, 0x40010); }
  } else {
    # Items are in the textfield
    if (length($$refList->GetLine(0)) == 0 and !$$refList->GetLine(1)) { return(\@items); }
    for (my $i = 0; $i < $$refList->GetLineCount(); $i++) {
      my $item = $$refList->GetLine($i);
      chomp($item);
      push(@items, $item);
    }
  }
  
  return(\@items);
  
}  #--- End enumItems

#--------------------------#
sub writeResults
#--------------------------#
{
  # Local variables
  my $refItems = shift;
  my $nbrItems = 0;
  
  if ($$refItems) {
    my $nbrChars = length($$refItems);
    # Max of chars reached or exceeded
    if ($nbrChars >= $win->tfList3->MaxLength()) {
      # Ask to write results in a file
      my $answer = Win32::GUI::MessageBox($win, $STR{'saveToFileMsg'}, $STR{'saveToFile'}, 0x40023);
      
      # Cancel (2)
      if ($answer == 2) { return; }
      
      # No (7), write truncated text
      elsif ($answer == 7) { $win->tfList3->Text($$refItems); }
      
      # Yes
      else {
        # Extract directory of the input file
        my $first  = $win->tfList1->GetLine(0);
        my $resDir = '';
        if ($first =~ /^$STR{'useFile'}: \"([^\"]+)\"$/) { $resDir = $1; }
        if ($resDir) {
          my @dir = split(/\\/, $resDir);
          pop(@dir);
          $resDir   = join("\\", @dir);
        }
        # Show OpenFile dialog window
        my $file = Win32::GUI::GetSaveFileName( -title              => $STR{'saveToFile'}.'. '.$STR{'selectFile'} ,
                                                -directory          => $resDir                                    ,
                                                -file               => 'temp.txt'                                 ,
                                                -defaultextension   => 'txt'                                      ,
                                                -filter             => ["$STR{'text'} (*.txt)", "*.txt"]          ,
                                                -defaultfilter      => 0                                          ,
                                                -createprompt       => 1                                          , );
        if ($file) {
          # Copy results in the file
          if (open my $fh, '>', $file) {
            my @tab = split(/\r\n/, $$refItems);
            foreach (@tab) { print $fh "$_\n"; $nbrItems++; }
            close($fh);
            $win->tfList3->Text("\"$file\"");
          } else { Win32::GUI::MessageBox($win, "$STR{'errorWriting'}: ".$!, $STR{'error'}, 0x40010); }
        }
      }
    } else {
      $win->tfList3->Text($$refItems);
      $nbrItems = $win->tfList3->GetLineCount() - 1;
    }
  }
  
  $win->lblList3Count->Text($nbrItems);
  
}  #--- End writeResults

#--------------------------#
sub noDuplicates
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my %items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    if ($item) {
      my $newItem = $item; # Copy of the item
      # Match case
      if (!$win->chMatchCase->Checked()) { $newItem = lc($newItem); }
      # Keep item if doesn't exist already
      if (length($newItem) != 0 and !exists($items{$newItem})) { $items{$newItem} = $item; }
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (sort values %items) { if ($_) { $itemsRes .= "$_\r\n"; } }
  
  return(\$itemsRes);  
  
}  #--- End noDuplicates

#--------------------------#
sub onlyDuplicates
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my %items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    if ($item) {
      my $newItem = $item; # Copy of the item
      # Match case
      if (!$win->chMatchCase->Checked()) { $newItem = lc($newItem); }
      # Keep item
      if (length($newItem) != 0) {
        if    (!exists($items{$newItem})) { $items{$newItem} = '&1&'; }
        elsif ($items{$newItem} eq '&1&') { $items{$newItem} = $item; }
      }
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (keys %items) { if ($_ and $items{$_} ne '&1&') { $itemsRes .= "$_\r\n"; } }
  return(\$itemsRes);  
  
}  #--- End noDuplicates

#--------------------------#
sub countDuplicates
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my %items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    if ($item) {
      my $newItem = $item; # Copy of the item
      # Match case
      if (!$win->chMatchCase->Checked()) { $newItem = lc($newItem); }
      # Keep item if doesn't exist already
      if (length($newItem) != 0) {
        if (exists($items{$newItem})) {
          my ($item, $nbr) = split(/\|\|\|/, $items{$newItem});
          $nbr++;
          $items{$newItem} = "$item\|\|\|$nbr";
        } else { $items{$newItem} = "$item\|\|\|1"; }
      }
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (sort values %items) {
    if ($_) {
      $itemsRes .= $_;
      $itemsRes =~ s/\|\|\|/\t/;
    }
    $itemsRes .= "\r\n";
  }
  
  return(\$itemsRes);  
  
}  #--- End countDuplicates

#--------------------------#
sub countChars
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("$curr / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    my $length = length($item);
    push(@items, $length);

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End countChars

#--------------------------#
sub L1_less_L2
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  my $nbrItems = scalar(@{$refList1}) + scalar(@{$refList2});
  my $curr     = 0;
  my %items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of List 1
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    if ($item) {
      my $newItem = $item; # Copy of the item
      # Match case
      if (!$win->chMatchCase->Checked()) { $newItem = lc($newItem); }
      # Keep item if doesn't exist already
      if (length($newItem) != 0 and !exists($items{$newItem})) { $items{$newItem} = $item; }
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }
  
  # Loop on each item of List 2
  foreach my $item (@{$refList2}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    if ($item) {
      my $newItem = $item; # Copy of the item
      # Match case
      if (!$win->chMatchCase->Checked()) { $newItem = lc($newItem); }
      # If item exists already, delete it
      if (exists($items{$newItem}) and (length($newItem) != 0)) { delete($items{$newItem}); }
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (sort values %items) { if ($_) { $itemsRes .= "$_\r\n"; } }
  
  return(\$itemsRes);  
  
}  #--- End L1_less_L2

#--------------------------#
sub col2row
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $separator = $win->tfWith->Text();
  my $nbrItems  = scalar(@{$refList1});
  my $curr      = 0;
  my $itemsRes;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    $itemsRes .= $item;
    if ($separator) { $itemsRes .= $separator }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  if ($separator) { $itemsRes =~ s/$separator$//; }
  $itemsRes .= "\r\n";
  
  return(\$itemsRes);  
  
}  #--- End col2row

#--------------------------#
sub row2col
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $separator = quotemeta($win->tfWith->Text());
  my $nbrItems  = scalar(@{$refList1});
  my $curr      = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    my @temp;
    $item =~ s/[\r\n]//g;  # Remove any line break
    if ($item =~ /$separator/) { @temp = split(/$separator/, $item); }
    else                       { push(@temp, $item);                 }
    push(@items, @temp);

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End row2col

#--------------------------#
sub list2regex
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems  = scalar(@{$refList1});
  my $curr      = 0;
  my $itemsRes;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    if ($item) { $itemsRes .= quotemeta($item)."\|"; }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  while ($itemsRes =~ /(?:[^\\]\|$)/) { chop($itemsRes); }
  $itemsRes .= "\r\n";
  
  return(\$itemsRes);  
  
}  #--- End list2regex

#--------------------------#
sub concatStr
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  my $nbrItems = scalar(@{$refList1}) >= scalar(@{$refList2}) ? scalar(@{$refList1}) : scalar(@{$refList2});
  my $expr     = $win->tfWith->Text();
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of two lists at the same time
  for (my $i = 0; $i < $nbrItems; $i++) {
    my $resItem = '';
    if (defined($$refList1[$i])) {
      $$refList1[$i] =~ s/[\r\n]//g;
      $resItem .= $$refList1[$i];
    }
    if ($expr) { $resItem .= $expr; }
    if (defined($$refList2[$i])) {
      $$refList2[$i] =~ s/[\r\n]//g;
      $resItem .= $$refList2[$i];
    }
    if ($resItem ne $expr) { push(@items, $resItem);     }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End concatStr

#--------------------------#
sub splitStr
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $expr     = $win->tfWith->Text();
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  if (!$win->chRegex->Checked()) { $expr = quotemeta($expr); }
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    my $resItem = '';
    my @fields = split(/$expr/, $item);
    foreach (@fields) { $resItem .= "$_\t"; }
    chop($resItem);
    push(@items, $resItem);

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);
  
}  #--- End splitStr

#--------------------------#
sub splitExtract
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $expr     = $win->tfWith->Text();
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my %cols;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach (split(/,[ ]?/, $win->tfColumnsNo->Text())) { $cols{$_} = 1; }
  if (!$win->chRegex->Checked()) { $expr = quotemeta($expr); }
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    my $resItem = '';
    my @fields = split(/$expr/, $item, -1);
    my $currCol = 0;
    foreach (@fields) {
      $currCol++;
      if (exists($cols{$currCol})) { $resItem .= "$_\t"; }
    }
    if (exists($cols{'-1'})) { $resItem .= pop(@fields)."\t"; } # Last column no matter how many columns there are
    chop($resItem);
    push(@items, $resItem);

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);
  
}  #--- End splitExtract

#--------------------------#
sub mergeLines
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $splitBy  = $win->tfWith->Text();
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  my $count   = 0;
  my $resItem = '';
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    $resItem .= $item . "\t";
    $count++;
    if ($count == $splitBy) {
      chop($resItem);
      push(@items, $resItem);
      $count = 0;
      $resItem = '';
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End mergeLines

#--------------------------#
sub replace
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $srcExpr       = $win->tfReplace->Text();
  my $srcExprCase   = $win->chMatchCase->Checked();
  my $srcExprRegex  = $win->chRegex->Checked();
  my $dstExpr       = $win->tfReplBy->Text();
  my $dstExprEval   = $win->chEval->Checked();
  
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Escape replace expresion if not regex
  if    (!$srcExprRegex)                      { $srcExpr = quotemeta($srcExpr);  }
  elsif ($dstExpr =~ /\$1/ and !$dstExprEval) { $dstExpr = '"' . $dstExpr . '"'; }
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    if (($srcExprCase and $item =~ /$srcExpr/) or (!$srcExprCase and $item =~ /$srcExpr/i)) {
      if ($srcExprCase) {
        if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
          $item =~ s/$srcExpr/$dstExpr/eeg;
        } else { $item =~ s/$srcExpr/$dstExpr/g; } # Keyword
      } else {
        if ($srcExprRegex and ($dstExprEval or $dstExpr =~ /\$1/)) { # Expression must be evaluated
          $item =~ s/$srcExpr/$dstExpr/eegi;
        } else { $item =~ s/$srcExpr/$dstExpr/gi; } # Keyword
      }
    }
    push(@items, $item);

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);
  
}  #--- End replace

#--------------------------#
sub reverseStr
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    push(@items, scalar reverse($item));

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End reverseStr

#--------------------------#
sub lowercase
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    
    # Lowercase all characters
    if    ($win->rbAll->Checked())       { push(@items, lc($item));      }
    # Lowercase first character only
    elsif ($win->rbFirstOnly->Checked()) { push(@items, lcfirst($item)); }
    # Lowercase first letter of each word
    else {
      my $newItem;
      my @words = split(/ /, $item);
      foreach (@words) {
        $newItem .= lcfirst($_).' ';
      }
      chop($newItem);
      push(@items, $newItem);
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End lowercase

#--------------------------#
sub uppercase
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    
    # Uppercase all characters
    if    ($win->rbAll->Checked())       { push(@items, uc($item));      }
    # Uppercase first character only
    elsif ($win->rbFirstOnly->Checked()) { push(@items, ucfirst($item)); }
    # Uppercase first letter of each word
    else {
      my $newItem;
      my @words = split(/ /, $item);
      foreach (@words) {
        $newItem .= ucfirst($_).' ';
      }
      chop($newItem);
      push(@items, $newItem);
    }

    # Progress
    $curr++;
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End uppercase

#--------------------------#
sub addLineNumber
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $curr     = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # Loop on each item of merged list
  foreach my $item (@{$refList1}) {
    $item =~ s/[\r\n]//g;  # Remove any line break
    $curr++;
    push(@items, $curr."\t".$item);

    # Progress
    $win->lblPbCount->Text("$curr / $nbrItems");
    $win->pb->StepIt();
  }

  # Format results
  my $itemsRes;
  foreach (@items) { $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End addLineNumber

#--------------------------#
sub sortingTabFunc
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems = scalar(@{$refList1});
  my $selFunc  = $win->cbSorts->GetCurSel();
  # Possibles value are 0 = 'Alphabetical order', 1 = 'Numerical order', 2 = 'String length', 3 = 'IPv4 Address', 4 = 'Date and time'
  my $order;
  if ($win->rbAsc->Checked()) { $order = 0; } # Ascending
  else                        { $order = 1; } # Descending
  my @items;
  
  # Sort items
  # Alphabetical
  if    (!$selFunc     and !$order) { @items = sort {lc $a cmp lc $b} @{$refList1}; } # Ascending
  elsif (!$selFunc     and  $order) { @items = sort {lc $b cmp lc $a} @{$refList1}; } # Descending
  # Numerical
  elsif ($selFunc == 1 and !$order) { # Ascending
    @items = map $_->[0],
              sort { $a->[1] <=> $b->[1] }
                map  [ $_, /(\d+)/ ], @{$refList1};
  } 
  elsif ($selFunc == 1 and  $order) { # Descending
    @items = map $_->[0],
              sort { $b->[1] <=> $a->[1] }
                map  [ $_, /(\d+)/ ], @{$refList1};
  } 
  # String length
  elsif ($selFunc == 2 and !$order) { @items = sort {length($a) <=> length($b)} @{$refList1}; } # Ascending
  elsif ($selFunc == 2 and  $order) { @items = sort {length($b) <=> length($a)} @{$refList1}; } # Descending
  # IPv4 Address
  elsif ($selFunc == 3 and !$order) { # Ascending
    @items = map substr($_, 4) => sort {$a cmp $b} map pack('C4'
                               => /(\d+)\.(\d+)\.(\d+)\.(\d+)/) . $_
                               => @{$refList1};
  }
  elsif ($selFunc == 3 and  $order) { # Descending
    @items = map substr($_, 4) => sort {$b cmp $a} map pack('C4'
                               => /(\d+)\.(\d+)\.(\d+)\.(\d+)/) . $_
                               => @{$refList1};
  }
  # Date and time
  elsif ($selFunc == 4) {
    my $selFormat = $win->cbDTFormat->GetCurSel();
    # Possibles value are:                                                        #  0 = 'Guess (or variable)...',
    my @formatRE = ('\d+, \d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  1 = 'Tuesday, 08-Feb-2015 14:15:29 GMT',
                    '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2} \w{3} \d{4}' ,     #  2 = 'Thu Feb  3 17:03:55 GMT 2015',
                    '\d+, \d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  3 = 'Tuesday, 08-Feb-99 14:15:29 GMT',
                    '\w{3}, \d{2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  4 = 'Wed, 09 Feb 2015 22:23:32 GMT',
                    '\d{2}\/\w{3}\/\d{4}\:\d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}' ,     #  5 = '03/Feb/2015:17:03:55 -0700',
                    '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}'  ,     #  6 = '2015-02-03 14:15:29 -0100',
                    '\d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}'         ,     #  7 = '08-Feb-2015 14:15:29 GMT',
                    '\d{2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}'           ,     #  8 = '09 Feb 2015 22:23:32 GMT',
                    '\d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}'         ,     #  9 = '08-Feb-99 14:15:29 GMT',
                    '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2}'             ,     # 10 = 'Thu Feb  3 00:00:00 2015',
                    '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2}'               ,     # 11 = '2015-02-03 14:15:29',
                    '\d{2}\/\d{2}\/\d{4} \d{2}\:\d{2}\:\d{2}'               ,     # 12 = '03/02/2015 14:15:29',
                    '\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}'               ,     # 13 = '2015-02-03T14:15:29',
                    '\d{2}\-\d{2}\-\d{2} +\d{2}\:\d{2}\w{2}'                ,     # 14 = '11-15-99  03:52PM',
                    '\w{3} +\d{1,2} +\d{2}\:\d{2}'                          ,     # 15 = 'Feb  3 17:03',
                    '\w{3} +\d{1,2} +\d{4}'                                 ,     # 16 = 'Feb  3  2015',
                    '\d{2}\-\w{3}\-\d{4}'                                   ,     # 17 = '08-Feb-2015',
                    '\d{2}\/\w{3}\/\d{4}'                                   ,     # 18 = '03/Feb/2015',
                    '\d{4}\-\d{2}\-\d{2}'                                   ,     # 19 = '2015-02-03',
                    '\d{8}T\d{6}Z'                                          ,     # 20 = '20150203T141529Z',
                    '\d{2}\-\w{3}\-\d{2}'                                   ,     # 21 = '08-Feb-99',
                    '\d{2} \w{3} \d{4}'                                     ,     # 21 = '09 Feb 2015',
                    '\d{8}'                                                 , );  # 23 = '20150203',
    # Set Regex
    my $regex;
    if ($selFormat == 0) { $regex = join('|', @formatRE);    } # Merge each regex in one
    else                 { $regex = $formatRE[$selFormat-1]; }
    
    if (!$order) { # Ascending
      @items = map $_->[0],
                sort { str2time( $a->[1] ) <=> str2time( $b->[1] ) }
                  map  [ $_, /^($regex)/ ], @{$refList1};
    } else       {  # Descending
      @items = map $_->[0],
                sort { str2time( $b->[1] ) <=> str2time( $a->[1] ) }
                  map  [ $_, /^($regex)/ ], @{$refList1};
    }
  }

  # Format results
  my $itemsRes;
  foreach (@items) { s/[\r\n]//g; $itemsRes .= "$_\r\n"; }
  
  return(\$itemsRes);  
  
}  #--- End sortingTabFunc

#--------------------------#
sub conversionTabFunc
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $nbrItems    = scalar(@{$refList1});
  my $selFunc     = $win->cbConv->GetCurSel();
  my $noResultOpt = $winConfig->rbNoResultOpt2->Checked();
  # Possibles value are 0 = 'Hex to ASCII', 1 = 'ASCII to Hex', 2 = 'Hex to Base10', 3 = 'Base10 to ASCII', 4 = 'URI Decode',
  # 5 = 'URI Encode', 6 = 'HTML Decode', 7 = 'HTML Encode', 8 = 'Base64 to ASCII', 9 = 'ASCII to Base64', 10 = 'SHA1 - Base32 to Base16'
  my $curr = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # 0 = 'Hex to ASCII'
  if ($selFunc == 0) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      $item =~ s/[^0-9a-fA-F]//g; # Remove non hexadecimal
      if ($item) {
        #$item =~ s/(?:0x)?((?:[0-9a-fA-F]{2} ?)+)/pack 'H*', $1/ge;
        my $ascii = hex_to_ascii($item);
           $ascii =~ s/[\x00-\x1F\x80-\xFF]/./g; # Remove non printable characters
        push(@items, $ascii);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 1 = 'ASCII to Hex'
  elsif ($selFunc == 1) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $ascii = ascii_to_hex($item);
        push(@items, $ascii);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 2 = 'Hex to Base10'
  elsif ($selFunc == 2) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      $item =~ s/[^0-9a-fA-F\s]//g;
      if ($item) {
        # Convert string to a array of chars
        my @chars;
        if ($item =~ /\s/) { @chars = split(/\s/    , $item); }
        else               { @chars = split(/(.{1})/, $item); }
        # Keep spaces
        my $newItem = '';
        foreach (@chars) {
          if ($_ =~ /[0-9a-fA-F]+/) { $newItem .= hex($_) . " "; }
        }
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 3 = 'Base10 to ASCII'
  elsif ($selFunc == 3) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my @tab;
        while ($item =~ /(\d{1,3})/) {
          push(@tab, $1);
          my $longLigne = length($item);
          my $long      = length($1);
          my $pos       = index($item, $1);
          my $offset    = $pos+$long;
          $item         = substr($item,$offset,$longLigne-$offset);
        }
  
        my $newItem;
        foreach (@tab) { $newItem .= chr($_).' '; }
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 4 = 'URI Decode'
  elsif ($selFunc == 4) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        $item =~ s/ /\%20/g;
        $item =~ s/\\u([0-9a-fA-F]{4})/%u$1/g;
        my $newItem = unescape($item);
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 5 = 'URI Encode'
  elsif ($selFunc == 5) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem = uri_escape_utf8($item);
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }

  # 6 = 'HTML Decode'
  elsif ($selFunc == 6) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem = decode_entities($item);
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 7 = 'HTML Encode'
  elsif ($selFunc == 7) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem = encode_entities($item);
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 8 = 'Base64 to ASCII'
  elsif ($selFunc == 8) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      $item =~ s/ //g;
      if ($item) {
        my $newItem = MIME::Base64::decode($item);
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 9 = 'ASCII to Base64'
  elsif ($selFunc == 9) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem = MIME::Base64::encode($item);
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 10 = 'SHA1 - Base32 to Base16'
  elsif ($selFunc == 10) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item and $item =~ /^(\w{32})/) {
        my $newItem = uc(unpack('H*', decode_base32($1)));
        push(@items, $newItem);
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }

  # Format results
  my $itemsRes;
  foreach (@items) { if ($_) { $itemsRes .= $_; } $itemsRes .= "\r\n"; }
  
  return(\$itemsRes);
  
}  #--- End conversionTabFunc

#--------------------------#
sub timeTabFunc
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  my $selFunc     = $win->cbTime->GetCurSel();
  my $noResultOpt = $winConfig->rbNoResultOpt2->Checked();
  # Possibles value are 0 = 'Anytime to Anytime', 1 = 'Unixtime to Anytime', 2 = 'ChromeTime to Anytime',
  # 3 = 'LDAPTime to Anytime', 4 = 'Anytime to Unixtime', 5 = 'Date to Weekday', 6 = 'Time difference',
  # 7 = 'Add time', 8 = 'Substract time'
  my $inputFormat;  # Input format
  my $outputTZ;     # Output Timezone
  my $localTZ;
  my $curr = 0;
  my @items;
  
  # Input format
  if ($selFunc == 0 or $selFunc > 3) {
    my $selFormat = $win->cbDTFormat->GetCurSel();
    # Possibles value are:                                                        #  0 = 'Guess (or variable)...',
    my @formatRE = ('\d+, \d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  1 = 'Tuesday, 08-Feb-2015 14:15:29 GMT',
                    '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2} \w{3} \d{4}' ,     #  2 = 'Thu Feb  3 17:03:55 GMT 2015',
                    '\d+, \d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  3 = 'Tuesday, 08-Feb-99 14:15:29 GMT',
                    '\w{3}, \d{2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}'    ,     #  4 = 'Wed, 09 Feb 2015 22:23:32 GMT',
                    '\d{2}\/\w{3}\/\d{4}\:\d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}' ,     #  5 = '03/Feb/2015:17:03:55 -0700',
                    '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}'  ,     #  6 = '2015-02-03 14:15:29 -0100',
                    '\d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}'         ,     #  7 = '08-Feb-2015 14:15:29 GMT',
                    '\d{2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}'           ,     #  8 = '09 Feb 2015 22:23:32 GMT',
                    '\d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}'         ,     #  9 = '08-Feb-99 14:15:29 GMT',
                    '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2}'             ,     # 10 = 'Thu Feb  3 00:00:00 2015',
                    '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2}'               ,     # 11 = '2015-02-03 14:15:29',
                    '\d{2}\/\d{2}\/\d{4} \d{2}\:\d{2}\:\d{2}'               ,     # 12 = '03/02/2015 14:15:29',
                    '\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}'               ,     # 13 = '2015-02-03T14:15:29',
                    '\d{2}\-\d{2}\-\d{2} +\d{2}\:\d{2}\w{2}'                ,     # 14 = '11-15-99  03:52PM',
                    '\w{3} +\d{1,2} +\d{2}\:\d{2}'                          ,     # 15 = 'Feb  3 17:03',
                    '\w{3} +\d{1,2} +\d{4}'                                 ,     # 16 = 'Feb  3  2015',
                    '\d{2}\-\w{3}\-\d{4}'                                   ,     # 17 = '08-Feb-2015',
                    '\d{2}\/\w{3}\/\d{4}'                                   ,     # 18 = '03/Feb/2015',
                    '\d{4}\-\d{2}\-\d{2}'                                   ,     # 19 = '2015-02-03',
                    '\d{8}T\d{6}Z'                                          ,     # 20 = '20150203T141529Z',
                    '\d{2}\-\w{3}\-\d{2}'                                   ,     # 21 = '08-Feb-99',
                    '\d{2} \w{3} \d{4}'                                     ,     # 21 = '09 Feb 2015',
                    '\d{8}'                                                 , );  # 23 = '20150203',
    # Set Regex
    if ($selFormat == 0) { $inputFormat = join('|', @formatRE);    } # Merge each regex in one
    else                 { $inputFormat = $formatRE[$selFormat-1]; }
  }
  
  # Input data
  if ($selFunc < 6 or $selFunc == 7 or $selFunc == 8) { push(@{$refList1}, @{$refList2}); }  # Merge lists
  
  # Output format
  if ($selFunc < 4 or $selFunc == 7 or $selFunc == 8) {
    if    ($win->rbLocaltime->Checked()) { $outputTZ  = DateTime::TimeZone->new(name => 'local'); } # Localtime
    elsif ($win->rbGMTime->Checked()   ) { $outputTZ  = DateTime::TimeZone->new(name => 'UTC');   } # GMTtime
    else  { $outputTZ  = DateTime::TimeZone->new(name => $win->cbOtherTZ->GetString($win->cbOtherTZ->GetCurSel())); } # Other
  }
  
  # Progress
  my $nbrItems = scalar(@{$refList1});
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # 0 = 'Anytime to Anytime'
  if ($selFunc == 0) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        if ($item =~ /($inputFormat)/) {
          if (my $time = str2time($1)) { # Convert to unixtime
            my $dt = DateTime->from_epoch(epoch => $time);
            $dt->set_time_zone($outputTZ);
            push(@items, $dt->strftime('%Y-%m-%d %H:%M:%S %z'));
          } else {
            if ($noResultOpt) { push(@items, $STR{'errorConversion'}); }
            else { push(@items, undef); }
          }
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 1 = 'Unixtime to Anytime'
  elsif ($selFunc == 1) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        if ($item =~ /([0-9]{1,10})[0-9]*$/) {
          my $dt = DateTime->from_epoch(epoch => $1);
          $dt->set_time_zone($outputTZ);
          push(@items, $dt->strftime('%Y-%m-%d %H:%M:%S %z'));
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 2 = 'ChromeTime to Anytime'
  elsif ($selFunc == 2) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        if ($item =~ /([0-9]{17})$/) { # ChromeTime (17 digits) (Webkit : 12883423549317375)
          my $time = ($1/1000000)-11644473600; # Convert to unixtime
          my $dt = DateTime->from_epoch(epoch => $time);
          $dt->set_time_zone($outputTZ);
          push(@items, $dt->strftime('%Y-%m-%d %H:%M:%S %z'));
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 3 = 'LDAPTime to Anytime'
  elsif ($selFunc == 3) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        if ($item =~ /([0-9]{18})$/) { # LDAPTime (18 digits)
          my $time = int($1/10000000)-11644473600; # Convert to unixtime
          my $dt = DateTime->from_epoch(epoch => $time);
          $dt->set_time_zone($outputTZ);
          push(@items, $dt->strftime('%Y-%m-%d %H:%M:%S %z'));
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }

  # 4 = 'Anytime to Unixtime'
  elsif ($selFunc == 4) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        if ($item =~ /($inputFormat)/) {
          if (my $time = str2time($1)) { # Convert to unixtime
            push(@items, $time);
          } else {
            if ($noResultOpt) { push(@items, $STR{'errorConversion'}); }
            else { push(@items, undef); }
          }
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 5 = 'Date to Weekday'
  elsif ($selFunc == 5) {
    my @weekDayName = ($STR{'monday'}, $STR{'tuesday'}, $STR{'wednesday'}, $STR{'thursday'}, $STR{'friday'}, $STR{'saturday'}, $STR{'sunday'});
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        if ($item =~ /($inputFormat)/) {
          if (my $time = str2time($1)) { # Convert to unixtime
            my $dt = DateTime->from_epoch(epoch => $time);
            my $weekDay = $dt->day_of_week();
            push(@items, $weekDayName[$weekDay-1]);
          } else {
            if ($noResultOpt) { push(@items, $STR{'errorConversion'}); }
            else { push(@items, undef); }
          }
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 6 = 'Time difference'
  elsif ($selFunc == 6) {
    my $timeDiff;
    my $dt2;
    my $tzLocal = DateTime::TimeZone->new( name => 'local' );
    # If "Use a single date" option is checked
    if ($win->chSingleDate->Checked()) {
      my ($d, $m, $y)   = $win->dtTimeDiffDate->GetDate();
      my ($h, $min, $s) = $win->dtTimeDiffTime->GetTime();
      $dt2              = DateTime->new(year       => $y    ,
                                        month      => $m    ,
                                        day        => $d    ,
                                        hour       => $h    ,
                                        minute     => $min  ,
                                        second     => $s    ,
                                        time_zone  => $tzLocal, );
      push(@{$refList1}, @{$refList2}); # Merge lists
    }

    foreach my $item (@{$refList1}) {
      # Gather date in list 2
      if (!$win->chSingleDate->Checked()) {
        my $item2 = $$refList2[$curr];
        $item2 =~ s/[\r\n]//g;  # Remove any line break
        if ($item2 and $item2 =~ /^($inputFormat)/) {
          if (my ($y, $m, $d, $h, $min, $s, $tz) = parse_date($1)) { # Parse date
            $dt2 = DateTime->new( year       => $y    ,
                                  month      => $m    ,
                                  day        => $d    ,
                                  hour       => $h    ,
                                  minute     => $min  ,
                                  second     => $s    , );
            if (!defined($tz)) { $dt2->set_time_zone($tzLocal); } # Local timezone
            else               { $dt2->set_time_zone($tz); $dt2->set_time_zone($tzLocal); } # Set to local timezone
          }
        }
      }
      # Gather date in list 1 and calculate difference
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($dt2 and $item and $item =~ /^($inputFormat)/) {
        if (my ($y, $m, $d, $h, $min, $s, $tz) = parse_date($1)) { # Parse date
            my $dt1 = DateTime->new(year       => $y  ,
                                    month      => $m  ,
                                    day        => $d  ,
                                    hour       => $h  ,
                                    minute     => $min,
                                    second     => $s  , );
          if (!defined($tz)) { $dt1->set_time_zone($tzLocal); } # Local timezone
          else               { $dt1->set_time_zone($tz); $dt1->set_time_zone($tzLocal); } # Set to local timezone
          my ($d_y,$d_m,$d_d,$d_h,$d_min,$d_s) = N_Delta_YMDHMS($dt1->year(), $dt1->month(), $dt1->day(), $dt1->hour(), $dt1->minute(), $dt1->second(),
                                                                $dt2->year(), $dt2->month(), $dt2->day(), $dt2->hour(), $dt2->minute(), $dt2->second(), );
          my $diffStr;
          if ($d_y)   { $diffStr .= "$d_y $STR{'years'}, ";     }
          if ($d_m)   { $diffStr .= "$d_m $STR{'months'}, ";    }
          if ($d_d)   { $diffStr .= "$d_d $STR{'days'}, ";      }
          if ($d_h)   { $diffStr .= "$d_h $STR{'hours'}, ";     }
          if ($d_min) { $diffStr .= "$d_min $STR{'minutes'}, "; }
          if ($d_s)   { $diffStr .= "$d_s $STR{'seconds'}, ";   }
          if ($diffStr) { chop($diffStr); chop($diffStr); }
          push(@items, $diffStr);
        } else {
          if ($noResultOpt) { push(@items, $STR{'errorConversion'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 7 = 'Add time' and 8 = 'Substract time'
  elsif ($selFunc == 7 or $selFunc == 8) {
    my $offsetY     = 0;
    my $offsetM     = 0;
    my $offsetD     = 0;
    my $offsetH     = 0;
    my $offsetMin   = 0;
    my $offsetS     = 0;
    my $addTimeType = $win->cbTypeValAddDT->GetCurSel();
    my $offsetVal   = $win->tfValAddDT->Text();
    if    ($addTimeType == 0) { $offsetY    = $offsetVal; }
    elsif ($addTimeType == 1) { $offsetM    = $offsetVal; }
    elsif ($addTimeType == 2) { $offsetD    = $offsetVal; }
    elsif ($addTimeType == 3) { $offsetH    = $offsetVal; }
    elsif ($addTimeType == 4) { $offsetMin  = $offsetVal; }
    elsif ($addTimeType == 5) { $offsetS    = $offsetVal; }
    my $offset = DateTime::Duration->new( years   => $offsetY  ,
                                          months  => $offsetM  ,
                                          days    => $offsetD  ,
                                          hours   => $offsetH  ,
                                          minutes => $offsetMin,
                                          seconds => $offsetS  , );
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        if ($item =~ /^($inputFormat)/) {
          if (my $time = str2time($1)) { # Convert to unixtime
            my $dt = DateTime->from_epoch(epoch => $time);
            $dt->set_time_zone($outputTZ);
            if ($selFunc == 7) { $dt->add_duration($offset);      }
            else               { $dt->subtract_duration($offset); }
            push(@items, $dt->strftime('%Y-%m-%d %H:%M:%S %z'));
          } else {
            if ($noResultOpt) { push(@items, $STR{'errorConversion'}); }
            else { push(@items, undef); }
          }
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }
      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }

  # Format results
  my $itemsRes;
  foreach (@items) { if ($_) { $itemsRes .= $_; } $itemsRes .= "\r\n"; }
  
  return(\$itemsRes);
  
}  #--- End timeTabFunc

#--------------------------#
sub utilsTabFunc
#--------------------------#
{
  # Local variables
  my ($refList1, $refList2) = @_;
  push(@{$refList1}, @{$refList2}); # Merge lists
  my $noResultOpt = $winConfig->rbNoResultOpt2->Checked();
  my $nbrItems    = scalar(@{$refList1});
  my $selFunc     = $win->cbUtils->GetCurSel();
  # Possibles value are 0 = 'NSLookup', 1 = 'CIDR to IP Range', 2 = 'IP Range to CIDR', 3 = 'CIDR to IP list',
  # 4 = 'IP to Arpa', 5 = 'Arpa to IP', 6 = 'Resolve MAC Address', 7 = 'Resolve IPv4 GeoIP', 8 = 'Resolve ISP',
  # 9 = 'Resolve User-agent', 10 = 'Credit Card to issuing company', 11 = 'Custom functions'
  my $curr = 0;
  my @items;
  
  # Progress
  $win->pb->SetRange(0, $nbrItems);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
  $win->lblPbCount->Text("0 / $nbrItems");
  
  # 0 = 'NSLookup'
  if ($selFunc == 0) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem = &nsLookup($item);
        if ($newItem) { push(@items, $newItem); }
        else {
          if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }

  # 1 = 'CIDR to IP Range'
  elsif ($selFunc == 1) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem;
        # Ex. IPv4: 123.123/16 to 123.123.0.0 - 123.123.255.255
        if ($item =~ /((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){0,3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/[0-9]{1,2})/) {
          my($refIp, $mask) = split(/\//, $item);
          my($start, $end) = split(/\-/, (Net::CIDR::cidr2range($item))[0]);
          while ($start !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $start .= '.0';   }
          while ($end   !~ /(?:[0-9]{1,3}\.){3}[0-9]{1,3}/) { $end   .= '.255'; }
          if ($start and $end) { $newItem = "$start - $end"; }
        # Ex. IPv6: 2001:db8:1234::/48 to 2001:db8:1234:0000:0000:0000:0000:0000 - 2001:db8:1234:ffff:ffff:ffff:ffff:ffff
        } elsif ($item =~ /($IPv6_re\/[0-9]{1,3})/) {
          my($refIp, $mask) = split(/\//, $item);
          my($start, $end) = split(/\-/, (Net::CIDR::cidr2range($item))[0]);
          while ($start =~ /:$/) { chop($start); }
          while ($end   =~ /:$/) { chop($end);   }
          while ($start !~ /(?:[0-9a-fA-F]{1,4}\:){7}[0-9a-fA-F]{1,4}/) { $start .= ':0000'; }
          while ($end   !~ /(?:[0-9a-fA-F]{1,4}\:){7}[0-9a-fA-F]{1,4}/) { $end   .= ':ffff'; }
          if ($start and $end) { $newItem = "$start - $end"; }
        }
        if ($newItem) { push(@items, $newItem); }
        else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 2 = 'IP Range to CIDR'
  elsif ($selFunc == 2) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem;
        # Ex. IPv4:  123.123.0.0 - 123.123.255.255 (spaces or not) to 123.123/16
        if ($item =~ /((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)) ?\- ?((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))/) {
          my $ipStart = $1;
          my $ipEnd   = $2;
          $newItem = Net::CIDR::range2cidr("$1\-$2");
        # Ex. IPv6: 2001:db8:1234:0000:0000:0000:0000:0000 - 2001:db8:1234:ffff:ffff:ffff:ffff:ffff (spaces or not) to 2001:db8:1234::/48
        } elsif ($item =~ /($IPv6_re) ?\- ?($IPv6_re)/) {
          my $ipStart = $1;
          my $ipEnd   = $2;
          $newItem = Net::CIDR::range2cidr("$1\-$2");
        }
        if ($newItem) { push(@items, $newItem); }
        else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 3 = 'CIDR to IP list'
  elsif ($selFunc == 3) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem;
        # Ex. IPv4: 123.123/28
        if ($item =~ /(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){0,3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/[0-9]{1,2}/) {
          if (my $n = NetAddr::IP->new_no($item)) {
            for my $ip ( @{$n->hostenumref} ) { $newItem .= $ip->addr."\r\n"; }
            chop($newItem); chop($newItem);
          }
        # Ex. IPv6: 2001:db8:1234::/120
        } elsif ($item =~ /$IPv6_re\/[0-9]{1,3}/) {
          if (my $n = NetAddr::IP->new6($item)) {
            for my $ip ( @{$n->hostenumref} ) { $newItem .= $ip->addr."\r\n"; }
            chop($newItem); chop($newItem);
          }
        }
        if ($newItem) { push(@items, $newItem); }
        else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  
  # 4 = 'IP to Arpa'
  elsif ($selFunc == 4) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem;
        # IPv4
        # 192.168.1.100 to 100.1.168.192.in-addr.arpa
        if ($item =~ /(?:[^0-9]|^)((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(?:[^0-9\.]|$)/) {
          $newItem = join('.',reverse(split(/\./,$1))) . '.in-addr.arpa';
        # IPv6
        # 2001:610:240:22::c100:68b to b.8.6.0.0.0.1.c.0.0.0.0.0.0.0.0.2.2.0.0.0.4.2.0.0.1.6.0.1.0.0.2.ip6.arpa
        } elsif ($item =~ /($IPv6_re)/) {
          my $IPv6 = new Net::IPv6Addr($1);
          $newItem = $IPv6->to_string_ip6_int();
          $newItem =~ s/.IP6.INT./.ip6.arpa/;
        }
        if ($newItem) { push(@items, $newItem); }
        else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 5 = 'Arpa to IP'
  elsif ($selFunc == 5) {
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem;
        # IPv4
        # 100.1.168.192.in-addr.arpa to 192.168.1.100
        if ($item =~ /((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)).in-addr.arpa/) {
          $newItem = join('.', reverse(split(/\./, $1)));
        # IPv6
        # b.8.6.0.0.0.1.c.0.0.0.0.0.0.0.0.2.2.0.0.0.4.2.0.0.1.6.0.1.0.0.2.ip6.arpa to 2001:610:240:22::c100:68b
        } elsif ($item =~ /((?:[0-9a-fA-F]\.){32})ip6\.arpa/) {
          my $IPv6Arpa = $1; # b.8.6.0.0.0.1.c.0.0.0.0.0.0.0.0.2.2.0.0.0.4.2.0.0.1.6.0.1.0.0.2.
          $IPv6Arpa =~ s/\.//g;
          my @parts = reverse(split("", $IPv6Arpa));
          my $IPv6Long;
          while (my @next_p = splice @parts, 0, 4) {
            $IPv6Long .= join('',@next_p);
            $IPv6Long .= ':';
          }
          chop($IPv6Long);
          my $IPv6 = new Net::IPv6Addr($IPv6Long);
          $newItem = $IPv6->to_string_compressed();
        }
        if ($newItem) { push(@items, $newItem); }
        else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 6 = 'Resolve MAC Address'
  elsif ($selFunc == 6) {
    my $MACOUIDB = $winConfig->tfMACOUIDB->Text();
    
    if (-f $MACOUIDB) {
      # Load MACOUI database
      my $dsn = "DBI:SQLite:dbname=$MACOUIDB";
      if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
        my $sth = $dbh->prepare("SELECT org from MACOUI WHERE prefix == ?");
        
        foreach my $item (@{$refList1}) {
          $item =~ s/[\r\n]//g;  # Remove any line break
          if ($item) {
            my $newItem;
            if ($item =~ /((?:[a-fA-F0-9]{2}[\:\-]?){2}[a-fA-F0-9]{2})[\-\:]?(?:[a-fA-F0-9]{2}[\:\-]?){2}[a-fA-F0-9]{2}/) {
              my $prefix =  $1;
              $prefix    =~ s/[\:\-]//g;
              $prefix    =~ tr/a-f/A-F/;
              my $rv  = $sth->execute($prefix);
              if ($rv >= 0) {
                my @fields = $sth->fetchrow_array();
                if (scalar(@fields) > 0) { $newItem = join('',@fields); }
              }
              
              if ($newItem) { push(@items, $newItem); }
              else {
                if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
                else { push(@items, undef); }
              }
            } else {
              if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
              else { push(@items, undef); }
            }
          } else {
            if ($noResultOpt) { push(@items, $STR{'noInput'}); }
            else { push(@items, undef); }
          }
    
          # Progress
          $curr++;
          $win->lblPbCount->Text("$curr / $nbrItems");
          $win->pb->StepIt();
        }
        
        $sth->finish();
        $dbh->disconnect();
      } else { Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}, $STR{'error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($win, 'MACOUI '.$STR{'DBnotFound'}.'...', $STR{'error'}, 0x40010); }
  }
  
  # 7 = 'Resolve IPv4 GeoIP'
  elsif ($selFunc == 7) {
    my $geoIPDB = $winConfig->tfGeoIPDB->Text();
    my $gi      = Geo::IP->open($geoIPDB, GEOIP_MEMORY_CACHE);
    my $selOpt  = $win->cbGeoIPOpt->GetCurSel();
    # Possible values are 0 = 'All available', 1 = 'Country', 2 = 'Country code', 3 = 'Region', 4 = 'Region code',
    # 5 = 'City', 6 = 'Postal code', 7 = 'GPS coordinates', 8 = 'Timezone name', 9 = 'Timezone offset'
    
    # Add headers
    if ($win->chGeoIPAddHeaders->Checked()) {
      my $headers;
      if    ($selOpt == 0) { $headers = "$STR{'country'}\t$STR{'countryCode'}\t$STR{'region'}\t$STR{'regionCode'}\t" .
                                        "$STR{'city'}\t$STR{'postalCode'}\t$STR{'GPScoord'}\t$STR{'tzName'}\t$STR{'tzOffset'}"; }
      elsif ($selOpt == 1) { $headers = $STR{'country'};     }
      elsif ($selOpt == 2) { $headers = $STR{'countryCode'}; }
      elsif ($selOpt == 3) { $headers = $STR{'region'};      }
      elsif ($selOpt == 4) { $headers = $STR{'regionCode'};  }
      elsif ($selOpt == 5) { $headers = $STR{'city'};        }
      elsif ($selOpt == 6) { $headers = $STR{'postalCode'};  }
      elsif ($selOpt == 7) { $headers = $STR{'GPScoord'};    }
      elsif ($selOpt == 8) { $headers = $STR{'tzName'};      }
      elsif ($selOpt == 9) { $headers = $STR{'tzOffset'};    }
      push(@items, $headers);
    }
    
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem;
        # IPv4 only
        if ($item =~ /(?:[^0-9]|^)((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(?:[^0-9\.]|$)/) {
          if (my $record = $gi->record_by_addr($1)) {
            if    ($selOpt == 0) {
              # Timezone offset
              my $TZOffset;
              if ($record->time_zone) {
                my $tz    = DateTime::TimeZone->new( name => $record->time_zone );
                if ($tz->{last_offset}) { $TZOffset = sprintf("%+05d", $tz->{last_offset}/36); }
              }
              if ($record->country_name)                    { $newItem .= $record->country_name;                     } $newItem .= "\t";
              if ($record->country_code)                    { $newItem .= $record->country_code;                     } $newItem .= "\t";
              if ($record->region_name)                     { $newItem .= $record->region_name;                      } $newItem .= "\t";
              if ($record->region)                          { $newItem .= $record->region;                           } $newItem .= "\t";
              if ($record->city)                            { $newItem .= $record->city;                             } $newItem .= "\t";
              if ($record->postal_code)                     { $newItem .= $record->postal_code;                      } $newItem .= "\t";
              if ($record->latitude and $record->longitude) { $newItem .= $record->latitude.", ".$record->longitude; } $newItem .= "\t";
              if ($record->time_zone)                       { $newItem .= $record->time_zone;                        } $newItem .= "\t";
              if ($TZOffset)                                { $newItem .= $TZOffset;                                 }
            }
            elsif ($selOpt == 1 and $record->country_name)                    { $newItem = $record->country_name;                     }
            elsif ($selOpt == 2 and $record->country_code)                    { $newItem = $record->country_code;                     }
            elsif ($selOpt == 3 and $record->region_name)                     { $newItem = $record->region_name;                      }
            elsif ($selOpt == 4 and $record->region)                          { $newItem = $record->region;                           }
            elsif ($selOpt == 5 and $record->city)                            { $newItem = $record->city;                             }
            elsif ($selOpt == 6 and $record->postal_code)                     { $newItem = $record->postal_code;                      }
            elsif ($selOpt == 7 and $record->latitude and $record->longitude) { $newItem = $record->latitude.", ".$record->longitude; }
            elsif ($selOpt == 8 and $record->time_zone)                       { $newItem = $record->time_zone;                        }
            elsif ($selOpt == 9 and $record->time_zone) {
              # Timezone offset
              if (my $tz = DateTime::TimeZone->new( name => $record->time_zone )) {
                my $TZOffset;
                if ($tz->{last_offset}) {
                  $TZOffset = sprintf("%+05d", $tz->{last_offset}/36); 
                  $newItem = $TZOffset;
                }
              }
            }
          }
          
          if ($newItem) { push(@items, $newItem); }
          else {
            if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
            else { push(@items, undef); }
          }
        } else {
          if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 8 = 'Resolve ISP'
  elsif ($selFunc == 8) {
    my $XLWHOISDBFile = $winConfig->tfXLWHOISDB->Text();

    if (-f $XLWHOISDBFile) {
      # Load XL-Whois database
      my $dsn = "DBI:SQLite:dbname=$XLWHOISDBFile";
      if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
        foreach my $item (@{$refList1}) {
          $item =~ s/[\r\n]//g;  # Remove any line break
          if ($item) {
            my $newItem;
            # IPv4
            if ($item =~ /(?:[^0-9]|^)((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(?:[^0-9\.]|$)/ or $item =~ /($IPv6_re)/) {
              my $ip = $1;
              if    ($item =~ /\./) { $newItem = &checkIP_WhoisDB_IPv4($ip, \$dbh); } # IPv4
              elsif ($item =~ /\:/) { $newItem = &checkIP_WhoisDB_IPv6($ip, \$dbh); } # IPv6
              
              if ($newItem) { push(@items, $newItem); }
              else {
                if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
                else { push(@items, undef); }
              }
            } else {
              if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
              else { push(@items, undef); }
            }
          } else {
            if ($noResultOpt) { push(@items, $STR{'noInput'}); }
            else { push(@items, undef); }
          }
    
          # Progress
          $curr++;
          $win->lblPbCount->Text("$curr / $nbrItems");
          $win->pb->StepIt();
        }
        
        $dbh->disconnect();
      } else { Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}, $STR{'error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($win, 'XL-Whois '.$STR{'DBnotFound'}.'...', $STR{'error'}, 0x40010); }
  }
  
  # 9 = 'Resolve User-agent'
  elsif ($selFunc == 9) {
    my $selOpt = $win->cbUAOpt->GetCurSel();
    # Possible values are 0 = 'All', 1 = 'Type', 1 = 'OS', 2 = 'Browser', 3 = 'Device', 4 = 'Lang'
    
    # Add headers
    if ($win->chUAAddHeaders->Checked()) {
      my $headers;
      if    ($selOpt == 0) { $headers = "$STR{'uaType'}\t$STR{'uaOS'}\t$STR{'uaBrowser'}\t$STR{'uaDevice'}\t$STR{'uaLang'}"; }
      elsif ($selOpt == 1) { $headers = $STR{'uaType'};    }
      elsif ($selOpt == 2) { $headers = $STR{'uaOS'};      }
      elsif ($selOpt == 3) { $headers = $STR{'uaBrowser'}; }
      elsif ($selOpt == 4) { $headers = $STR{'uaDevice'};  }
      elsif ($selOpt == 5) { $headers = $STR{'uaLang'};    }
      push(@items, $headers);
    }
    
    foreach my $item (@{$refList1}) {
      $item =~ s/[\r\n]//g;  # Remove any line break
      if ($item) {
        my $newItem = &parseUA($item, $selOpt);

        if ($newItem) { push(@items, $newItem); }
        else {
          if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
          else { push(@items, undef); }
        }
      } else {
        if ($noResultOpt) { push(@items, $STR{'noInput'}); }
        else { push(@items, undef); }
      }

      # Progress
      $curr++;
      $win->lblPbCount->Text("$curr / $nbrItems");
      $win->pb->StepIt();
    }
  }
  
  # 10 = 'Credit Card to issuing company'
  elsif ($selFunc == 10) {
    # Search in local IIN Database
    if ($win->rbIINLocalDB->Checked()) {
      my $IINFile = $winConfig->tfIINDB->Text();
      my %listIIN;
  
      if (-f $IINFile) {
        # Load IIN database
        my $dsn = "DBI:SQLite:dbname=$IINFile";
        if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
          my $all = $dbh->selectall_arrayref("SELECT * FROM IIN");
          foreach my $row (@$all) {
            my @values = @$row;
            if ($values[0] =~ /(^[0-9]{2})/) { push(@{$listIIN{$1}}, "$values[0]=$values[1]"); }
          }
          
          $dbh->disconnect();
    
          foreach my $item (@{$refList1}) {
            $item =~ s/[\r\n]//g;  # Remove any line break
            if ($item) {
              my $newItem;
              # Verify card number some regexs
              if (($item =~ /(?:[^0-9\-]|^)((?:(?:[0-9]{4}\-){3})[0-9]{4})(?:[^0-9\-]|$)/) or # With dashes
                  ($item =~ /(?:[^0-9]|^)((?:(?:[0-9]{4} ){3})[0-9]{4})(?:[^0-9]|$)/     ) or # With spaces
                  ($item =~ /(?:[^0-9\-]|(?:[^b]|^)\-|^)(4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})(?:[^0-9]|$)/) or
                  ($item =~ /(?:[^0-9\-]|(?:[^b]|^)\-|^)(\d{15,18}\d)(?:[^0-9]|$)/)) {
                my $cc   =  $1;
                $cc      =~ s/[\s\-]//g;
                $newItem =  &checkCC_IINDB($cc, \%listIIN);
                
                if ($newItem) { push(@items, $newItem); }
                else {
                  if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
                  else { push(@items, undef); }
                }
              } else {
                if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
                else { push(@items, undef); }
              }
            } else {
              if ($noResultOpt) { push(@items, $STR{'noInput'}); }
              else { push(@items, undef); }
            }
      
            # Progress
            $curr++;
            $win->lblPbCount->Text("$curr / $nbrItems");
            $win->pb->StepIt();
          }
        } else { Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}, $STR{'error'}, 0x40010); }
      } else { Win32::GUI::MessageBox($win, 'IIN '.$STR{'DBnotFound'}.'...', $STR{'error'}, 0x40010); }
    
    # Send queries to www.binlist.net
    } else {
      # Set headers
      my $headers = "$STR{'brand'}\t$STR{'subBrand'}\t$STR{'bank'}\t$STR{'cardType'}\t$STR{'cardCategory'}\t$STR{'countryName'}";
      push(@items, $headers);
      
      foreach my $item (@{$refList1}) {
        $item =~ s/[\r\n]//g;  # Remove any line break
        if ($item) {
          my $newItem;
          # Verify card number some regexs
          if (($item =~ /(?:[^0-9\-]|^)((?:(?:[0-9]{4}\-){3})[0-9]{4})(?:[^0-9\-]|$)/) or # With dashes
              ($item =~ /(?:[^0-9]|^)((?:(?:[0-9]{4} ){3})[0-9]{4})(?:[^0-9]|$)/     ) or # With spaces
              ($item =~ /(?:[^0-9\-]|(?:[^b]|^)\-|^)(4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})(?:[^0-9]|$)/) or
              ($item =~ /(?:[^0-9\-]|(?:[^b]|^)\-|^)(\d{15,18}\d)(?:[^0-9]|$)/)) {
            my $cc   =  $1;
            $cc      =~ s/[\s\-]//g;
            $newItem =  &checkCC_BinList($cc);
            
            if ($newItem) { push(@items, $newItem); }
            else {
              if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
              else { push(@items, undef); }
            }
          } else {
            if ($noResultOpt) { push(@items, $STR{'invalidInput'}); }
            else { push(@items, undef); }
          }
        } else {
          if ($noResultOpt) { push(@items, $STR{'noInput'}); }
          else { push(@items, undef); }
        }
  
        # Progress
        $curr++;
        $win->lblPbCount->Text("$curr / $nbrItems");
        $win->pb->StepIt();
      }
    }
  }
  
  # 11 = 'Custom functions'
  elsif ($selFunc == 11) {
    my $selFuncStr = $win->cbCFLists->GetString($win->cbCFLists->GetCurSel());
    my ($title, $dbFile);
    
    # Gather path to database
    if ($selFuncStr and $selFuncStr ne $STR{'cbCFLists'}.'...') {
      my $j = 1;
      while (exists($CONFIG{'CF'.$j})) {
        if ($CONFIG{'CF'.$j} =~ /$selFuncStr\|/) {
          ($title, $dbFile) = split(/\|/, $CONFIG{'CF'.$j});
          &saveConfig(\%CONFIG);
          last;
        }
        $j++;
      }
    
      if (-f $dbFile) {
        # Load CF database
        my $dsn = "DBI:SQLite:dbname=$dbFile";
        if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
          my $sth;
          
          # Match case ?
          if ($win->chCFMatchCase->Checked()) { $sth = $dbh->prepare("SELECT value from DATA WHERE key == ?");                }
          else                                { $sth = $dbh->prepare("SELECT value from DATA WHERE key == ? COLLATE NOCASE"); }
          
          foreach my $item (@{$refList1}) {
            $item =~ s/[\r\n]//g;  # Remove any line break
            if ($item) {
              my $newItem;
              my $rv  = $sth->execute($item);
              if ($rv >= 0) {
                my @fields = $sth->fetchrow_array();
                if (scalar(@fields) > 0) { $newItem = join('',@fields); }
              }
              
              if ($newItem) { push(@items, $newItem); }
              else {
                if ($noResultOpt) { push(@items, $STR{'noMatch'}); }
                else { push(@items, undef); }
              }
            } else {
              if ($noResultOpt) { push(@items, $STR{'noInput'}); }
              else { push(@items, undef); }
            }
      
            # Progress
            $curr++;
            $win->lblPbCount->Text("$curr / $nbrItems");
            $win->pb->StepIt();
          }
          
          $sth->finish();
          $dbh->disconnect();
        } else { Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}, $STR{'error'}, 0x40010); }
      } else { Win32::GUI::MessageBox($win, $STR{'selectedCF'}.' '.$STR{'DBnotFound'}.'...', $STR{'error'}, 0x40010); }
    }
  }
  

  # Format results
  my $itemsRes;
  foreach (@items) { if ($_) { $itemsRes .= $_; } $itemsRes .= "\r\n"; }
  
  return(\$itemsRes);
  
}  #--- End utilsTabFunc

#--------------------------#
sub nsLookup
#--------------------------#
{
  # Local variables
  my $item = shift;
  
  # $item is an IP address
  if ($item =~ /(?:[^0-9]|^)((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(?:[^0-9\.]|$)/ or $item =~ /($IPv6_re)/) {
    my $res = Net::DNS::Resolver->new;
    $res->tcp_timeout(10);
    $res->udp_timeout(10);
    my $packet = $res->query($1, "PTR", "IN");
    if ($packet) {
      my @addrs  = $packet->answer;
      my $hostname = '';
      foreach (@addrs) { if ($_->type eq 'PTR' and $_->ptrdname) { $hostname .= $_->ptrdname.", "; } }
      if ($hostname) {
        chop($hostname); chop($hostname);
        return($hostname);
      }
    }
  }
  # $item is a hostname or domain name
  elsif ($item =~ /((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.){2,}[a-zA-Z]{2,})(?:[^a-zA-Z]|$)/ or # Hostname
         $item =~ /((?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z]{2,})(?:[^\w\.\-]|$)/) {    # Domain name
    my $res = Net::DNS::Resolver->new;
    $res->tcp_timeout(10);
    $res->udp_timeout(10);
    my $packet = $res->query($1);
    if ($packet) {
      my @addrs  = $packet->answer;
      my $addr = '';
      foreach (@addrs) {
        if (($_->type eq 'A' or $_->type eq 'AAAA') and $_->address) { $addr .= $_->address.", "; }
      }
      if ($addr) {
        chop($addr); chop($addr);
        return($addr);
      }
    }
  }
  
}  # Fin nsLookup

#--------------------------#
sub parseUA
#--------------------------#
{
  # Local variables
  my ($uaStr, $opt) = @_;
  # Possible values for $opt are 0 = 'All', 1 = 'Type', 1 = 'OS', 2 = 'Browser', 3 = 'Device', 4 = 'Lang'
  my $UAInfos;
  
  # Parse User-Agent String
  my $refUA = Woothee->parse($uaStr); # Ex.: {'name'=>"Internet Explorer", 'category'=>"pc", 'os'=>"Windows 7", 'version'=>"8.0", 'vendor'=>"Microsoft"}
  
  # Detect type
  if (!$opt or $opt == 1) {
    # Not detected, use another parser
    if (!$$refUA{'category'} or $$refUA{'category'} =~ /UNKNOWN/) {
      if (my $uaType = HTTP::BrowserDetect->new($uaStr)) {
        if    ($uaType->robot())  { $UAInfos .= 'crawler';    }
        elsif ($uaType->mobile()) { $UAInfos .= 'smartphone'; }
        elsif ($uaType->tablet()) { $UAInfos .= 'tablet';     }
        else                      { $UAInfos .= 'pc';         }
      }
    } elsif ($$refUA{'category'}) { $UAInfos .= $$refUA{'category'}; }
    if (!$opt) { $UAInfos .= "\t"; }
  }
  
  # Robot
  if ($$refUA{'category'} eq 'crawler') {

  # pc or smartphone
  } else {
    # Detect OS
    if ($opt == 0 or $opt == 2) {
      my $os = &parseUAOS($uaStr, $refUA);
      if ($os  ) { $UAInfos .= $os;  }
      if (!$opt) { $UAInfos .= "\t"; }
    }
    
    # Detect browser
    if ($opt == 0 or $opt == 3) {
      my $browser;
      if ($$refUA{'name'}    and $$refUA{'name'}    !~ /UNKNOWN/) { $browser  = $$refUA{'name'}; }
      if ($uaStr =~ /Iceweasel/i)                                 { $browser  = 'Iceweasel';     }
      if ($uaStr =~ /Mobile/i and $uaStr =~ /Safari/)             { $browser  = 'Mobile Safari'; }
      # Add Version
      if ($$refUA{'version'} and $$refUA{'version'} !~ /UNKNOWN/) { $browser .= ' '.$$refUA{'version'}; }
      
      if ($browser) { $UAInfos .= $browser; }
      if (!$opt   ) { $UAInfos .= "\t";     }
    }
    
    # Detect Device
    if (!$opt or $opt == 4) {
      my $device;
      my $uaDevice = HTTP::BrowserDetect->new($uaStr);
      if ($uaDevice->device_name()) { $device = $uaDevice->device_name(); }

      if ($device) { $UAInfos .= $device; }
      if (!$opt  ) { $UAInfos .= "\t";     }
    }
    
    # Detect Lang
    if (!$opt or $opt == 5) {
      my $lang;
      my $uaLang = HTML::ParseBrowser->new($uaStr);
      if ($uaLang->language) { $lang = $uaLang->language; }
      # See https://msdn.microsoft.com/en-us/library/ms533052%28v=vs.85%29.aspx

      if ($lang) { $UAInfos .= $lang; }
      if (!$opt) { $UAInfos .= "\t";  }
    }
  }
  
  if ($UAInfos) {
    if ($UAInfos =~ /\t$/) { chop($UAInfos); }
    return($UAInfos);
  }

}  #--- End parseUA

#--------------------------#
sub parseUAOS
#--------------------------#
{
  # Local variables
  my ($uaStr, $refUA) = @_;
  my $os;
  
  # Some particulars
  if    ($uaStr =~ /Windows NT 5.2/i) { $os = 'Windows XP Professional x64'; }
  elsif ($uaStr =~ /Ubuntu/i        ) { $os = 'Linux Ubuntu'; }
  elsif ($uaStr =~ /Iceweasel/i     ) { $os = 'Linux Debian'; }
  # Unknown, use another parser
  elsif (!$$refUA{'os'} or $$refUA{'os'} =~ /UNKNOWN/) {
    if (my $uaOS = Parse::HTTP::UserAgent->new($uaStr)) {
      if ($uaOS->os) { $os = $uaOS->os; }
    }
  } else {
    if ($$refUA{'os'}) { $os = $$refUA{'os'}; }
    # Add version for MAC OS X
    if ($os and $os =~ /Mac OSX/i and $$refUA{'os_version'} and $$refUA{'os_version'} !~ /UNKNOWN/) {
      $os .= " $$refUA{'os_version'}";
    }
  }
  
  return($os);

}  #--- End parseUAOS

#--------------------------#
sub checkCC_IINDB
#--------------------------#
{
  # Local variables
  my ($cc, $refListIIN) = @_;
  my $issuer;

  # Check the card number with Business::CreditCard (Luhn Algorithm)
  my $genIssuer = &cardtype($cc);
  
  # If number valid, check in the IIN Database for a more precise result
  if ($genIssuer and $genIssuer ne 'Not a credit card') {
    my $exactIssuer;
    if ($cc =~ /(^[0-9]{2})/) {
      if (exists($$refListIIN{$1})) {
        foreach my $IIN (sort @{$$refListIIN{$1}}) {
          my ($prefix, $issuerName) = split(/\=/, $IIN);
          if ($cc =~ /^$prefix/) { $exactIssuer = $issuerName; }
        }
      }
    }
  
    if ($exactIssuer) { $issuer = $exactIssuer; }
    else              { $issuer = $genIssuer;   }
  }
  
  if ($issuer and $issuer !~ /Unknown/i) { return($issuer); }
  else                                   { return(undef);   }

}  #--- End checkCC_IINDB

#--------------------------#
sub checkCC_BinList
#--------------------------#
{
  # Local variables
  my ($cc) = @_;
  my $issuer;

  # Check the card number with Business::CreditCard (Luhn Algorithm)
  my $genIssuer = &cardtype($cc);
  
  # If number valid, send a query to Binlist.net
  if ($genIssuer and $genIssuer ne 'Not a credit card') {
    my $exactIssuer;
    my %data;
    
    if ($cc =~ /^([0-9]{6})/) { # Need only the first 6 digits
      my $ua = new LWP::UserAgent;
      $ua->agent($CONFIG{'USERAGENT'});
      $ua->default_header('Accept-Language' => 'en');
      my $client = REST::Client->new(useragent => $ua                        ,
                                     timeout   => $CONFIG{'NSLOOKUP_TIMEOUT'}, );
      $client->GET("https://www.binlist.net/json/$1");
      if ($client->responseCode() eq '200' and $client->responseContent()) {
        # Ex. response :
        #{
        #   "bin":"431940",
        #   "brand":"VISA",
        #   "sub_brand":"",
        #   "country_code":"IE",
        #   "country_name":"Ireland",
        #   "bank":"BANK OF IRELAND",
        #   "card_type":"DEBIT",
        #   "card_category":"",
        #   "latitude":"53",
        #   "longitude":"-8",
        #   "query_time":"365.845us"
        #}
        my @fields = split(/,/, $client->responseContent());
        foreach (@fields) { if (/\"([^\"]+)\"\:\"([^\"]*)\"/) { $data{$1} = $2; } }
        if ($data{brand})         { $exactIssuer .= "$data{brand}\t";         } else { $exactIssuer .= "\t"; }
        if ($data{sub_brand})     { $exactIssuer .= "$data{sub_brand}\t";     } else { $exactIssuer .= "\t"; }
        if ($data{bank})          { $exactIssuer .= "$data{bank}\t";          } else { $exactIssuer .= "\t"; }
        if ($data{card_type})     { $exactIssuer .= "$data{card_type}\t";     } else { $exactIssuer .= "\t"; }
        if ($data{card_category}) { $exactIssuer .= "$data{card_category}\t"; } else { $exactIssuer .= "\t"; }
        if ($data{country_name})  { $exactIssuer .= "$data{country_name}";   }
      }
    }
  
    if ($exactIssuer) { $issuer = $exactIssuer; }
  }
  
  if ($issuer) { return($issuer); }
  else         { return(undef);   }

}  #--- End checkCC_BinList

#--------------------------#
sub cbCFLists_Change
#--------------------------#
{
  # Local variables
  my $selFuncStr = $win->cbCFLists->GetString($win->cbCFLists->GetCurSel());
  
  if ($selFuncStr and $selFuncStr ne $STR{'cbCFLists'}.'...') {
    $win->chCFMatchCase->Show();
    $win->btnCFRem->Enable();
    $win->btnCFEdit->Enable();
  } else {
    $win->chCFMatchCase->Hide();
    $win->btnCFRem->Disable();
    $win->btnCFEdit->Disable();
  }
  
  &isProcessReady(0);

}  #--- End cbCFLists_Change

#--------------------------#
sub btnCFAdd_Click
#--------------------------#
{
  # Show OpenFile dialog window
  my $CFDBFile = Win32::GUI::GetOpenFileName( -owner         => $win                              ,
                                              -title         => $STR{'selectDBFile'}              ,
                                              -filter        => [$STR{'dbFile'}.' - .db', '*.db'] ,
                                              -defaultfilter => 0                                 ,
                                              -filemustexist => 1                                 ,
                                              -explorer      => 1                                 , );
  if ($CFDBFile) {
    if (-f $CFDBFile and &validCFDB($CFDBFile)) {
      # Connect to DB
      my $dsn = "DBI:SQLite:dbname=$CFDBFile";
      if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
        my $sth = $dbh->prepare("SELECT title from TITLE");
        my $rv  = $sth->execute();
        my @fields = $sth->fetchrow_array();
        if (scalar(@fields) > 0) {
          my $title = join('',@fields);
          $sth->finish();
          $dbh->disconnect();
          
          # Copy to the Customs folder
          my $pathQuoted = quotemeta($PROGDIR);
          if ($CFDBFile !~ /$pathQuoted\\Customs/) {
            if (!-d "$PROGDIR\\Customs") { mkdir("$PROGDIR\\Customs"); }
            my $funcFileName = pop @{[split m|\\|, $CFDBFile]};
            # Do not overwrite if already exists
            if (!-e "$PROGDIR\\Customs\\$funcFileName") {
              if (copy($CFDBFile, "$PROGDIR\\Customs\\$funcFileName")) {
                $CFDBFile = "$PROGDIR\\Customs\\$funcFileName";
              }
            }
          }
          
          # Verify that the title doesn't already exist
          if (&validUniqueCFName($title)) {
            # Update window and config
            my $j = 1;
            while (exists($CONFIG{'CF'.$j})) { $j++; }
            $CONFIG{'CF'.$j} = $title.'|'.$CFDBFile;
            &saveConfig(\%CONFIG);
            $win->cbCFLists->Add($title);
            Win32::GUI::MessageBox($win, $STR{'funcAdded'}, "XL-Tools $VERSION", 0x40040);
            
          # Function must be modified
          } else {
            Win32::GUI::MessageBox($win, $STR{'funcExists'}, $STR{'warning'}, 0x40030);
            &editCF($title, $CFDBFile);
          }
        } else { Win32::GUI::MessageBox($win, $STR{'funcNoTitle'}, $STR{'error'}, 0x40010); }
      } else { Win32::GUI::MessageBox($win, $STR{'errorConnectDB'}, $STR{'error'}, 0x40010); }
    } else { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
  }

}  #--- End btnCFAdd_Click

#--------------------------#
sub validCFDB
#--------------------------#
{
  # Local variables
  my $CFDBFile = shift;
  my $titleTableExists;
  my $dataTableExists;
  
  if (-f $CFDBFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$CFDBFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      my $sth;
      eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
      if ($@) { return(0); }
      # If tables TITLE and DATA exists, database is valid
      my $refAllRows = $sth->fetchall_arrayref();
      foreach my $refRow (@{$refAllRows}) {
        if    ($$refRow[2] eq 'TITLE') { $titleTableExists = 1; }
        elsif ($$refRow[2] eq 'DATA' ) { $dataTableExists  = 1; }
      }

      $sth->finish();
      $dbh->disconnect();

      if ($titleTableExists and $dataTableExists) { return(1); }
    }
  }
  
  return(0);
  
}  #--- End validCFDB

#--------------------------#
sub validUniqueCFName
#--------------------------#
{
  # Local variables
  my $title = shift;
  
  for (my $i = 0; $i < $win->cbCFLists->Count(); $i++) {
    my $currSelStr = $win->cbCFLists->GetString($i);
    if ($currSelStr eq $title) { return(0); }
  }
  
  return(1); # Not found  
  
}  #--- End validUniqueCFName
  
#--------------------------#
sub btnCFRem_Click
#--------------------------#
{
  # Local variables
  my $selFuncStr = $win->cbCFLists->GetString($win->cbCFLists->GetCurSel());
  my ($title, $dbFile, $index);
  
  # Ask a confirmation
  my $answer = Win32::GUI::MessageBox($win, "$STR{'remConfirm'} \"$selFuncStr\" $STR{'func'} ?", $STR{'remConfirmT'}, 0x40024);

  if ($answer == 6) {
    # Gather path to database
    if ($selFuncStr and $selFuncStr ne $STR{'cbCFLists'}.'...') {
      my $j = 1;
      while (exists($CONFIG{'CF'.$j})) {
        if ($CONFIG{'CF'.$j} =~ /$selFuncStr\|/) {
          ($title, $dbFile) = split(/\|/, $CONFIG{'CF'.$j});
          $index = $j;
          delete($CONFIG{'CF'.$j});
          &saveConfig(\%CONFIG);
          last;
        }
        $j++;
      }
      # Update index (Ex.: if CF3 is deleted, CF4 becomes CF3, CF5 becomes CF 4 and so on)
      $j++;
      while (exists($CONFIG{'CF'.$j})) {
        my $k = $j-1;
        $CONFIG{'CF'.$k} = $CONFIG{'CF'.$j};
        $j++;
      }
      $j--;
      delete($CONFIG{'CF'.$j}); # Remove the last one
      &saveConfig(\%CONFIG);
    }
    
    # Remove function from list
    if ($index) { $win->cbCFLists->DeleteString($index); }
    
    # Ask confirmation to delete the file
    $answer = Win32::GUI::MessageBox($win, "$STR{'delConfirm'} ?", $STR{'delConfirmT'}, 0x40024);
    
    # Delete the file
    if ($answer == 6) {
      if (-e $dbFile) { unlink($dbFile); }
      if (!-e $dbFile) { 
        Win32::GUI::MessageBox($win, $STR{'funcDeleted'}, "XL-Tools $VERSION", 0x40040);
      }
    }
    
    $win->cbCFLists->SetCurSel(0);
  }

}  #--- End btnCFRem_Click

#--------------------------#
sub btnCFEdit_Click
#--------------------------#
{
  # Local variables
  my $selFuncStr = $win->cbCFLists->GetString($win->cbCFLists->GetCurSel());
  my ($title, $dbFile);
  
  # Gather path to database
  if ($selFuncStr and $selFuncStr ne $STR{'cbCFLists'}.'...') {
    my $j = 1;
    while (exists($CONFIG{'CF'.$j})) {
      if ($CONFIG{'CF'.$j} =~ /$selFuncStr\|/) {
        ($title, $dbFile) = split(/\|/, $CONFIG{'CF'.$j});
        last;
      }
      $j++;
    }

    &editCF($title, $dbFile);
  }

}  #--- End btnCFEdit_Click

#--------------------------#
sub btnCFNew_Click
#--------------------------#
{
  # Show options and message
  $win->lblCFTitle->Show();
  $win->tfCFTitle->Show();
  $win->btnCFSave->Show();
  $win->btnCFCancel->Show();
  $win->chCFMatchCase->Hide();
  $win->cbCFLists->Disable();
  $win->btnProcess->Disable();
  
  # Show List 2
  &showList2();

}  #--- End btnCFNew_Click

#--------------------------#
sub tfCFTitle_Change
#--------------------------#
{
  # Valid New Function
  &validNewFunc();

}  #--- End tfCFTitle_Change

#--------------------------#
sub validNewFunc
#--------------------------#
{
  # To be valid, the new function:
  # - Must contains a title that doesn't already exist
  # - Number of items in List 1 and List 2 must be the same
  my $title = $win->tfCFTitle->Text();
  my $refList1  = &enumItems(\$win->tfList1);
  my $refList2  = &enumItems(\$win->tfList2);
  my $nbrItems1 = scalar(@{$refList1});
  my $nbrItems2 = scalar(@{$refList2});
  
  if ($title and $nbrItems1 > 0 and $nbrItems2 > 0 and $nbrItems1 == $nbrItems2) {
    $win->btnCFSave->Enable();
  } else {
    $win->btnCFSave->Disable();
  }

}  #--- End validNewFunc

#--------------------------#
sub btnCFSave_Click
#--------------------------#
{
  threads->create(sub {
    # Local variables
    my $title     = $win->tfCFTitle->Text();
    my $refList1  = &enumItems(\$win->tfList1);
    my $refList2  = &enumItems(\$win->tfList2);
    my $nbrItems1 = scalar(@{$refList1});
    my $nbrItems2 = scalar(@{$refList2});
    my $dbFile;
    my $indexCF;
    
    # Verify if function already exists
    my $j = 1;
    while (exists($CONFIG{'CF'.$j})) {
      if ($CONFIG{'CF'.$j} =~ /$title\|/) {
        $dbFile  = (split(/\|/, $CONFIG{'CF'.$j}))[1];
        $indexCF = $j;
        last;
      }
      $j++;
    }
    
    # List 1 must not contain duplicates
    my %items;
    my $containsDuplicate;
    foreach my $item (@{$refList1}) {
      if (exists($items{$item})) { $containsDuplicate = 1; last; }
      else { $items{$item} = 1; }
    }
    
    # Error duplicates
    if ($containsDuplicate) { Win32::GUI::MessageBox($win, $STR{'CFErrorDupl'}, $STR{'error'}, 0x40010); }
    else {
      # If function already exist, confirm replacement
      if ($dbFile and -f $dbFile) {
        my $answer = Win32::GUI::MessageBox($win, "$STR{'funcExists2'} ?", $STR{'replConfirmT'}, 0x40024);
        if ($answer == 6) {
          # If function exists, we modify the database
          &modCF($title, $dbFile, $indexCF, $refList1, $refList2, $nbrItems1, $nbrItems2);
        # Cancel
        } else { return(); }
        
      # If function doesn't exist, we create a new one
      } else { &newCF($title, $refList1, $refList2, $nbrItems1, $nbrItems2); }
    
      # Clean Lists and Hide control
      $win->tfCFTitle->Text('');
      $win->tfList1->Text('');
      $win->tfList2->Text('');
      $win->lblCFTitle->Hide();
      $win->tfCFTitle->Hide();
      $win->btnCFSave->Hide();
      $win->btnCFCancel->Hide();
      $win->cbCFLists->Enable();
      $win->btnProcess->Enable();
      if ($win->cbCFLists->GetCurSel() > 0) { $win->chCFMatchCase->Show(); }
      &tfList1_Change();
      &tfList2_Change();
      
      # Hide List 2
      &hideList2();
    }
  });

}  #--- End btnCFSave_Click

#--------------------------#
sub btnCFCancel_Click
#--------------------------#
{
  # Clean Lists and Hide control
  $win->tfCFTitle->Text('');
  $win->tfList1->Text('');
  $win->tfList2->Text('');
  $win->lblCFTitle->Hide();
  $win->tfCFTitle->Hide();
  $win->btnCFSave->Hide();
  $win->btnCFCancel->Hide();
  $win->cbCFLists->Enable();
  $win->btnProcess->Enable();
  if ($win->cbCFLists->GetCurSel() > 0) { $win->chCFMatchCase->Show(); }
  &tfList1_Change();
  &tfList2_Change();
  
  # Hide List 2
  &hideList2();
  
}  #--- End btnCFCancel_Click

#--------------------------#
sub editCF
#--------------------------#
{
  # Local variables
  my ($title, $dbFile) = @_;
  
  # Show options and message
  $win->lblCFTitle->Show();
  $win->tfCFTitle->Show();
  $win->btnCFSave->Show();
  $win->btnCFCancel->Show();
  $win->chCFMatchCase->Hide();
  $win->cbCFLists->Disable();
  $win->btnProcess->Disable();
  
  # Clean Lists
  $win->tfList1->Text('');
  $win->tfList2->Text('');
  
  # Show List 2
  &showList2();
  
  # Connect to database
  if ($dbFile) {
    threads->create(sub {
      my $list1;
      my $list2;
      my $dsn = "DBI:SQLite:dbname=$dbFile";
      if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
        $win->ChangeCursor($HOURGLASS);
        
        # Write title
        $win->tfCFTitle->Text($title);
        # Write the data
        my $all = $dbh->selectall_arrayref("SELECT * FROM DATA");
        foreach my $row (@$all) {
          my @values = @$row;
          if ($values[0] and $values[1]) {
            $list1 .= "$values[0]\r\n";
            $list2 .= "$values[1]\r\n";
          }
        }
        
        $dbh->disconnect();
        chomp($list1); chomp($list1);
        chomp($list2); chomp($list2);
        $win->tfList1->Text($list1);
        $win->tfList2->Text($list2);
        &tfList1_Change();
        &tfList2_Change();
        $win->ChangeCursor($ARROW);
      }
    });
  }
  
}  #--- End editCF

#--------------------------#
sub modCF
#--------------------------#
{
  # Local variables
  my ($title, $dbFile, $indexCF, $refList1, $refList2, $nbrItems1, $nbrItems2) = @_;
  
  # Connect to database
  my $dsn = "DBI:SQLite:dbname=$dbFile";
  if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
    
    # Show progress
    $win->lblPbCurr->Text('');
    $win->pb->SetPos(0);
    $win->lblPbCount->Text('');
    $win->lblPbCurr->Show();
    $win->pb->Show();
    $win->lblPbCount->Show();
    $win->ChangeCursor($HOURGLASS);
    $win->pb->SetRange(0, $nbrItems1);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
    $win->lblPbCount->Text("0 / $nbrItems1");
    my $curr = 0;
  
    # Drop the existing table
    $dbh->do("DROP TABLE DATA");
    # Create a new DATA table
    my $stmt = qq(CREATE TABLE IF NOT EXISTS DATA
                  (key   VARCHAR(255)  NOT NULL,
                   value VARCHAR(255)  NOT NULL, 
                   PRIMARY KEY (key)));
    my $rv = $dbh->do($stmt);
    # Insert Data
    if ($rv >= 0) {
      my $sthData = $dbh->prepare("insert into DATA (key, value) values(?,?)");
      for (my $i = 0; $i < $nbrItems1; $i++) {
        if ($$refList1[$i] and $$refList2[$i]) { $sthData->execute($$refList1[$i], $$refList2[$i]); }
        
        # Progress
        $curr++;
        $win->lblPbCount->Text("$curr / $nbrItems1");
        $win->pb->StepIt();
      }
    }
    
    $dbh->disconnect();

    # Progress
    $win->lblPbCurr->Text('');
    $win->pb->SetPos(0);
    $win->lblPbCount->Text('');
    $win->lblPbCurr->Hide();
    $win->pb->Hide();
    $win->lblPbCount->Hide();
    $win->ChangeCursor($ARROW);
  }

}  #--- End modCF

#--------------------------#
sub newCF
#--------------------------#
{
  # Local variables
  my ($title, $refList1, $refList2, $nbrItems1, $nbrItems2) = @_;
  
  # Create default directory
  my $defCFDir = "$PROGDIR\\Customs";
  if (!-d $defCFDir) { mkdir($defCFDir); }  
  
  # Show SaveFileWindow for database path
  my $tempName = $title;
  $tempName =~ s/[\<\>\:\"\/\\\|\?\*]/_/g; # Remove invalid char for a Windows filename
  my $CFDBFile = Win32::GUI::GetSaveFileName( -owner            => $win                             ,
                                              -title            => $STR{'selPathDB'}.':'            ,
                                              -directory        => $defCFDir                        ,
                                              -file             => "$tempName.db"                   ,
                                              -filter           => [$STR{'dbFile'}.' - .db', '.db'] ,
                                              -overwriteprompt  => 1                                , );
  if ($CFDBFile) {
    # Create the database
    my $dsn = "DBI:SQLite:dbname=$CFDBFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      # Show progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Show();
      $win->pb->Show();
      $win->lblPbCount->Show();
      $win->ChangeCursor($HOURGLASS);
      $win->pb->SetRange(0, $nbrItems1);
      $win->pb->SetPos(0);
      $win->pb->SetStep(1);
      $win->lblPbCurr->Text($STR{'runningProcess'}.'...');
      $win->lblPbCount->Text("0 / $nbrItems1");
      my $curr = 0;
    
      $dbh->{sqlite_unicode} = 1;
      # Create the TITLE table
      my $stmt = qq(CREATE TABLE IF NOT EXISTS TITLE
                    (title  VARCHAR(255)  NOT NULL));
      my $rv = $dbh->do($stmt);
      # Insert Title
      my $sthTitle = $dbh->prepare("insert into TITLE (title) values(?)");
      $sthTitle->execute($title);
      if ($rv >= 0) {
        # Create the DATA table
        $stmt = qq(CREATE TABLE IF NOT EXISTS DATA
                   (key   VARCHAR(255)  NOT NULL,
                    value VARCHAR(255)  NOT NULL, 
                    PRIMARY KEY (key)));
        my $rv = $dbh->do($stmt);
        # Insert Data
        if ($rv >= 0) {
          my $sthData = $dbh->prepare("insert into DATA (key, value) values(?,?)");
          for (my $i = 0; $i < $nbrItems1; $i++) {
            if ($$refList1[$i] and $$refList2[$i]) { $sthData->execute($$refList1[$i], $$refList2[$i]); }
            
            # Progress
            $curr++;
            $win->lblPbCount->Text("$curr / $nbrItems1");
            $win->pb->StepIt();
          }
        }
      }
      
      $dbh->disconnect();
      
      # Update window and config
      my $j = 1;
      while (exists($CONFIG{'CF'.$j})) { $j++; }
      $CONFIG{'CF'.$j} = $title.'|'.$CFDBFile;
      &saveConfig(\%CONFIG);
      $win->cbCFLists->Add($title);
      
      # Progress
      $win->lblPbCurr->Text('');
      $win->pb->SetPos(0);
      $win->lblPbCount->Text('');
      $win->lblPbCurr->Hide();
      $win->pb->Hide();
      $win->lblPbCount->Hide();
      $win->ChangeCursor($ARROW);
    }
  }

}  #--- End newCF

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR_UPDATE and $THR_UPDATE->is_running()) { $THR_UPDATE->kill('KILL')->detach(); }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub updateAll
#--------------------------#
{
  # Thread 'cancellation' signal handler
  $SIG{'KILL'} = sub {
    # Delete temp files if converting was in progress
    if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
      my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
      unlink($localMACOUIDB.'-journal');
      unlink($localMACOUIDB);
    }
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    threads->exit();
  };
  
  # Thread 'die' signal handler
  $SIG{__DIE__} = sub {
    # Delete temp files if converting was in progress
    if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
      my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
      unlink($localMACOUIDB.'-journal');
      unlink($localMACOUIDB);
    }
    my $errMsg = (split(/ at /,$_[0]))[0];
    chomp($errMsg);
    $errMsg =~ s/[\t\r\n]/ /g;
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
  };
  
  # Update Tool ?
  sleep(1);
  if ($CONFIG{'TOOL_AUTO_UPDATE'})      { &updateTool(0);     }
  # Update GeoIP DB ?
  if ($CONFIG{'GEOIP_DB_AUTO_UPDATE'})  { &updateGeoIPDB(0);  }
  # Update MACOUI DB ?
  if ($CONFIG{'MACOUI_DB_AUTO_UPDATE'}) { &updateMACOUIDB(0); }
  
}  #--- End updateAll

#--------------------------#
sub createCW
#--------------------------#
{
  # Create Config Wizard Window
  my $winCW  = Win32::GUI::DialogBox->new(-name        => 'winCW'                   ,
                                          -parent      => $win                      , # May be open from many Window
                                          -text        => $STR{'winCW'}             ,
                                          -pos         => [$winPosX, $winPosY]      ,
                                          -size        => [400, 170]                ,
                                          -background  => [255, 255, 255]           ,
                                          -hasmaximize => 0                         ,
                                          -hasminimize => 1                         ,
                                          -helpbutton  => 0                         ,
                                          -resizable   => 0                         ,
                                          -dialogui    => 1                         , );
  $winCW->SetIcon($winICO);
  
  $winCW->AddLabel(     -name        => 'lblConfigLogo'       ,
                        -size        => [128,128]             ,
                        -pos         => [  0,  5]             ,
                        -bitmap      => $config128Bmp         , );
  $winCW->AddLabel(     -name        => 'lblSetGenOpt'        ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 10]             ,
                        -font        => $font10               ,
                        -text        => $STR{'SetGenOpt'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblSetGenOptDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 10]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocXLWhoisDB'     ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 30]             ,
                        -font        => $font10               ,
                        -text        => $STR{'locXLWhoisDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocXLWhoisDBDone' ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 30]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocXLWhoisDBError',
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 30]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocIINLocalDB'    ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 50]             ,
                        -font        => $font10               ,
                        -text        => $STR{'locIINLocalDB'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocIINLocalDBDone',
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 50]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblLocIINLocalDBError',
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 50]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDB'        ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 70]             ,
                        -font        => $font10               ,
                        -text        => $STR{'downloadGeoIP'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDBDone'    ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 70]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLGeoIPDBError'   ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 70]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLMACOUIDB'       ,
                        -size        => [220, 22]             ,
                        -pos         => [140, 90]             ,
                        -font        => $font10               ,
                        -text        => $STR{'downloadMACOUI'}.'...',
                        -background  => [255, 255, 255]       ,
                        -foreground  => [  0, 102, 204]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLMACOUIDBDone'   ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 90]             ,
                        -bitmap      => $checkBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  $winCW->AddLabel(     -name        => 'lblDLMACOUIDBError'  ,
                        -size        => [ 20, 20]             ,
                        -pos         => [365, 90]             ,
                        -bitmap      => $errorBmp             ,
                        -background  => [255, 255, 255]       ,
                        -visible     => 0                     , );
  
  return(\$winCW);

}  #--- End createCW

#--------------------------#
sub firstStart
#--------------------------#
{
  # Local variables
  my $refWinCW = shift;
  
  # Thread 'cancellation' signal handler
  $SIG{'KILL'} = sub {
    # Delete temp files if converting was in progress
    if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
      my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
      unlink($localMACOUIDB.'-journal');
      unlink($localMACOUIDB);
    }
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, $STR{'configSetPart'}, "XL-Tools $VERSION", 0x40040);
    threads->exit();
  };
  
  # Thread 'die' signal handler
  $SIG{__DIE__} = sub {
    # Delete temp files if converting was in progress
    if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
      my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
      unlink($localMACOUIDB.'-journal');
      unlink($localMACOUIDB);
    }
    my $errMsg = (split(/ at /,$_[0]))[0];
    chomp($errMsg);
    $errMsg =~ s/[\t\r\n]/ /g;
    $win->ChangeCursor($ARROW);
    # Turn off progress bar
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    $$refWinCW->Hide();
    Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
  };

  # Yes (6), No (7)
  my $answer = Win32::GUI::MessageBox($win, $STR{'firstStart'}, $STR{'winConfig'}, 0x1024);
  
  if ($answer == 6) {
    my $dir;
    
    # Use default directory ? (program directory)
    $answer = Win32::GUI::MessageBox($win, $STR{'defaultDir'}.'('.$PROGDIR.') ?', $STR{'winConfig'}, 0x1024);
    
    # Answer is no, open popup to let user choose a different location
    if ($answer == 7) {
      # Select a folder
      $dir = Win32::GUI::BrowseForFolder( -owner      => $$refWinCW               ,
                                          -title      => $STR{'selectFolder'}.':' ,
                                          -folderonly => 1                        ,
                                          -newui      => 1                        ,
                                          -directory  => $PROGDIR                 , );
    # Answer is yes, use default dir
    } else { $dir = $PROGDIR; }
    
    # Selected folder
    if ($dir and -d $dir) {
      $$refWinCW->Top($win->Top()+5);
      $$refWinCW->Left($win->Left()+310);
      $$refWinCW->Show();
      
      # Set General options
      $$refWinCW->lblSetGenOpt->Show();
      # Tool
      $winConfig->chAutoUpdate->Checked(1);      
      $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
      # Functions
      $winConfig->tfMaxSize->Text(5000000); # Set Max Size (List) to 5 000 000 chars
      $CONFIG{'MAX_SIZE_LIST'} = 5000000;
      $winConfig->tfLookupTO->Text(10); # Set Nslookup timeout to 10 seconds
      $CONFIG{'NSLOOKUP_TIMEOUT'} = 10;
      $winConfig->tfUserAgent->Text('XL-Tools (http://www.le-tools.com)'); # Set default User-Agent
      $CONFIG{'USERAGENT'} = 'XL-Tools (http://www.le-tools.com)';
      $winConfig->rbNoResultOpt1->Checked(1); # Set "When no result" to "Leave a blank"
      $winConfig->rbNoResultOpt2->Checked(0);
      $winConfig->chGeoIPDBAutoUpt->Checked(1); # Check auto update for GeoIP Database
      $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 1;
      $winConfig->chMACOUIDBAutoUpt->Checked(0); # Uncheck auto update for MACOUI Database
      $CONFIG{'MACOUI_DB_AUTO_UPDATE'} = 0;
      &saveConfig(\%CONFIG);
      $$refWinCW->lblSetGenOptDone->Show();
      
      # Select the XL-Whois DB
      $$refWinCW->lblLocXLWhoisDB->Show();
      my $XLWHOISDBFile = Win32::GUI::GetOpenFileName(-title         => $STR{'locXLWhoisDB'}.':',
                                                      -defaultfilter => 0                       ,
                                                      -filemustexist => 1                       ,
                                                      -file          => 'Whois.db'              ,
                                                      -explorer      => 1                       , );
      if ($XLWHOISDBFile and -f $XLWHOISDBFile) {
        $winConfig->tfXLWHOISDB->Text($XLWHOISDBFile);
        $$refWinCW->lblLocXLWhoisDBDone->Show();
      } else { $$refWinCW->lblLocXLWhoisDBError->Show(); }
      
      # Select the IINDB
      $$refWinCW->lblLocIINLocalDB->Show();
      my $IINDBFile = Win32::GUI::GetOpenFileName(-title         => $STR{'locIINLocalDB'}.':',
                                                  -defaultfilter => 0                        ,
                                                  -filemustexist => 1                        ,
                                                  -file          => 'IIN.db'                 ,
                                                  -explorer      => 1                        , );
      if ($IINDBFile and -f $IINDBFile) {
        $winConfig->tfIINDB->Text($IINDBFile);
        $$refWinCW->lblLocIINLocalDBDone->Show();
      } else { $$refWinCW->lblLocIINLocalDBError->Show(); }
      
      # Download or select Database files
      my $return = 0;
      
      # Download GeoIP Database
      $$refWinCW->lblDLGeoIPDB->Show();
      $return = &downloadGeoIPDB("$dir\\GeoLiteCity.dat"); # $return contains error msg if any
      if ($return) { 
        $$refWinCW->lblDLGeoIPDBError->Show();
        Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);
      } else { $$refWinCW->lblDLGeoIPDBDone->Show(); }
      &saveConfig(\%CONFIG);
      
      # Download MACOUI Database
      $$refWinCW->lblDLMACOUIDB->Show();
      $return = &downloadMACOUIDB("$dir\\oui.db");
      if ($return) { # $return contains error msg if any
        $$refWinCW->lblDLMACOUIDBError->Show();
        Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);
      } else { $$refWinCW->lblDLMACOUIDBDone->Show(); }
      &saveConfig(\%CONFIG);
      
      # Close Configuration Wizard
      $$refWinCW->Hide();
      $win->ChangeCursor($ARROW);
      Win32::GUI::MessageBox($win, $STR{'configSet'}, "XL-Tools $VERSION", 0x40040);
    }
  }

}  #--- End firstStart

#--------------------------#
sub btnWinConfig_Click
#--------------------------#
{
  # Show Config window with General Tab
  $winConfig->configTab->SetCurSel(0);
  &configTab_Click;
  
  $winConfig->Center();
  $winConfig->DoModal();

}  #--- End btnWinConfig_Click

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General tab
  if ($winConfig->configTab->SelectedItem() == 0) {
    # General tab
    $winConfig->lblToolShadowT->Show();
    $winConfig->lblToolT->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->lblOptFunctionsShadowT->Show();
    $winConfig->lblOptFunctionsT->Show();
    $winConfig->chFullScreen->Show();
    $winConfig->chRememberPos->Show();
    $winConfig->lblMaxSize1->Show();
    $winConfig->tfMaxSize->Show();
    $winConfig->lblMaxSize2->Show();
    $winConfig->lblNsLookupTO1->Show();
    $winConfig->tfLookupTO->Show();
    $winConfig->lblNsLookupTO2->Show();
    $winConfig->lblUserAgent->Show();
    $winConfig->tfUserAgent->Show();
    $winConfig->lblNoResultOpt->Show();
    $winConfig->rbNoResultOpt1->Show();
    $winConfig->rbNoResultOpt2->Show();
    
    # Databases tab
    $winConfig->lblMACOUIDBShadowT->Hide();
    $winConfig->lblMACOUIDBT->Hide();
    $winConfig->chMACOUIDBAutoUpt->Hide();
    $winConfig->tfMACOUIDB->Hide();
    $winConfig->btnMACOUIDB->Hide();
    $winConfig->btnMACOUIDBUpt->Hide();
    $winConfig->btnMACOUIDBImport->Hide();
    $winConfig->lblGeoIPDBShadowT->Hide();
    $winConfig->lblGeoIPDBT->Hide();
    $winConfig->chGeoIPDBAutoUpt->Hide();
    $winConfig->tfGeoIPDB->Hide();
    $winConfig->btnGeoIPDB->Hide();
    $winConfig->btnGeoIPDBUpt->Hide();
    $winConfig->lblXLWHOISDBShadowT->Hide();
    $winConfig->lblXLWHOISDBT->Hide();
    $winConfig->tfXLWHOISDB->Hide();
    $winConfig->btnXLWHOISDB->Hide();
    $winConfig->lblIINDBShadowT->Hide();
    $winConfig->lblIINDBT->Hide();
    $winConfig->tfIINDB->Hide();
    $winConfig->btnIINDB->Hide();
  
  # Show Databases tab
  } elsif ($winConfig->configTab->SelectedItem() == 1) {
    # Databases tab
    $winConfig->lblMACOUIDBShadowT->Show();
    $winConfig->lblMACOUIDBT->Show();
    $winConfig->chMACOUIDBAutoUpt->Show();
    $winConfig->tfMACOUIDB->Show();
    $winConfig->btnMACOUIDB->Show();
    $winConfig->btnMACOUIDBUpt->Show();
    $winConfig->btnMACOUIDBImport->Show();
    $winConfig->lblGeoIPDBShadowT->Show();
    $winConfig->lblGeoIPDBT->Show();
    $winConfig->chGeoIPDBAutoUpt->Show();
    $winConfig->tfGeoIPDB->Show();
    $winConfig->btnGeoIPDB->Show();
    $winConfig->btnGeoIPDBUpt->Show();
    $winConfig->lblXLWHOISDBShadowT->Show();
    $winConfig->lblXLWHOISDBT->Show();
    $winConfig->tfXLWHOISDB->Show();
    $winConfig->btnXLWHOISDB->Show();
    $winConfig->lblIINDBShadowT->Show();
    $winConfig->lblIINDBT->Show();
    $winConfig->tfIINDB->Show();
    $winConfig->btnIINDB->Show();
    
    # General tab
    $winConfig->lblToolShadowT->Hide();
    $winConfig->lblToolT->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->lblOptFunctionsShadowT->Hide();
    $winConfig->lblOptFunctionsT->Hide();
    $winConfig->chFullScreen->Hide();
    $winConfig->chRememberPos->Hide();
    $winConfig->lblMaxSize1->Hide();
    $winConfig->tfMaxSize->Hide();
    $winConfig->lblMaxSize2->Hide();
    $winConfig->lblNsLookupTO1->Hide();
    $winConfig->tfLookupTO->Hide();
    $winConfig->lblNsLookupTO2->Hide();
    $winConfig->lblUserAgent->Hide();
    $winConfig->tfUserAgent->Hide();
    $winConfig->lblNoResultOpt->Hide();
    $winConfig->rbNoResultOpt1->Hide();
    $winConfig->rbNoResultOpt2->Hide();
  }

}  #--- End configTab_Click

#--------------------------#
sub btnCheckUpdate_Click
#--------------------------#
{
  &updateTool(1);

}  #--- End btnCheckUpdate_Click

#--------------------------#
sub updateTool
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent('XL-Tools Update $VERSION');
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    if ($content =~ /([\d\.]+)/i) { $currVer = $1; }
    # No update available
    if ($currVer le $VERSION) {
      if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'update1'}, $STR{'update2'}, 0x40040); } # Up to date
    } else {
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'update4'} $currVer $STR{'update5'} ?", $STR{'update3'}, 0x40024); # Download available
      # Download the update
      if ($answer == 6) {
        # Open Firefox to XL-Tools page
        $win->ShellExecute('open', $URL_TOOL,'','',1) or
          Win32::GUI::MessageBox($winConfig, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} XL-Tools",0x40010);
      }
    }
  }
  # Error 
  else {
    if ($confirm) { Win32::GUI::MessageBox($winConfig, $STR{'errorConnection'}.': '.$res->status_line, "$STR{'update3'} XL-Tools",0x40010); }
  }

}  #--- End updateTool

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'TOOL_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG, ">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub chFullScreen_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chFullScreen->Checked()) {
    $CONFIG{'FULL_SCREEN'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'FULL_SCREEN'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chFullScreen_Click

#--------------------------#
sub chRememberPos_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chRememberPos->Checked()) {
    $CONFIG{'REMEMBER_POS'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'REMEMBER_POS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chRememberPos_Click

#--------------------------#
sub tfMaxSize_Change
#--------------------------#
{
  # Local variables
  my $maxSize = $winConfig->tfMaxSize->Text();
  
  # Remember
  if ($maxSize) {
      $CONFIG{'MAX_SIZE_LIST'} = $maxSize;
      &saveConfig(\%CONFIG);
  }

}  #--- End tfMaxSize_Change

#--------------------------#
sub tfLookupTO_Change
#--------------------------#
{
  # Local variables
  my $lookupTO = $winConfig->tfLookupTO->Text();
  
  # Remember
  if ($lookupTO) {
    $CONFIG{'NSLOOKUP_TIMEOUT'} = $lookupTO;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfLookupTO_Change

#--------------------------#
sub rbNoResultOpt1_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->rbNoResultOpt1->Checked()) {
    $CONFIG{'NO_RESULT_OPT'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'NO_RESULT_OPT'} = 2;
    &saveConfig(\%CONFIG);
  }

}  #--- End rbNoResultOpt1_Click

#--------------------------#
sub rbNoResultOpt2_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->rbNoResultOpt1->Checked()) {
    $CONFIG{'NO_RESULT_OPT'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'NO_RESULT_OPT'} = 2;
    &saveConfig(\%CONFIG);
  }

}  #--- End rbNoResultOpt2_Click

#--------------------------#
sub tfUserAgent_Change
#--------------------------#
{
  # Local variables
  my $userAgent = $winConfig->tfUserAgent->Text();
  
  # Remember
  if ($userAgent) {
    $CONFIG{'USERAGENT'} = $userAgent;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfUserAgent_Change

#--------------------------#
sub chMACOUIDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chMACOUIDBAutoUpt->Checked() == 1) {
    $CONFIG{'MACOUI_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'MACOUI_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chMACOUIDBAutoUpt_Click

#--------------------------#
sub tfMACOUIDB_Change
#--------------------------#
{
  # Local variables
  my $MACOUIDBFile = $winConfig->tfMACOUIDB->Text();
  
  # Remember
  if ($MACOUIDBFile and -f $MACOUIDBFile and &validMACOUIDB($MACOUIDBFile)) {
    $CONFIG{'MACOUI_DB_FILE'} = $MACOUIDBFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'MACOUI_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($MACOUIDBFile) {
      $winConfig->tfMACOUIDB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfMACOUIDB_Change

#--------------------------#
sub validMACOUIDB
#--------------------------#
{
  # Local variables
  my $MACOUIDBFile = shift;
  
  if (-f $MACOUIDBFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$MACOUIDBFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      my $sth;
      eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
      if ($@) { return(0); }
      # If table MACOUI exists, database is valid
      my @info = $sth->fetchrow_array;
      $sth->finish();
      if ($info[2] eq 'MACOUI') { return(1); }
    }
  }
  
  return(0);
  
}  #--- End validMACOUIDB

#--------------------------#
sub btnMACOUIDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfMACOUIDB->Text();
  my $MACOUIDBFile;

  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $MACOUIDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                                -title         => $STR{'selMACOUIFile'}.':' ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -directory     => $lastDir                  ,
                                                -file          => 'OUI.db'                  ,
                                                -explorer      => 1                         , );
  } else {
    $MACOUIDBFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                ,
                                                -title         => $STR{'selMACOUIFile'}.':' ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -file          => 'OUI.db'                  ,
                                                -explorer      => 1                         , );
  }

  # Selected file
  if ($MACOUIDBFile and -f $MACOUIDBFile) { $winConfig->tfMACOUIDB->Text($MACOUIDBFile); }

}  #--- End btnMACOUIDB_Click

#--------------------------#
sub btnMACOUIDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010);
  } else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        # Delete temp files if converting was in progress
        if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
          my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
          unlink($localMACOUIDB.'-journal');
          unlink($localMACOUIDB);
        }
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        # Delete temp files if converting was in progress
        if (-e $winConfig->tfMACOUIDB->Text().'-journal') {
          my $localMACOUIDB = $winConfig->tfMACOUIDB->Text();
          unlink($localMACOUIDB.'-journal');
          unlink($localMACOUIDB);
        }
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      
      &updateMACOUIDB(1);
    });
  }
  return(1);
  
}  #--- End btnMACOUIDBUpt_Click

#--------------------------#
sub btnMACOUIDBImport_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010);
  } else {
    # Local variables
    my $lastDir = $winConfig->tfMACOUIDB->Text();
    my $MACOUIFile;
  
    # Show OpenFile dialog window for the oui.txt file
    if ($lastDir) {
      my(@parts) = split(/\\/, $lastDir);
      if (pop(@parts) =~ /\./) {
        while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
      }
      $MACOUIFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                        ,
                                                -title         => $STR{'selectFile'}.'oui.txt:'     ,
                                                -filter        => [$STR{'text'}.' - .txt', '*.txt'] ,
                                                -filemustexist => 1                                 ,
                                                -directory     => $lastDir                          ,
                                                -explorer      => 1                                 , );
    } else {
      $MACOUIFile = Win32::GUI::GetOpenFileName(-owner         => $winConfig                        ,
                                                -title         => $STR{'selectFile'}.'oui.txt:'     ,
                                                -filter        => [$STR{'text'}.' - .txt', '*.txt'] ,
                                                -filemustexist => 1                                 ,
                                                -explorer      => 1                                 , );
    }
  
    # Selected file
    if ($MACOUIFile and -T $MACOUIFile) {
      # Show SaveFileWindow for database
      my $localMACOUIDB = Win32::GUI::GetSaveFileName(-owner            => $winConfig                      ,
                                                      -title            => $STR{'selPathDB'}.':'           ,
                                                      -file             => 'OUI.db'                        ,
                                                      -filter           => [$STR{'dbFile'}.' - .db', '.db'],
                                                      -overwriteprompt  => 1                               , );
      if ($localMACOUIDB) {
        $THR_UPDATE = threads->create(sub {
          # Thread 'cancellation' signal handler
          $SIG{'KILL'} = sub {
            # Delete temp files
            if (-e $localMACOUIDB.'-journal') { unlink($localMACOUIDB.'-journal'); }
            if (-e $localMACOUIDB)            { unlink($localMACOUIDB);            }
            $winConfig->tfMACOUIDB->Text('');
            delete($CONFIG{'MACOUI_DB_FILE'});
            &saveConfig(\%CONFIG);
            $win->ChangeCursor($ARROW);
            # Turn off progress bar
            $winPb->lblPbCurr->Text('');
            $winPb->lblCount->Text('');
            $winPb->pbWinPb->SetPos(0);
            $winPb->Hide();
            threads->exit();
          };
          
          # Thread 'die' signal handler
          $SIG{__DIE__} = sub {
            # Delete temp files
            if (-e $localMACOUIDB.'-journal') { unlink($localMACOUIDB.'-journal'); }
            if (-e $localMACOUIDB)            { unlink($localMACOUIDB);            }
            $winConfig->tfMACOUIDB->Text('');
            delete($CONFIG{'MACOUI_DB_FILE'});
            &saveConfig(\%CONFIG);
            my $errMsg = (split(/ at /,$_[0]))[0];
            chomp($errMsg);
            $errMsg =~ s/[\t\r\n]/ /g;
            $win->ChangeCursor($ARROW);
            # Turn off progress bar
            $winPb->lblPbCurr->Text('');
            $winPb->lblCount->Text('');
            $winPb->pbWinPb->SetPos(0);
            $winPb->Hide();
            Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
          };
          
          my $return = &importMACOUIDatabase(0, $localMACOUIDB, $MACOUIFile); # $return contains error msg if any
        if ($return) { Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);                     }
        else         { Win32::GUI::MessageBox($win, $STR{'importedOUIDB'}, "XL-Tools $VERSION", 0x40040); }
        });
      }
    }
  }
  return(1);
  
}  #--- End btnMACOUIDBImport_Click

#--------------------------#
sub updateMACOUIDB
#--------------------------#
{
  # This function may be called in 2 ways
  # 1. User click on the update button ($confirm == 1)
  # 2. Auto update at start up: If database is up to date, we don't show message
  
  # Local variables
	my $confirm = shift;
  
  my ($upToDate, $return, $dateLocalFile, $dateRemoteFile) = &checkDateMACOUIDB($confirm);
  # Values for $upToDate
  # 0: MAC OUI Database doesn't exist
  # 1: Database is up to date
  # 2: Database is outdated
  # 3: Error connection
  # 4: Unknown error

  # MAC OUI Database is outdated or doesn't exist
  if (!$upToDate or $upToDate == 2) {
    my $msg;
    if ($dateLocalFile and $dateRemoteFile) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} ieee.org: $dateRemoteFile\n\n$STR{'updateAvailable'} ?";
    } else { $msg = "$STR{'MACOUINotExist'} ?"; }
    
    # Yes (6), No (7)
    my $answer = Win32::GUI::MessageBox($win, $msg, $STR{'uptMACOUI'}, 0x1024);
    
    # Answer is No
    if ($answer == 7) { return(0); }
    
    # Answer is Yes, download the update
    else {
      my $return = &downloadMACOUIDB($winConfig->tfMACOUIDB->Text()); # $return contains error msg if any
      if ($return) { Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);                     }
      else         { Win32::GUI::MessageBox($win, $STR{'updatedMACOUI'}, "XL-Tools $VERSION", 0x40040); }
    }
    
  # MAC OUI is up to date, show message if $confirm == 1
  } elsif ($upToDate == 1) {
    if ($confirm) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      Win32::GUI::MessageBox($win,  "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} ieee.org: ".
                                    "$dateRemoteFile\n\n$STR{'DBUpToDate'} !", $STR{'uptMACOUI'}, 0x40040);
    }
  # Connection error, show message if $confirm == 1
  } elsif (($upToDate == 3 or $upToDate == 4) and $confirm) {
    if ($upToDate == 3) { Win32::GUI::MessageBox($win, "$STR{'errorConnection'}: $return", $STR{'error'}, 0x40010); }
    else                { Win32::GUI::MessageBox($win, "$STR{'unknownError'}: $return", $STR{'error'}   , 0x40010); }
  }

}  #--- End updateMACOUIDB

#--------------------------#
sub checkDateMACOUIDB
#--------------------------#
{
  # Local variables
  my ($confirm)      = @_;
  my $localMACOUIDB  = $winConfig->tfMACOUIDB->Text();
  my $lastModifDate;
  
  # MAC OUI Database doesn't exist or invalid file
  if (!$localMACOUIDB or !-f $localMACOUIDB) { return(0, undef, undef, undef); }
  
  # Check date of local file
  my $dateMACOUIDB    = (stat($localMACOUIDB))[9];
  my ($dl, $ml, $yl)  = (&date($dateMACOUIDB))[3,4,5];
  my $dateLocalFile   = "$yl-$ml-$dl";

  # Check date of the remote file
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req    = new HTTP::Request HEAD => $MACOUIDB_URL;
  my $res    = $ua->request($req);
  my $return = $res->status_line;
  if ($res->code == 200) {
    $lastModifDate = $res->header('last-modified');
    $TOTAL_SIZE    = $res->header('content_length');
  } else { return(3, $return, undef, undef); } # Error connection
  
  # Compare local et remote file date
  if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) { # Parse date
    my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
    my ($yd, $md, $dd)  = split(/-/, $dateUpt);
    if    ($yl  > $yd) { return(1, $return, $dateLocalFile, $dateUpt);   } # MACOUIDB is up to date
    elsif ($yl == $yd) { # Same year
      if ($ml > $md)     { return(1, $return, $dateLocalFile, $dateUpt); } # MACOUIDB is up to date
      elsif ($ml == $md) { # Same month
        if ($dl >= $dd) { return(1, $return, $dateLocalFile, $dateUpt);  } # MACOUIDB is up to date
        else            { return(2, $return, $dateLocalFile, $dateUpt);  } # MACOUIDB is outdated
      } else { return(2, $return, $dateLocalFile, $dateUpt); }             # MACOUIDB is outdated
    } else { return(2, $return, $dateLocalFile, $dateUpt); }               # MACOUIDB is outdated
  } else { return(3, $return, undef, undef); }                  					 # Connection error

}  #--- End checkDateMACOUIDB

#--------------------------#
sub downloadMACOUIDB
#--------------------------#
{
  # Local variables
  my $localMACOUIDB = shift; # Local filepath
  if (!$localMACOUIDB) { $localMACOUIDB = "$PROGDIR\\oui.db"; } # Default location
  
  # Start an agent
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  
  # Set the progress bar
  $win->ChangeCursor($HOURGLASS);
  $winPb->Text($STR{'downloadMACOUI'});
  $winPb->lblPbCurr->Text($STR{'connecting'}.' ieee.org...');
  $winPb->lblCount->Text("0 %");
  $winPb->pbWinPb->SetRange(0, 100);
  $winPb->pbWinPb->SetPos(0);
  $winPb->pbWinPb->SetStep(1);
  $winPb->Center($win);
  $winPb->Show();
  
  # Check size of the remote file
  if (!$TOTAL_SIZE) {
    my $req    = new HTTP::Request HEAD => $MACOUIDB_URL;
    my $res    = $ua->request($req);
    my $return = $res->status_line;
    if ($res->code == 200) { $TOTAL_SIZE = $res->header('content_length'); }
    else {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      $winPb->Hide();
      return("$STR{'errorMsg'}: $STR{'errorConRemote'}...");
    }
  }
  
  # Download the file
  if ($TOTAL_SIZE) {
    my $downloadData;
    
    # Download the file
    $winPb->lblPbCurr->Text("$STR{'downloadMACOUI'}. $STR{'downloadWarning'}...");
    my $response = $ua->get($MACOUIDB_URL, ':content_cb' => sub {
      # Local variables
      my ($data, $response, $protocol) = @_;
      
      $downloadData       .= $data;                                     # Downloaded data
      my $totalDownloaded  = length($downloadData);                     # Size of downloaded data
      my $completed        = int($totalDownloaded / $TOTAL_SIZE * 100); # Pourcentage of download completed
      
      $winPb->pbWinPb->SetPos($completed);    # Set the progress bar
      $winPb->lblCount->Text("$completed %"); # Indicate purcentage
    }, ':read_size_hint' => 32768);
    
    # Save data in a temp file
    my $ouiFileTemp = $localMACOUIDB . '.txt';
    if ($response and $response->is_success) {
      open(OUI_TEMP,">$ouiFileTemp");
      print OUI_TEMP $downloadData;
      close(OUI_TEMP);
    }
    $downloadData = undef;
    
    # Convert the downloaded data into a SQLite database
    if (-T $ouiFileTemp) {
      $TOTAL_SIZE = 0;
      return(&importMACOUIDatabase(1, $localMACOUIDB, $ouiFileTemp));
    }

  } else {
    # Turn off progress bar
    $win->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    return("$STR{'errorMsg'}: $STR{'errorDownload'}...");
  }
  
  $TOTAL_SIZE = 0;
  
}  #--- End downloadMACOUIDB

#--------------------------#
sub importMACOUIDatabase
#--------------------------#
{
  # This function may be called in 2 ways
  # 1. User click on the import button using a local oui.txt
  # 2. Database is downloaded
  
  # Return error or return 0 if successful
  
  # Local variables
  my $winPbStatus   = shift; # If == 1, WinPb is already displayed
  my $localMACOUIDB = shift; # Destination file
  my $ouiFileTemp   = shift; # oui.txt file
  my %oui;
  
  # Show Progress Window
  if (!$winPbStatus) {
    $winPb->Center($win);
    $winPb->Show();
  }
  
  # Set Progress Bar
  $winPb->Text($STR{'convertMACOUI'});
  $winPb->lblPbCurr->Text('');
  $winPb->lblCount->Text('');
  $winPb->pbWinPb->SetPos(0);
  
  # If the database exists, delete it
  if (-e $localMACOUIDB) { unlink($localMACOUIDB); }
  
  # Open the oui file and store prefix and minimal info about organization
  open my $ouiFH, '<', $ouiFileTemp;
  while (<$ouiFH>) {
    if (/((?:[a-fA-F0-9]{2}\-){2}[a-fA-F0-9]{2})\s+\(hex\)\t+([^\n\r]+)(?:$|[\n\r])/) {
      my $prefix = $1;
      my $oui    = $2;
      $prefix =~ s/\-//g;
      $oui{$prefix} = $oui;
    }
  }
  close($ouiFH);
  
  # Create the database and the table
  my $nbrOUI = scalar(keys %oui);
  if ($nbrOUI) {
    $winPb->lblPbCurr->Text($STR{'createDBTable'}.'...');
    my $dsn = "DBI:SQLite:dbname=$localMACOUIDB";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      # Create the table
      my $stmt = qq(CREATE TABLE IF NOT EXISTS MACOUI
                    (prefix VARCHAR(8)    NOT NULL,
                     org    VARCHAR(150)  NOT NULL,
                     PRIMARY KEY(prefix)));
      if (my $rv = $dbh->do($stmt)) {
        # Add data
        my $curr = 0;
        $winPb->lblCount->Text("0 / $nbrOUI");
        $winPb->pbWinPb->SetRange(0, $nbrOUI);
        $winPb->pbWinPb->SetPos(0);
        $winPb->pbWinPb->SetStep(1);
        my $sth = $dbh->prepare("insert into MACOUI (prefix,org) values(?,?)");
        foreach my $prefix (keys %oui) {
          $winPb->lblPbCurr->Text("Insert $prefix...");
          
          my $rv = $sth->execute($prefix, $oui{$prefix});
          #if ($rv < 0) { Win32::GUI::MessageBox($win, "Error adding $1 in the database: $DBI::errstr", $STR{'error'}, 0x40010); }
          
          # Update progress bar
          $curr++;
          $winPb->lblCount->Text("$curr / $nbrOUI");
          $winPb->pbWinPb->StepIt();
        }
      }
      
      $dbh->disconnect();
      
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      $winPb->Hide();
      
      # Final message
      if (&validMACOUIDB($localMACOUIDB)) {
        $winConfig->tfMACOUIDB->Text($localMACOUIDB);
        $CONFIG{'MACOUI_DB_FILE'} = $localMACOUIDB;
        &saveConfig(\%CONFIG);
        $winConfig->tfMACOUIDB->Text($localMACOUIDB);
        return(0);
        #Win32::GUI::MessageBox($win, $STR{'updatedMACOUI'}, "XL-Tools $VERSION", 0x40040);
      } else { return("$STR{'errorMsg'}: $STR{'errorCreatingDB'}..."); }
      
    } else {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      $winPb->Hide();
      return("$STR{'errorMsg'}: $STR{'errorConnectDB'}...");
    }
  } else {
    # Turn off progress bar
    $win->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    return("$STR{'errorMsg'}: $STR{'errorOUI_TXT'}...");
  }

}  #--- End importMACOUIDatabase

#--------------------------#
sub chGeoIPDBAutoUpt_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chGeoIPDBAutoUpt->Checked() == 1) {
    $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'GEOIP_DB_AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chGeoIPDBAutoUpt_Click

#--------------------------#
sub tfGeoIPDB_Change
#--------------------------#
{
  # Local variables
  my $GeoIPDBFile = $winConfig->tfGeoIPDB->Text();
  
  # Remember
  if ($GeoIPDBFile and -f $GeoIPDBFile and &validGeoIPDB($GeoIPDBFile)) {
    $CONFIG{'GEOIP_DB_FILE'} = $GeoIPDBFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'GEOIP_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($GeoIPDBFile) {
      $winConfig->tfGeoIPDB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($winConfig, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfGeoIPDB_Change

#--------------------------#
sub validGeoIPDB
#--------------------------#
{
  # Local variables
  my $GeoIPDBFile = shift;
  
  if (-f $GeoIPDBFile and my $gi = Geo::IP->open($GeoIPDBFile)) {
    if (my $info = $gi->database_info) { return(1); }
  }
  
  return(0);
  
}  #--- End validGeoIPDB

#--------------------------#
sub btnGeoIPDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfGeoIPDB->Text();
  my $GeoIPDBFile;

  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                                -title         => $STR{'selGeoIPFile'}.':'  ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -directory     => $lastDir                  ,
                                                -file          => 'GeoLiteCity.dat'         ,
                                                -explorer      => 1                         , );
  } else {
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                ,
                                                -title         => $STR{'selGeoIPFile'}.':'  ,
                                                -defaultfilter => 0                         ,
                                                -filemustexist => 1                         ,
                                                -file          => 'GeoLiteCity.dat'         ,
                                                -explorer      => 1                         , );
  }

  # Selected file
  if ($GeoIPDBFile and -f $GeoIPDBFile) { $winConfig->tfGeoIPDB->Text($GeoIPDBFile); }

}  #--- End btnGeoIPDB_Click

#--------------------------#
sub btnGeoIPDBUpt_Click
#--------------------------#
{
  if ($THR_UPDATE and $THR_UPDATE->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'processRunning'}, $STR{'error'}, 0x40010);
  } else {
    $THR_UPDATE = threads->create(sub {
      # Thread 'cancellation' signal handler
      $SIG{'KILL'} = sub {
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        threads->exit();
      };
      
      # Thread 'die' signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = (split(/ at /,$_[0]))[0];
        chomp($errMsg);
        $errMsg =~ s/[\t\r\n]/ /g;
        $win->ChangeCursor($ARROW);
        # Turn off progress bar
        $winPb->lblPbCurr->Text('');
        $winPb->lblCount->Text('');
        $winPb->pbWinPb->SetPos(0);
        $winPb->Hide();
        Win32::GUI::MessageBox($win, "$STR{'errorMsg'}: $errMsg", $STR{'error'}, 0x40010);
      };
      
      &updateGeoIPDB(1);
    });
  }
  return(1);
  
}  #--- End btnGeoIPDBUpt_Click

#--------------------------#
sub updateGeoIPDB
#--------------------------#
{
  # This function may be called in 2 ways
  # 1. User click on the update button ($confirm == 1)
  # 2. Auto update at start up: If database is up to date, we don't show message
  
  # Local variables
	my $confirm  = shift;
  
  my ($upToDate, $return, $dateLocalFile, $dateRemoteFile) = &checkDateGeoIPDB($confirm);
  # Values for $upToDate
  # 0: GeoIP Database doesn't exist  
  # 1: Database is up to date
  # 2: Database is outdated
  # 3: Error connection
  # 4: Unknown error

  # GeoIP Database is outdated or doesn't exist
  if (!$upToDate or $upToDate == 2) {
    my $msg;
    if ($dateLocalFile and $dateRemoteFile) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      $msg = "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} Maxmind: $dateRemoteFile\n\n$STR{'updateAvailable'} ?";
    } else { $msg = "The GeoIP database (GeoLiteCity.dat) does not exist, download ?"; }
    
    # Yes (6), No (7)
    my $answer = Win32::GUI::MessageBox($win, $msg, $STR{'uptGeoIP'}, 0x1024);
    
    # Answer is No
    if ($answer == 7) { return(0); }
    
    # Answer is Yes, download the update
    else {
      my $return = &downloadGeoIPDB($winConfig->tfGeoIPDB->Text()); # $return contains error msg if any
      if ($return) { Win32::GUI::MessageBox($win, $return, $STR{'error'}, 0x40010);                    }
      else         { Win32::GUI::MessageBox($win, $STR{'updatedGeoIP'}, "XL-Tools $VERSION", 0x40040); }
    }
    
  # GeoIP is up to date, show message if $confirm == 1
  } elsif ($upToDate == 1) {
    if ($confirm) {
      Encode::from_to($dateRemoteFile, 'utf8', 'iso-8859-1');
      Win32::GUI::MessageBox($win,  "$STR{'currDBDate'}: $dateLocalFile\n$STR{'remoteDBDate'} Maxmind: ".
                                    "$dateRemoteFile\n\n$STR{'DBUpToDate'} !", $STR{'uptGeoIP'}, 0x40040);
    }
  # Connection error, show message if $confirm == 1
  } elsif (($upToDate == 3 or $upToDate == 4) and $confirm) {
    if ($upToDate == 3) { Win32::GUI::MessageBox($win, "$STR{'errorConnection'}: $return", $STR{'error'}, 0x40010); }
    else                { Win32::GUI::MessageBox($win, "$STR{'unknownError'}: $return", $STR{'error'}   , 0x40010); }
  }

}  #--- End updateGeoIPDB

#--------------------------#
sub checkDateGeoIPDB
#--------------------------#
{
  # Local variables
  my ($confirm)      = @_;
  my $localGeoIPDB   = $winConfig->tfGeoIPDB->Text();
  my $lastModifDate;
  
  # MAC OUI Database doesn't exist or invalid file
  if (!$localGeoIPDB or !-f $localGeoIPDB) { return(0, undef, undef, undef); }
  
  # Check date of local file
  my $dateGeoIPDB     = (stat($localGeoIPDB))[9];
  my ($dl, $ml, $yl)  = (&date($dateGeoIPDB))[3,4,5];
  my $dateLocalFile   = "$yl-$ml-$dl";

  # Check date of the remote file
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  my $req    = new HTTP::Request HEAD => $GEOIPDB_URL;
  my $res    = $ua->request($req);
  my $return = $res->status_line;
  if ($res->code == 200) {
    $lastModifDate = $res->header('last-modified');
    $TOTAL_SIZE    = $res->header('content_length');
  } else { return(3, $return, undef, undef); } # Error connection
  
  # Compare local et remote file date
  if ($lastModifDate and my ($y, $m, $d) = parse_date($lastModifDate)) { # Parse date
    my $dateUpt = sprintf("%4d-%02d-%02d", $y, $m, $d);
    my ($yd, $md, $dd)  = split(/-/, $dateUpt);
    if    ($yl  > $yd) { return(1, $return, $dateLocalFile, $dateUpt);   } # GeoIPDB is up to date
    elsif ($yl == $yd) { # Same year
      if ($ml > $md)     { return(1, $return, $dateLocalFile, $dateUpt); } # GeoIPDB is up to date
      elsif ($ml == $md) { # Same month
        if ($dl >= $dd) { return(1, $return, $dateLocalFile, $dateUpt);  } # GeoIPDB is up to date
        else            { return(2, $return, $dateLocalFile, $dateUpt);  } # GeoIPDB is outdated
      } else { return(2, $return, $dateLocalFile, $dateUpt); }             # GeoIPDB is outdated
    } else { return(2, $return, $dateLocalFile, $dateUpt); }               # GeoIPDB is outdated
  } else { return(3, $return, undef, undef); }                  					 # Connection error

}  #--- End checkDateGeoIPDB

#--------------------------#
sub downloadGeoIPDB
#--------------------------#
{
  # Local variables
  my $localGeoIPDB = shift; # Local filepath
  if (!$localGeoIPDB) { $localGeoIPDB = "$PROGDIR\\GeoLiteCity.dat"; } # Default location
  
  # Start an agent
  my $ua = new LWP::UserAgent;
  $ua->agent($CONFIG{'USERAGENT'});
  $ua->default_header('Accept-Language' => 'en');
  
  # Set the progress bar
  $win->ChangeCursor($HOURGLASS);
  $winPb->Text($STR{'downloadGeoIP'});
  $winPb->lblPbCurr->Text($STR{'connecting'}.' Maxmind...');
  $winPb->lblCount->Text("0 %");
  $winPb->pbWinPb->SetRange(0, 100);
  $winPb->pbWinPb->SetPos(0);
  $winPb->pbWinPb->SetStep(1);
  $winPb->Center($win);
  $winPb->Show();
  
  # Check size of the remote file
  if (!$TOTAL_SIZE) {
    my $req    = new HTTP::Request HEAD => $GEOIPDB_URL;
    my $res    = $ua->request($req);
    my $return = $res->status_line;
    if ($res->code == 200) { $TOTAL_SIZE = $res->header('content_length'); }
    else {
      # Turn off progress bar
      $win->ChangeCursor($ARROW);
      $winPb->lblPbCurr->Text('');
      $winPb->lblCount->Text('');
      $winPb->pbWinPb->SetPos(0);
      $winPb->Hide();
      return("$STR{'errorMsg'}: $STR{'errorConRemote'}...");
    }
  }
  
  # Download the file
  if ($TOTAL_SIZE) {
    my $downloadData;
    # Download the file
    $winPb->lblPbCurr->Text($STR{'downloadGeoIP'}.'...');
    my $response = $ua->get($GEOIPDB_URL, ':content_cb' => sub {
      # Local variables
      my ($data, $response, $protocol) = @_;
      
      $downloadData       .= $data;                                     # Downloaded data
      my $totalDownloaded  = length($downloadData);                     # Size of downloaded data
      my $completed        = int($totalDownloaded / $TOTAL_SIZE * 100); # Pourcentage of download completed
      
      $winPb->pbWinPb->SetPos($completed);    # Set the progress bar
      $winPb->lblCount->Text("$completed %"); # Indicate purcentage
    }, ':read_size_hint' => 32768);
    
    # Save data in a temp file
    my $GeoIPGZIP = $localGeoIPDB . '.gz';
    if ($response and $response->is_success) {
      open(GEOIPGZ,">$GeoIPGZIP");
      binmode(GEOIPGZ);
      print GEOIPGZ $downloadData;
      close(GEOIPGZ);
    }
    $downloadData = undef;
    
    # Uncompress GEOIP GZIP
    my ($error, $msg);
    if (-e $GeoIPGZIP) {
      $TOTAL_SIZE = 0;
      if (gunzip $GeoIPGZIP => $localGeoIPDB, BinModeOut => 1) {
        unlink $GeoIPGZIP;
        $winConfig->tfGeoIPDB->Text($localGeoIPDB);
        # ToAdd: Valid GeoIP Database
      } else { $error = 1; $msg = "$STR{'errorMsg'}: $GunzipError"; }
    } else { $error = 1; $msg = $STR{'errorDownload'}.'...'; }
    
    # Turn off progress bar
    $win->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    
    # Final message
    if ($error) { return($msg); } # Error
    else {
      # Update Config
      $winConfig->tfGeoIPDB->Text($localGeoIPDB);
      $CONFIG{'GEOIP_DB_FILE'} = $localGeoIPDB;
      &saveConfig(\%CONFIG);
      return(0);
    }

  } else {
    # Turn off progress bar
    $win->ChangeCursor($ARROW);
    $winPb->lblPbCurr->Text('');
    $winPb->lblCount->Text('');
    $winPb->pbWinPb->SetPos(0);
    $winPb->Hide();
    return("$STR{'errorMsg'}: $STR{'errorDownload'}...");
  }
  
  $TOTAL_SIZE = 0;
  
}  #--- End downloadGeoIPDB

#--------------------------#
sub tfXLWHOISDB_Change
#--------------------------#
{
  # Local variables
  my $XLWHOISDBFile = $winConfig->tfXLWHOISDB->Text();
  
  # Remember
  if ($XLWHOISDBFile and -f $XLWHOISDBFile and &validXLWHOISDB($XLWHOISDBFile)) {
    $CONFIG{'XLWHOIS_DB_FILE'} = $XLWHOISDBFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'XLWHOIS_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($XLWHOISDBFile) {
      $winConfig->tfXLWHOISDB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfXLWHOISDB_Change

#--------------------------#
sub validXLWHOISDB
#--------------------------#
{
  # Local variables
  my $XLWHOISDBFile = shift;
  
  if (-f $XLWHOISDBFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$XLWHOISDBFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      my $sth;
      eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
      if ($@) { return(0); }
      # If table WHOIS_DB exists, database is valid
      my @info = $sth->fetchrow_array;
      $sth->finish();
      if ($info[2] eq 'WHOIS_DB') { return(1); }
    }
  }
  
  return(0);
  
}  #--- End validXLWHOISDB

#--------------------------#
sub btnXLWHOISDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfXLWHOISDB->Text();
  my $XLWHOISDBFile;

  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $XLWHOISDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                  -title         => $STR{'selectDBFile'}.':'   ,
                                                  -defaultfilter => 0                          ,
                                                  -filemustexist => 1                          ,
                                                  -directory     => $lastDir                   ,
                                                  -file          => 'Whois.db'                 ,
                                                  -explorer      => 1                          , );
  } else {
    $XLWHOISDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                                  -title         => $STR{'selectDBFile'}.':'   ,
                                                  -defaultfilter => 0                          ,
                                                  -filemustexist => 1                          ,
                                                  -file          => 'Whois.db'                 ,
                                                  -explorer      => 1                          , );
  }

  # Selected file
  if ($XLWHOISDBFile and -f $XLWHOISDBFile) { $winConfig->tfXLWHOISDB->Text($XLWHOISDBFile); }

}  #--- End btnXLWHOISDB_Click

#--------------------------#
sub checkIP_WhoisDB_IPv4
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  my $ipInt = unpack 'N', pack 'C4', split '\.', $ip;
  my $isp;
  my $country;
  my $date;
  my $interMin = 4294967295;
  
  # Check if IP address fit any range in database
  my $sth = $$refDbh->prepare("SELECT range_s,range_e,isp,country,date from WHOIS_DB
                              WHERE $ipInt >= range_s AND $ipInt <= range_e");
  my $rv  = $sth->execute();
  if ($rv < 0) { Win32::GUI::MessageBox($win, $STR{'errDB'}.$DBI::errstr, $STR{'error'}, 0x40010); }
  
  # Select the best answer (smaller range)
  my $refAllRows = $sth->fetchall_arrayref();
  foreach my $refRow (@{$refAllRows}) {
    my $inter = $$refRow[1] - $$refRow[0];
    if ($inter < $interMin) {
      $interMin = $inter;
      $isp     = $$refRow[2];
      $country = $$refRow[3];
    }
  }
  
  if ($isp and $country) { return("$isp, $country"); }
  else                   { return(undef);            }

}  #--- End checkIP_WhoisDB_IPv4

#--------------------------#
sub checkIP_WhoisDB_IPv6
#--------------------------#
{
  # Local variables
  my ($ip, $refDbh) = @_;
  
  # Check if IP address fit any range in database
  my $all = $$refDbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6");
  foreach my $row (@$all) {
    my $cidr = @$row[0];
    if (Net::CIDR::cidrlookup($ip, ($cidr))) {
      return("@$row[1], @$row[2]");
    }
  }

}  #--- End checkIP_WhoisDB_IPv6

#--------------------------#
sub tfIINDB_Change
#--------------------------#
{
  # Local variables
  my $IINDBFile = $winConfig->tfIINDB->Text();
  
  # Remember
  if ($IINDBFile and -f $IINDBFile and &validIINDB($IINDBFile)) {
    $CONFIG{'IIN_DB_FILE'} = $IINDBFile;
    &saveConfig(\%CONFIG);
  } else {
    delete($CONFIG{'IIN_DB_FILE'});
    &saveConfig(\%CONFIG);
    if ($IINDBFile) {
      $winConfig->tfIINDB->Text('');
      if ($START == 1) { Win32::GUI::MessageBox($win, $STR{'invalidFile'}, $STR{'error'}, 0x40010); }
    }
  }

}  #--- End tfIINDB_Change

#--------------------------#
sub validIINDB
#--------------------------#
{
  # Local variables
  my $IINDBFile = shift;
  
  if (-f $IINDBFile) {
    # Connect to DB
    my $dsn = "DBI:SQLite:dbname=$IINDBFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 })) {
      my $sth;
      eval { $sth = $dbh->table_info(undef, undef, '%', 'TABLE'); };
      if ($@) { return(0); }
      # If table IIN exists, database is valid
      my @info = $sth->fetchrow_array;
      $sth->finish();
      if ($info[2] eq 'IIN') { return(1); }
    }
  }
  
  return(0);
  
}  #--- End validIINDB

#--------------------------#
sub btnIINDB_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winConfig->tfIINDB->Text();
  my $IINDBFile;

  # Show OpenFile dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $IINDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -directory     => $lastDir                   ,
                                              -file          => 'IIN.db'                   ,
                                              -explorer      => 1                          , );
  } else {
    $IINDBFile = Win32::GUI::GetOpenFileName( -owner         => $winConfig                 ,
                                              -title         => $STR{'selectDBFile'}.':'   ,
                                              -defaultfilter => 0                          ,
                                              -filemustexist => 1                          ,
                                              -file          => 'IIN.db'                   ,
                                              -explorer      => 1                          , );
  }

  # Selected file
  if ($IINDBFile and -f $IINDBFile) { $winConfig->tfIINDB->Text($IINDBFile); }

}  #--- End btnIINDB_Click

#--------------------------#
sub date
#--------------------------#
{
  # Local variables
  my ($time) = @_;
  
  # Conversion
  if (!$time or $time == 0) { $time = time; }
  my ($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST) = localtime($time);

  # Format
  $y += 1900;
  $m++;
  $m   = $m   < 10 ? $m   = "0".$m   : $m;
  $d   = $d   < 10 ? $d   = "0".$d   : $d;
  $h   = $h   < 10 ? $h   = "0".$h   : $h;
  $min = $min < 10 ? $min = "0".$min : $min;
  $s   = $s   < 10 ? $s   = "0".$s   : $s;
  
  return($s,$min,$h,$d,$m,$y,$d_w,$ha,$isDST);

}  #--- End date

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Open and load config values
  open(CONFIG, $CONFIG_FILE);
  my @tab = <CONFIG>;
  close(CONFIG);
  
  foreach (@tab) {
    chomp($_);
    my ($key, $value) = split(/ = /, $_);
    if ($key) { $$refConfig{$key}  = $value; }
  }

  # General tab
  if (exists($$refConfig{'TOOL_AUTO_UPDATE'}))      { $winConfig->chAutoUpdate->Checked($$refConfig{'TOOL_AUTO_UPDATE'});           }
  else                                              { $winConfig->chAutoUpdate->Checked(1);                                         } # Default checked
  
  # Function options
  if (exists($$refConfig{'FULL_SCREEN'}))           { $winConfig->chFullScreen->Checked($$refConfig{'FULL_SCREEN'});                }
  else                                              { $winConfig->chFullScreen->Checked(0);                                         } # Default is not checked
  if (exists($$refConfig{'REMEMBER_POS'}))          { $winConfig->chRememberPos->Checked($$refConfig{'REMEMBER_POS'});              }
  else                                              { $winConfig->chRememberPos->Checked(0);                                        } # Default is not checked
  if (exists($$refConfig{'MAX_SIZE_LIST'}))         { $winConfig->tfMaxSize->Text($$refConfig{'MAX_SIZE_LIST'});                    }
  else                                              { $winConfig->tfMaxSize->Text(5000000); $$refConfig{'MAX_SIZE_LIST'} = 5000000; } # Default is 5 000 000 chars
  $win->tfList1->MaxLength($$refConfig{'MAX_SIZE_LIST'});
  $win->tfList2->MaxLength($$refConfig{'MAX_SIZE_LIST'});
  $win->tfList3->MaxLength($$refConfig{'MAX_SIZE_LIST'});
  if (exists($$refConfig{'NSLOOKUP_TIMEOUT'}))      { $winConfig->tfLookupTO->Text($$refConfig{'NSLOOKUP_TIMEOUT'});                }
  else                                              { $winConfig->tfLookupTO->Text(10); $$refConfig{'NSLOOKUP_TIMEOUT'} = 10;       } # Default is 10 seconds
  if (exists($$refConfig{'USERAGENT'}))             { $winConfig->tfUserAgent->Text($$refConfig{'USERAGENT'});                      }
  else                                              { $winConfig->tfUserAgent->Text('XL-Tools (http://www.le-tools.com)');
                                                     $$refConfig{'USERAGENT'} = 'XL-Tools (http://www.le-tools.com)';               } # Use Default
  if (exists($$refConfig{'NO_RESULT_OPT'}))         {
    if ($$refConfig{'NO_RESULT_OPT'} == 1)          { $winConfig->rbNoResultOpt1->Checked(1); $winConfig->rbNoResultOpt2->Checked(0); }
    else                                            { $winConfig->rbNoResultOpt2->Checked(1); $winConfig->rbNoResultOpt1->Checked(0); }
  } else                                            { $winConfig->rbNoResultOpt1->Checked(1);                                      } # Default is Opt1 : Leave a blank
  
  # MACOUIDB Database location
  if (exists($$refConfig{'MACOUI_DB_AUTO_UPDATE'})) { $winConfig->chMACOUIDBAutoUpt->Checked($$refConfig{'MACOUI_DB_AUTO_UPDATE'}); }
  else                                              { $winConfig->chMACOUIDBAutoUpt->Checked(0);                                    } # Default is not checked
  if (exists($$refConfig{'MACOUI_DB_FILE'}) and
      -f $$refConfig{'MACOUI_DB_FILE'})             { $winConfig->tfMACOUIDB->Text($$refConfig{'MACOUI_DB_FILE'});                  }
  
  # GeoIPDB Database location
  if (exists($$refConfig{'GEOIP_DB_AUTO_UPDATE'}))  { $winConfig->chGeoIPDBAutoUpt->Checked($$refConfig{'GEOIP_DB_AUTO_UPDATE'});   }
  else                                              { $winConfig->chGeoIPDBAutoUpt->Checked(1);                                     } # Default is checked
  if (exists($$refConfig{'GEOIP_DB_FILE'}) and
      -f $$refConfig{'GEOIP_DB_FILE'})              { $winConfig->tfGeoIPDB->Text($$refConfig{'GEOIP_DB_FILE'});                    }
  
  # XL-Whois Database location
  if (exists($$refConfig{'XLWHOIS_DB_FILE'}) and
      -f $$refConfig{'XLWHOIS_DB_FILE'})            { $winConfig->tfXLWHOISDB->Text($$refConfig{'XLWHOIS_DB_FILE'});                }
  
  # IIN Database location
  if (exists($$refConfig{'IIN_DB_FILE'}) and
      -f $$refConfig{'IIN_DB_FILE'})                { $winConfig->tfIINDB->Text($$refConfig{'IIN_DB_FILE'});                        }
  
  # Custom Functions
  my $j = 1;
  while (exists($CONFIG{'CF'.$j})) {
    my ($title, $dbFile) = split(/\|/, $CONFIG{'CF'.$j});
    $win->cbCFLists->Add($title);
    $j++;
  }

}  #--- End loadConfig